<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Qu·∫£n L√Ω Trung T√¢m - V4.0</title>
    
    <!-- ========== TH∆Ø VI·ªÜN B√äN NGO√ÄI ========== -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
/* ============================================================
   üé® PH·∫¶N 1: CSS VARIABLES (Bi·∫øn m√†u s·∫Øc)
   ============================================================ */
:root {
    /* M√†u ch√≠nh - Xanh d∆∞∆°ng nh·∫π (t√¥ng gi√°o d·ª•c) */
    --primary-color: #4A90A4;
    --primary-dark: #357A8C;
    --primary-light: #6BA3B5;
    --primary-lighter: #E8F4F8;
    
    /* Gradient ch√≠nh */
    --primary-gradient: linear-gradient(135deg, #4A90A4 0%, #5BA0B5 50%, #6BB0C5 100%);
    --sidebar-gradient: linear-gradient(180deg, #2C3E50 0%, #34495E 100%);
    
    /* M√†u n·ªÅn */
    --bg-main: #F5F7FA;
    --bg-white: #FFFFFF;
    --bg-light: #F8FAFB;
    --bg-dark: #006399;
    
    /* M√†u ch·ªØ */
    --text-primary: #2C3E50;
    --text-secondary: #5D6D7E;
    --text-muted: #95A5A6;
    --text-white: #FFFFFF;
    
    /* M√†u tr·∫°ng th√°i */
    --status-hoc-thu: #3498DB;
    --status-cho-dk: #F39C12;
    --status-da-dk: #27AE60;
    --status-hoan-thanh: #9B59B6;
    --status-cancel: #E74C3C;
    
    /* M√†u button */
    --btn-success: #27AE60;
    --btn-info: #3498DB;
    --btn-warning: #F39C12;
    --btn-danger: #E74C3C;
    --btn-secondary: #95A5A6;
    
    /* Border & Shadow */
    --border-color: #E1E8ED;
    --border-radius: 8px;
    --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
    --shadow-lg: 0 8px 24px rgba(0,0,0,0.15);
    
    /* K√≠ch th∆∞·ªõc */
    --sidebar-width: 260px;
    --sidebar-collapsed-width: 70px;
    --header-height: 60px;
}

/* ============================================================
   üîß PH·∫¶N 2: CSS RESET & BASE
   ============================================================ */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-size: 14px;
    color: var(--text-primary);
    background: var(--bg-main);
    line-height: 1.5;
    overflow-x: hidden;
}

/* ============================================================
   üîê PH·∫¶N 3: LOGIN SCREEN
   ============================================================ */
.login-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #4A90A4 0%, #2C3E50 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}

.login-screen.hidden {
    display: none;
}

.login-container {
    background: var(--bg-white);
    padding: 40px;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    width: 100%;
    max-width: 420px;
    animation: loginSlideIn 0.5s ease;
}

@keyframes loginSlideIn {
    from {
        opacity: 0;
        transform: translateY(-30px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.login-logo {
    text-align: center;
    margin-bottom: 30px;
}

.login-logo .logo-icon {
    width: 80px;
    height: 80px;
    background: var(--primary-gradient);
    border-radius: 20px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 40px;
    margin-bottom: 15px;
    box-shadow: var(--shadow-md);
}

.login-logo h1 {
    color: var(--text-primary);
    font-size: 22px;
    font-weight: 700;
    margin-bottom: 5px;
}

.login-logo p {
    color: var(--text-muted);
    font-size: 14px;
}

.login-form .form-group {
    margin-bottom: 20px;
    position: relative;
}

.login-form .form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 13px;
}

.login-form .input-wrapper {
    position: relative;
}

.login-form .input-wrapper .input-icon {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 16px;
    color: var(--text-muted);
}

.login-form .form-group input {
    width: 100%;
    padding: 14px 15px 14px 45px;
    border: 2px solid var(--border-color);
    border-radius: 10px;
    font-size: 15px;
    transition: all 0.3s;
}

.login-form .form-group input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 4px rgba(74, 144, 164, 0.1);
}

.login-form .form-group input.error {
    border-color: var(--btn-danger);
}

.login-form .form-options {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
}

.login-form .remember-me {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    font-size: 14px;
    color: var(--text-secondary);
}

.login-form .remember-me input {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.login-form .btn-login {
    width: 100%;
    padding: 14px;
    background: var(--primary-gradient);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.login-form .btn-login:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(74, 144, 164, 0.4);
}

.login-form .btn-login:active {
    transform: translateY(0);
}

.login-form .btn-login:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
}

.login-error {
    background: #FDEDEC;
    color: var(--btn-danger);
    padding: 12px 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    font-size: 14px;
    display: none;
    align-items: center;
    gap: 10px;
}

.login-error.show {
    display: flex;
}

.login-footer {
    text-align: center;
    margin-top: 25px;
    padding-top: 20px;
    border-top: 1px solid var(--border-color);
}

.login-footer p {
    color: var(--text-muted);
    font-size: 13px;
}

/* Password toggle */
.password-toggle {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    cursor: pointer;
    font-size: 16px;
    color: var(--text-muted);
    padding: 5px;
}

.password-toggle:hover {
    color: var(--primary-color);
}

/* ============================================================
   üìê PH·∫¶N 4: APP LAYOUT (Sidebar, Header, Content)
   ============================================================ */
.app-container {
    display: none;
    min-height: 100vh;
}

.app-container.show {
    display: flex;
}

/* ----- Sidebar ----- */
.sidebar {
    width: var(--sidebar-width);
    background: var(--sidebar-gradient);
    position: fixed;
    top: 0;
    left: 0;
    height: 100vh;
    z-index: 1000;
    transition: width 0.3s ease;
    display: flex;
    flex-direction: column;
    box-shadow: var(--shadow-lg);
}

.sidebar.collapsed {
    width: var(--sidebar-collapsed-width);
}

.sidebar-logo {
    height: var(--header-height);
    display: flex;
    align-items: center;
    padding: 0 15px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    gap: 12px;
}

.sidebar-logo .logo-icon {
    width: 40px;
    height: 40px;
    background: var(--primary-gradient);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    flex-shrink: 0;
}

.sidebar-logo .logo-text {
    color: var(--text-white);
    font-size: 16px;
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    transition: opacity 0.3s;
}

.sidebar.collapsed .logo-text {
    opacity: 0;
    width: 0;
}

/* Navigation */
.sidebar-nav {
    flex: 1;
    overflow-y: auto;
    padding: 15px 0;
}

.sidebar-nav::-webkit-scrollbar {
    width: 5px;
}

.sidebar-nav::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,0.2);
    border-radius: 3px;
}

.nav-item {
    margin: 2px 10px;
}

.nav-link {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    color: rgba(255,255,255,0.8);
    text-decoration: none;
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: all 0.2s;
    gap: 12px;
}

.nav-link:hover {
    background: rgba(255,255,255,0.1);
    color: var(--text-white);
}

.nav-link.active {
    background: var(--primary-color);
    color: var(--text-white);
    box-shadow: var(--shadow-sm);
}

.nav-link .nav-icon {
    width: 22px;
    text-align: center;
    font-size: 16px;
    flex-shrink: 0;
}

.nav-link .nav-text {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    transition: opacity 0.3s;
}

.sidebar.collapsed .nav-text {
    opacity: 0;
    width: 0;
}

.nav-link .nav-arrow {
    font-size: 12px;
    transition: transform 0.3s;
}

.nav-link.expanded .nav-arrow {
    transform: rotate(90deg);
}

.sidebar.collapsed .nav-arrow {
    display: none;
}

/* Submenu */
.nav-submenu {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
    background: rgba(0,0,0,0.15);
    border-radius: var(--border-radius);
    margin-top: 2px;
}

.nav-submenu.open {
    max-height: 500px;
}

.sidebar.collapsed .nav-submenu {
    display: none;
}

.nav-submenu .nav-link {
    padding: 10px 15px 10px 49px;
    font-size: 13px;
}

.nav-submenu .nav-link::before {
    content: '';
    width: 6px;
    height: 6px;
    background: rgba(255,255,255,0.4);
    border-radius: 50%;
    margin-right: 10px;
}

.nav-submenu .nav-link.active::before,
.nav-submenu .nav-link:hover::before {
    background: var(--text-white);
}

/* Sidebar Footer */
.sidebar-footer {
    padding: 15px;
    border-top: 1px solid rgba(255,255,255,0.1);
}

.sidebar-footer .version {
    color: rgba(255,255,255,0.5);
    font-size: 12px;
    text-align: center;
}

.sidebar.collapsed .sidebar-footer .version {
    display: none;
}

/* ----- Main Wrapper ----- */
.main-wrapper {
    flex: 1;
    margin-left: var(--sidebar-width);
    transition: margin-left 0.3s ease;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
}

.sidebar.collapsed ~ .main-wrapper {
    margin-left: var(--sidebar-collapsed-width);
}

/* ----- Header ----- */
.main-header {
    height: var(--header-height);
    background: var(--bg-white);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 25px;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: var(--shadow-sm);
}

.header-left {
    display: flex;
    align-items: center;
    gap: 15px;
}

.toggle-sidebar-btn {
    width: 40px;
    height: 40px;
    border: none;
    background: var(--bg-light);
    border-radius: var(--border-radius);
    cursor: pointer;
    font-size: 18px;
    color: var(--text-secondary);
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.toggle-sidebar-btn:hover {
    background: var(--primary-lighter);
    color: var(--primary-color);
}

.page-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-primary);
}

.header-right {
    display: flex;
    align-items: center;
    gap: 15px;
}

.header-btn {
    width: 40px;
    height: 40px;
    border: none;
    background: var(--bg-light);
    border-radius: var(--border-radius);
    cursor: pointer;
    font-size: 16px;
    color: var(--text-secondary);
    transition: all 0.2s;
    position: relative;
}

.header-btn:hover {
    background: var(--primary-lighter);
    color: var(--primary-color);
}

.header-btn .badge {
    position: absolute;
    top: 5px;
    right: 5px;
    width: 18px;
    height: 18px;
    background: var(--btn-danger);
    color: white;
    border-radius: 50%;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* User Dropdown */
.user-dropdown {
    position: relative;
}

.user-info {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 5px 12px;
    background: var(--bg-light);
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.2s;
}

.user-info:hover {
    background: var(--primary-lighter);
}

.user-avatar {
    width: 32px;
    height: 32px;
    background: var(--primary-gradient);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 14px;
    font-weight: 600;
}

.user-name {
    font-size: 14px;
    font-weight: 500;
    color: var(--text-primary);
}

.user-role {
    font-size: 11px;
    color: var(--text-muted);
    background: var(--bg-main);
    padding: 2px 8px;
    border-radius: 10px;
}

.user-menu {
    position: absolute;
    top: calc(100% + 10px);
    right: 0;
    background: var(--bg-white);
    border-radius: 12px;
    box-shadow: var(--shadow-lg);
    min-width: 200px;
    padding: 8px 0;
    display: none;
    z-index: 1000;
    border: 1px solid var(--border-color);
}

.user-menu.show {
    display: block;
    animation: fadeIn 0.2s ease;
}

.user-menu-header {
    padding: 12px 15px;
    border-bottom: 1px solid var(--border-color);
    margin-bottom: 8px;
}

.user-menu-header .name {
    font-weight: 600;
    color: var(--text-primary);
}

.user-menu-header .email {
    font-size: 12px;
    color: var(--text-muted);
}

.user-menu-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 15px;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s;
    font-size: 14px;
}

.user-menu-item:hover {
    background: var(--bg-light);
    color: var(--primary-color);
}

.user-menu-item.danger {
    color: var(--btn-danger);
}

.user-menu-item.danger:hover {
    background: #FDEDEC;
}

.user-menu-divider {
    height: 1px;
    background: var(--border-color);
    margin: 8px 0;
}

/* ----- Main Content ----- */
.main-content {
    flex: 1;
    padding: 25px;
    background: var(--bg-main);
}

/* ============================================================
   üì¶ PH·∫¶N 5: COMPONENTS (Cards, Tables, Buttons, Forms...)
   ============================================================ */

/* ----- Page Header ----- */
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    flex-wrap: wrap;
    gap: 15px;
}

.page-header h2 {
    font-size: 24px;
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 10px;
}

.page-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

/* ----- Stats Cards ----- */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
}

.stat-card {
    background: var(--bg-white);
    padding: 20px;
    border-radius: 12px;
    box-shadow: var(--shadow-sm);
    display: flex;
    align-items: center;
    gap: 15px;
    transition: all 0.3s;
    border: 1px solid var(--border-color);
}

.stat-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-md);
}

.stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
}

.stat-icon.blue { background: linear-gradient(135deg, #3498DB 0%, #5DADE2 100%); }
.stat-icon.orange { background: linear-gradient(135deg, #F39C12 0%, #F5B041 100%); }
.stat-icon.green { background: linear-gradient(135deg, #27AE60 0%, #52D681 100%); }
.stat-icon.purple { background: linear-gradient(135deg, #9B59B6 0%, #BB8FCE 100%); }
.stat-icon.red { background: linear-gradient(135deg, #E74C3C 0%, #EC7063 100%); }
.stat-icon.teal { background: linear-gradient(135deg, #4A90A4 0%, #6BB0C5 100%); }

.stat-info h3 {
    font-size: 24px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 3px;
}

.stat-info p {
    font-size: 13px;
    color: var(--text-muted);
}

/* ----- Cards ----- */
.card {
    background: var(--bg-white);
    border-radius: 12px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
    margin-bottom: 20px;
}

.card-header {
    padding: 18px 20px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.card-header h3 {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 8px;
}

.card-body {
    padding: 20px;
}

/* ----- Tables ----- */
.table-container {
    overflow-x: auto;
    background: var(--bg-white);
    border-radius: 12px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
}

table {
    width: 100%;
    border-collapse: collapse;
}

thead {
    background: var(--primary-gradient);
    color: white;
}

th {
    padding: 14px 16px;
    text-align: left;
    font-weight: 600;
    font-size: 13px;
    white-space: nowrap;
}

td {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border-color);
    font-size: 14px;
}

tbody tr:hover {
    background: var(--primary-lighter);
}

tbody tr:last-child td {
    border-bottom: none;
}

/* ----- Buttons ----- */
.btn {
    padding: 10px 18px;
    border: none;
    border-radius: var(--border-radius);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
}

.btn-primary {
    background: var(--primary-gradient);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(74, 144, 164, 0.4);
}

.btn-success { background: var(--btn-success); color: white; }
.btn-success:hover { background: #219A52; }

.btn-info { background: var(--btn-info); color: white; }
.btn-info:hover { background: #2980B9; }

.btn-warning { background: var(--btn-warning); color: white; }
.btn-warning:hover { background: #D68910; }

.btn-danger { background: var(--btn-danger); color: white; }
.btn-danger:hover { background: #C0392B; }

.btn-secondary { background: var(--btn-secondary); color: white; }
.btn-secondary:hover { background: #7F8C8D; }

.btn-outline {
    background: transparent;
    border: 2px solid var(--primary-color);
    color: var(--primary-color);
}

.btn-outline:hover {
    background: var(--primary-color);
    color: white;
}

.btn-sm {
    padding: 6px 12px;
    font-size: 13px;
}

.btn-icon {
    width: 32px;
    height: 32px;
    padding: 0;
    justify-content: center;
}

/* ----- Action Buttons ----- */
.action-buttons {
    display: flex;
    gap: 5px;
}

.action-btn {
    width: 30px;
    height: 30px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.action-btn:hover { transform: scale(1.1); }

.action-btn.view { background: #E8F4FD; color: #3498DB; }
.action-btn.edit { background: #E8F8F0; color: #27AE60; }
.action-btn.delete { background: #FDEDEC; color: #E74C3C; }
.action-btn.schedule { background: #FEF5E7; color: #F39C12; }
.action-btn.receipt { background: #F5EEF8; color: #9B59B6; }
.action-btn.lock { background: #FDEDEC; color: #E74C3C; }
.action-btn.unlock { background: #E8F8F0; color: #27AE60; }
.action-btn.key { background: #FEF5E7; color: #F39C12; }

/* ----- Status Badges ----- */
.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
}

.status-badge.hoc-thu { background: #E8F4FD; color: var(--status-hoc-thu); }
.status-badge.cho-dk { background: #FEF5E7; color: var(--status-cho-dk); }
.status-badge.da-dk { background: #E8F8F0; color: var(--status-da-dk); }
.status-badge.hoan-thanh { background: #F5EEF8; color: var(--status-hoan-thanh); }
.status-badge.cancel { background: #FDEDEC; color: var(--status-cancel); }
.status-badge.active { background: #E8F8F0; color: var(--btn-success); }
.status-badge.locked { background: #FDEDEC; color: var(--btn-danger); }

/* Role badges */
.role-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 11px;
    font-weight: 600;
}

.role-badge.admin { background: #FDEDEC; color: #E74C3C; }
.role-badge.manager { background: #FEF5E7; color: #F39C12; }
.role-badge.user { background: #E8F4FD; color: #3498DB; }

/* ----- Filter Bar ----- */
.filter-bar {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    align-items: center;
}

.filter-btn {
    padding: 8px 16px;
    border: 2px solid var(--border-color);
    border-radius: 20px;
    background: white;
    cursor: pointer;
    font-weight: 500;
    font-size: 13px;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

.filter-btn:hover {
    border-color: var(--primary-color);
    color: var(--primary-color);
}

.filter-btn.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

.filter-btn .count {
    background: rgba(0,0,0,0.1);
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 12px;
}

.filter-btn.active .count {
    background: rgba(255,255,255,0.3);
}

.search-box {
    position: relative;
    flex: 1;
    min-width: 200px;
    max-width: 300px;
}

.search-box input {
    width: 100%;
    padding: 10px 15px 10px 40px;
    border: 2px solid var(--border-color);
    border-radius: 20px;
    font-size: 14px;
    transition: border-color 0.2s;
}

.search-box input:focus {
    outline: none;
    border-color: var(--primary-color);
}

.search-box::before {
    content: 'üîç';
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 14px;
}

/* ----- Forms ----- */
.form-section {
    background: var(--bg-light);
    padding: 25px;
    border-radius: 12px;
    margin-bottom: 25px;
    border: 2px solid var(--border-color);
    display: none;
}

.form-section.show {
    display: block;
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-15px); }
    to { opacity: 1; transform: translateY(0); }
}

.form-section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--border-color);
}

.form-section-header h3 {
    color: var(--primary-color);
    font-size: 16px;
}

.form-group {
    margin-bottom: 18px;
}

.form-group label {
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 13px;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 10px 14px;
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
    font-size: 14px;
    transition: border-color 0.2s;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--primary-color);
}

.form-group input:disabled,
.form-group select:disabled {
    background: var(--bg-light);
    cursor: not-allowed;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.form-row-3 {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 15px;
}

.form-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.checkbox-group {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
}

.checkbox-item {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    font-size: 14px;
}

.checkbox-item input {
    width: auto;
}

/* ----- Permission Matrix ----- */
.permission-matrix {
    background: var(--bg-white);
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid var(--border-color);
}

.permission-matrix table {
    width: 100%;
}

.permission-matrix th {
    background: var(--bg-light);
    color: var(--text-primary);
    font-weight: 600;
    padding: 12px 15px;
    text-align: center;
    border-bottom: 2px solid var(--border-color);
}

.permission-matrix th:first-child {
    text-align: left;
}

.permission-matrix td {
    padding: 10px 15px;
    text-align: center;
    border-bottom: 1px solid var(--border-color);
}

.permission-matrix td:first-child {
    text-align: left;
    font-weight: 500;
}

.permission-matrix tr:last-child td {
    border-bottom: none;
}

.permission-matrix .tab-name {
    display: flex;
    align-items: center;
    gap: 8px;
}

.permission-checkbox {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

/* ----- Pagination ----- */
.pagination-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 20px;
    padding: 15px 20px;
    background: var(--bg-white);
    border-radius: 12px;
    box-shadow: var(--shadow-sm);
    flex-wrap: wrap;
    gap: 15px;
}

.pagination-info {
    color: var(--text-muted);
    font-size: 14px;
}

.pagination {
    display: flex;
    gap: 5px;
}

.pagination button {
    padding: 8px 14px;
    border: 2px solid var(--border-color);
    background: white;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    font-size: 14px;
    transition: all 0.2s;
}

.pagination button:hover:not(:disabled) {
    border-color: var(--primary-color);
    color: var(--primary-color);
}

.pagination button.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

.pagination button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.page-size-select {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: var(--text-muted);
}

.page-size-select select {
    padding: 6px 10px;
    border: 2px solid var(--border-color);
    border-radius: 6px;
}

/* ----- Modals ----- */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 2000;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.modal.active {
    display: flex;
}

.modal-content {
    background: white;
    border-radius: 16px;
    max-width: 600px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    animation: modalSlideIn 0.3s ease;
    box-shadow: var(--shadow-lg);
}

.modal-lg { max-width: 800px; }
.modal-sm { max-width: 450px; }

@keyframes modalSlideIn {
    from { opacity: 0; transform: translateY(-30px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 25px;
    border-bottom: 1px solid var(--border-color);
}

.modal-header h2 {
    color: var(--primary-color);
    font-size: 18px;
}

.modal-close {
    width: 32px;
    height: 32px;
    border: none;
    background: var(--bg-light);
    border-radius: 50%;
    cursor: pointer;
    font-size: 18px;
    color: var(--text-muted);
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-close:hover {
    background: var(--btn-danger);
    color: white;
}

.modal-body {
    padding: 25px;
}

.modal-footer {
    padding: 15px 25px;
    border-top: 1px solid var(--border-color);
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

/* ----- Notifications ----- */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 12px;
    background: white;
    box-shadow: var(--shadow-lg);
    z-index: 3000;
    display: none;
    align-items: center;
    gap: 12px;
    max-width: 350px;
    animation: slideInRight 0.3s ease;
}

@keyframes slideInRight {
    from { opacity: 0; transform: translateX(100px); }
    to { opacity: 1; transform: translateX(0); }
}

.notification.show { display: flex; }
.notification.success { border-left: 4px solid var(--btn-success); }
.notification.error { border-left: 4px solid var(--btn-danger); }
.notification.warning { border-left: 4px solid var(--btn-warning); }
.notification.info { border-left: 4px solid var(--btn-info); }

/* ----- Empty State ----- */
.empty-state {
    text-align: center;
    padding: 50px 20px;
    color: var(--text-muted);
}

.empty-state-icon {
    font-size: 48px;
    margin-bottom: 15px;
}

.empty-state p {
    font-size: 16px;
}

/* ----- Tags ----- */
.subject-tag {
    display: inline-block;
    padding: 3px 10px;
    background: var(--primary-lighter);
    color: var(--primary-dark);
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
    margin: 2px;
}

/* ----- Quick View ----- */
.quick-view-section {
    background: var(--bg-light);
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 15px;
}

.quick-view-section h4 {
    color: var(--primary-color);
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border-color);
    font-size: 14px;
}

.quick-view-row {
    display: flex;
    padding: 6px 0;
    font-size: 14px;
}

.quick-view-label {
    font-weight: 600;
    color: var(--text-secondary);
    min-width: 120px;
}

.quick-view-value {
    color: var(--text-primary);
    flex: 1;
}

/* ----- Chart ----- */
.chart-container {
    background: var(--bg-white);
    padding: 20px;
    border-radius: 12px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
}

.chart-bars {
    display: flex;
    align-items: flex-end;
    justify-content: space-around;
    height: 180px;
    padding: 15px 0;
    border-bottom: 2px solid var(--border-color);
}

.chart-bar-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
}

.chart-bar {
    width: 40px;
    background: var(--primary-gradient);
    border-radius: 6px 6px 0 0;
    transition: all 0.3s;
    position: relative;
    min-height: 5px;
}

.chart-bar:hover { opacity: 0.8; }

.chart-bar-value {
    position: absolute;
    top: -22px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 11px;
    font-weight: 600;
    color: var(--primary-color);
    white-space: nowrap;
}

.chart-bar-label {
    margin-top: 8px;
    font-size: 12px;
    color: var(--text-muted);
}

/* ----- Settings ----- */
.settings-group {
    background: var(--bg-white);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
}

.settings-group h3 {
    color: var(--primary-color);
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--border-color);
    font-size: 16px;
}

.logo-preview {
    width: 100px;
    height: 100px;
    border: 2px dashed var(--border-color);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 10px 0;
    overflow: hidden;
}

.logo-preview img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
}

/* ----- Upcoming Items ----- */
.upcoming-item {
    background: #FEF9E7;
    padding: 12px 15px;
    border-radius: 8px;
    border-left: 4px solid var(--btn-warning);
    margin-bottom: 10px;
    font-size: 14px;
}

/* ============================================================
   üîß PH·∫¶N 6: UTILITIES
   ============================================================ */
.text-center { text-align: center; }
.text-muted { color: var(--text-muted); }
.text-success { color: var(--btn-success); }
.text-danger { color: var(--btn-danger); }
.text-primary { color: var(--primary-color); }
.text-warning { color: var(--btn-warning); }

.d-flex { display: flex; }
.d-none { display: none !important; }
.gap-10 { gap: 10px; }
.gap-15 { gap: 15px; }
.gap-20 { gap: 20px; }
.justify-between { justify-content: space-between; }
.justify-center { justify-content: center; }
.align-center { align-items: center; }
.flex-wrap { flex-wrap: wrap; }
.flex-1 { flex: 1; }

.mt-10 { margin-top: 10px; }
.mt-15 { margin-top: 15px; }
.mt-20 { margin-top: 20px; }
.mb-10 { margin-bottom: 10px; }
.mb-15 { margin-bottom: 15px; }
.mb-20 { margin-bottom: 20px; }
.p-20 { padding: 20px; }

.fw-600 { font-weight: 600; }
.fw-700 { font-weight: 700; }

/* ============================================================
   üì± PH·∫¶N 7: RESPONSIVE
   ============================================================ */
@media (max-width: 1024px) {
    .sidebar {
        transform: translateX(-100%);
    }
    
    .sidebar.mobile-open {
        transform: translateX(0);
    }
    
    .main-wrapper {
        margin-left: 0;
    }
    
    .sidebar.collapsed ~ .main-wrapper {
        margin-left: 0;
    }
}

@media (max-width: 768px) {
    .form-row,
    .form-row-3 {
        grid-template-columns: 1fr;
    }
    
    .stats-grid {
        grid-template-columns: 1fr 1fr;
    }
    
    .page-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .filter-bar {
        flex-direction: column;
        align-items: stretch;
    }
    
    .search-box {
        max-width: none;
    }
    
    .pagination-container {
        flex-direction: column;
    }
    
    .user-name,
    .user-role {
        display: none;
    }
    
    .login-container {
        padding: 30px 20px;
        margin: 15px;
    }
}

@media (max-width: 480px) {
    .main-content {
        padding: 15px;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .page-title {
        font-size: 16px;
    }
}

/* ============================================================
   üñ®Ô∏è PH·∫¶N 8: PRINT STYLES
   ============================================================ */
@media print {
    .sidebar,
    .main-header,
    .page-actions,
    .filter-bar,
    .pagination-container,
    .action-buttons,
    .login-screen {
        display: none !important;
    }
    
    .main-wrapper {
        margin-left: 0 !important;
    }
    
    .main-content {
        padding: 0;
    }
}

/* ============================================================
   ‚ú® PH·∫¶N 9: ANIMATIONS
   ============================================================ */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.fade-in {
    animation: fadeIn 0.3s ease;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

/* Loading spinner */
.spinner {
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}
    </style>
</head>
<body>
    <!-- ============================================================
         üîê M√ÄN H√åNH ƒêƒÇNG NH·∫¨P
         ============================================================ -->
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <div class="login-logo">
                <div class="logo-icon">üìö</div>
                <h1>H·ªÜ TH·ªêNG QU·∫¢N L√ù</h1>
                <p>Trung T√¢m D·∫°y H·ªçc</p>
            </div>
            
            <div class="login-error" id="loginError">
                <span>‚ö†Ô∏è</span>
                <span id="loginErrorText">Sai t√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u</span>
            </div>
            
            <form class="login-form" id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>T√™n ƒëƒÉng nh·∫≠p</label>
                    <div class="input-wrapper">
                        <span class="input-icon">üë§</span>
                        <input type="text" id="loginUsername" placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p" required autocomplete="username">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>M·∫≠t kh·∫©u</label>
                    <div class="input-wrapper">
                        <span class="input-icon">üîí</span>
                        <input type="password" id="loginPassword" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" required autocomplete="current-password">
                        <button type="button" class="password-toggle" onclick="togglePasswordVisibility()">üëÅÔ∏è</button>
                    </div>
                </div>
                
                <div class="form-options">
                    <label class="remember-me">
                        <input type="checkbox" id="rememberMe">
                        <span>Ghi nh·ªõ ƒëƒÉng nh·∫≠p</span>
                    </label>
                </div>
                
                <button type="submit" class="btn-login" id="btnLogin">
                    <span>ƒêƒÉng nh·∫≠p</span>
                </button>
            </form>
            
            <div class="login-footer">
                <p>Version 4.0 - Profile 001</p>
            </div>
        </div>
    </div>

    <!-- ============================================================
         üìê ·ª®NG D·ª§NG CH√çNH
         ============================================================ -->
    <div class="app-container" id="appContainer">
        
        <!-- ==================== SIDEBAR ==================== -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-logo">
                <div class="logo-icon">üìö</div>
                <span class="logo-text">Qu·∫£n L√Ω Trung T√¢m</span>
            </div>
            
            <nav class="sidebar-nav" id="sidebarNav">
                <!-- Menu s·∫Ω ƒë∆∞·ª£c render b·∫±ng JS d·ª±a tr√™n quy·ªÅn -->
            </nav>
            
            <div class="sidebar-footer">
                <p class="version">Version 4.0</p>
            </div>
        </aside>
        
        <!-- ==================== MAIN WRAPPER ==================== -->
        <div class="main-wrapper">
            
            <!-- Header -->
            <header class="main-header">
                <div class="header-left">
                    <button class="toggle-sidebar-btn" onclick="toggleSidebar()" title="·∫®n/Hi·ªán menu">‚ò∞</button>
                    <h1 class="page-title" id="pageTitle">üìä T·ªïng quan</h1>
                </div>
                <div class="header-right">
                    <button class="header-btn" onclick="createManualBackup()" title="Backup">üíæ</button>
                    <button class="header-btn" title="Th√¥ng b√°o">üîî</button>
                    
                    <!-- User Dropdown -->
                    <div class="user-dropdown">
                        <div class="user-info" onclick="toggleUserMenu()">
                            <div class="user-avatar" id="userAvatar">A</div>
                            <span class="user-name" id="userName">Admin</span>
                            <span class="user-role" id="userRoleBadge">Admin</span>
                        </div>
                        <div class="user-menu" id="userMenu">
                            <div class="user-menu-header">
                                <div class="name" id="userMenuName">Admin</div>
                                <div class="email" id="userMenuRole">Qu·∫£n tr·ªã vi√™n</div>
                            </div>
                            <div class="user-menu-item" onclick="openChangePasswordModal()">
                                <span>üîë</span>
                                <span>ƒê·ªïi m·∫≠t kh·∫©u</span>
                            </div>
                            <div class="user-menu-item" onclick="openProfileModal()">
                                <span>üë§</span>
                                <span>Th√¥ng tin c√° nh√¢n</span>
                            </div>
                            <div class="user-menu-divider"></div>
                            <div class="user-menu-item danger" onclick="handleLogout()">
                                <span>üö™</span>
                                <span>ƒêƒÉng xu·∫•t</span>
                            </div>
                        </div>
                    </div>
                </div>
            </header>
            
            <!-- Main Content -->
            <main class="main-content">
                
                <!-- ==================== TAB: T·ªîNG QUAN ==================== -->
                <div id="dashboard" class="tab-content active">
                    <div class="page-header">
                        <h2>üìä T·ªïng quan h·ªá th·ªëng</h2>
                    </div>
                    <div class="stats-grid" id="dashboardStats"></div>
                    <div class="d-flex gap-20 flex-wrap">
                        <div class="flex-1" style="min-width: 300px;">
                            <div class="chart-container">
                                <h3 class="mb-15">üìà Doanh thu 6 th√°ng g·∫ßn nh·∫•t</h3>
                                <div class="chart-bars" id="revenueChart"></div>
                            </div>
                        </div>
                        <div style="min-width: 300px; max-width: 400px;">
                            <div class="card">
                                <div class="card-header"><h3>üìÖ L·ªãch h·∫πn s·∫Øp t·ªõi</h3></div>
                                <div class="card-body" id="upcomingAppointments"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ==================== TAB: DANH S√ÅCH H·ªåC VI√äN ==================== -->
                <div id="students" class="tab-content">
                    <div class="page-header">
                        <h2>üë©‚Äçüéì Danh s√°ch H·ªçc vi√™n</h2>
                        <div class="page-actions" id="studentsActions">
                            <button class="btn btn-info" onclick="exportStudentsToExcel()">üì§ Export Excel</button>
                            <button class="btn btn-success" onclick="toggleStudentForm()">‚ûï Th√™m h·ªçc vi√™n</button>
                        </div>
                    </div>
                    
                    <div class="form-section" id="studentFormSection">
                        <div class="form-section-header">
                            <h3 id="studentFormTitle">‚ûï Th√™m H·ªçc Vi√™n M·ªõi</h3>
                            <button class="btn btn-sm btn-secondary" onclick="toggleStudentForm()">‚úï ƒê√≥ng</button>
                        </div>
                        <form id="studentForm" onsubmit="saveStudent(event)">
                            <input type="hidden" id="editStudentId" value="">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>T√™n H·ªçc Vi√™n *</label>
                                    <input type="text" id="studentName" required placeholder="Nh·∫≠p t√™n h·ªçc vi√™n">
                                </div>
                                <div class="form-group">
                                    <label>Tu·ªïi *</label>
                                    <input type="number" id="studentAge" required min="3" max="100" placeholder="Nh·∫≠p tu·ªïi">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>T√™n Ph·ª• Huynh *</label>
                                    <input type="text" id="parentName" required placeholder="Nh·∫≠p t√™n ph·ª• huynh">
                                </div>
                                <div class="form-group">
                                    <label>S·ªë ƒêi·ªán Tho·∫°i *</label>
                                    <input type="tel" id="parentPhone" required placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Email Ph·ª• Huynh</label>
                                    <input type="email" id="parentEmail" placeholder="Nh·∫≠p email (t√πy ch·ªçn)">
                                </div>
                                <div class="form-group">
                                    <label>Tr·∫°ng Th√°i *</label>
                                    <select id="studentStatus" required>
                                        <option value="H·ªçc Th·ª≠">üÜï H·ªçc Th·ª≠</option>
                                        <option value="Ch·ªù ƒêƒÉng K√Ω">‚è≥ Ch·ªù ƒêƒÉng K√Ω</option>
                                        <option value="ƒê√£ ƒêƒÉng K√Ω">‚úÖ ƒê√£ ƒêƒÉng K√Ω</option>
                                        <option value="Ho√†n Th√†nh">üéì Ho√†n Th√†nh</option>
                                        <option value="Cancel">‚ùå Cancel</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>M√¥n H·ªçc Quan T√¢m *</label>
                                <div class="checkbox-group" id="subjectCheckboxes"></div>
                            </div>
                            <div class="form-group">
                                <label>Ghi Ch√∫</label>
                                <textarea id="studentNotes" rows="2" placeholder="Nh·∫≠p ghi ch√∫ (t√πy ch·ªçn)"></textarea>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary" id="saveStudentBtn">üíæ L∆∞u H·ªçc Vi√™n</button>
                                <button type="button" class="btn btn-secondary" onclick="toggleStudentForm()">‚ùå H·ªßy</button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="filter-bar">
                        <button class="filter-btn active" onclick="filterStudents('all')" data-filter="all">üìã T·∫•t c·∫£ <span class="count" id="countAll">0</span></button>
                        <button class="filter-btn" onclick="filterStudents('H·ªçc Th·ª≠')" data-filter="H·ªçc Th·ª≠">üÜï H·ªçc Th·ª≠ <span class="count" id="countHocThu">0</span></button>
                        <button class="filter-btn" onclick="filterStudents('Ch·ªù ƒêƒÉng K√Ω')" data-filter="Ch·ªù ƒêƒÉng K√Ω">‚è≥ Ch·ªù ƒêK <span class="count" id="countChoDangKy">0</span></button>
                        <button class="filter-btn" onclick="filterStudents('ƒê√£ ƒêƒÉng K√Ω')" data-filter="ƒê√£ ƒêƒÉng K√Ω">‚úÖ ƒê√£ ƒêK <span class="count" id="countDaDangKy">0</span></button>
                        <button class="filter-btn" onclick="filterStudents('Ho√†n Th√†nh')" data-filter="Ho√†n Th√†nh">üéì Ho√†n Th√†nh <span class="count" id="countHoanThanh">0</span></button>
                        <button class="filter-btn" onclick="filterStudents('Cancel')" data-filter="Cancel">‚ùå Cancel <span class="count" id="countCancel">0</span></button>
                        <div class="search-box">
                            <input type="text" id="searchStudent" placeholder="T√¨m ki·∫øm h·ªçc vi√™n..." oninput="searchStudents()">
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>T√™n HV</th>
                                    <th>Tu·ªïi</th>
                                    <th>Ph·ª• Huynh</th>
                                    <th>SƒêT</th>
                                    <th>M√¥n H·ªçc</th>
                                    <th>Tr·∫°ng Th√°i</th>
                                    <th>Thao T√°c</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTableBody"></tbody>
                        </table>
                    </div>
                    <div class="pagination-container" id="studentsPagination"></div>
                </div>
                
                <!-- ==================== TAB: H·ªåC TH·ª¨ ==================== -->
                <div id="trial" class="tab-content">
                    <div class="page-header">
                        <h2>üéì Danh s√°ch H·ªçc th·ª≠ & Ch·ªù ƒëƒÉng k√Ω</h2>
                        <div class="page-actions"><button class="btn btn-info" onclick="exportTrialStudentsToExcel()">üì§ Export Excel</button></div>
                    </div>
                    <div class="filter-bar">
                        <button class="filter-btn active" onclick="filterTrialStudents('all')" data-filter="all">üìã T·∫•t c·∫£ <span class="count" id="trialCountAll">0</span></button>
                        <button class="filter-btn" onclick="filterTrialStudents('H·ªçc Th·ª≠')" data-filter="H·ªçc Th·ª≠">üÜï H·ªçc Th·ª≠ <span class="count" id="trialCountHocThu">0</span></button>
                        <button class="filter-btn" onclick="filterTrialStudents('Ch·ªù ƒêƒÉng K√Ω')" data-filter="Ch·ªù ƒêƒÉng K√Ω">‚è≥ Ch·ªù ƒêK <span class="count" id="trialCountChoDangKy">0</span></button>
                        <div class="search-box"><input type="text" id="searchTrialStudent" placeholder="T√¨m ki·∫øm..." oninput="searchTrialStudents()"></div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>T√™n HV</th><th>Tu·ªïi</th><th>Ph·ª• Huynh</th><th>SƒêT</th><th>M√¥n H·ªçc</th><th>Tr·∫°ng Th√°i</th><th>L·ªãch H·∫πn</th><th>Thao T√°c</th></tr></thead>
                            <tbody id="trialStudentsTableBody"></tbody>
                        </table>
                    </div>
                    <div class="pagination-container" id="trialPagination"></div>
                </div>
                
                <!-- ==================== TAB: L·ªäCH H·∫∏N ==================== -->
                <div id="appointments" class="tab-content">
                    <div class="page-header">
                        <h2>üìÖ Qu·∫£n l√Ω L·ªãch h·∫πn</h2>
                        <div class="page-actions" id="appointmentsActions">
                            <button class="btn btn-info" onclick="exportAppointmentsToExcel()">üì§ Export Excel</button>
                            <button class="btn btn-success" onclick="openNewAppointmentModal()">‚ûï Th√™m l·ªãch h·∫πn</button>
                        </div>
                    </div>
                    <div class="filter-bar">
                        <button class="filter-btn active" onclick="filterAppointments('all')">üìã T·∫•t c·∫£</button>
                        <button class="filter-btn" onclick="filterAppointments('upcoming')">‚è∞ S·∫Øp t·ªõi</button>
                        <button class="filter-btn" onclick="filterAppointments('past')">‚úÖ ƒê√£ qua</button>
                        <div class="search-box"><input type="text" id="searchAppointment" placeholder="T√¨m ki·∫øm l·ªãch h·∫πn..." oninput="searchAppointments()"></div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>H·ªçc Vi√™n</th><th>Ph·ª• Huynh</th><th>SƒêT</th><th>M√¥n H·ªçc</th><th>Ng√†y</th><th>Gi·ªù</th><th>Tr·∫°ng Th√°i</th><th>Thao T√°c</th></tr></thead>
                            <tbody id="appointmentsTableBody"></tbody>
                        </table>
                    </div>
                    <div class="pagination-container" id="appointmentsPagination"></div>
                </div>
                
                <!-- ==================== TAB: PHI·∫æU ƒêƒÇNG K√ù ==================== -->
                <div id="registrations" class="tab-content">
                    <div class="page-header">
                        <h2>üìã Qu·∫£n l√Ω Phi·∫øu ƒëƒÉng k√Ω</h2>
                        <div class="page-actions" id="registrationsActions">
                            <button class="btn btn-info" onclick="exportRegistrationsToExcel()">üì§ Export Excel</button>
                            <button class="btn btn-success" onclick="openNewRegistrationModal()">‚ûï T·∫°o phi·∫øu ƒêK</button>
                        </div>
                    </div>
                    <div class="filter-bar"><div class="search-box"><input type="text" id="searchRegistration" placeholder="T√¨m ki·∫øm phi·∫øu ƒëƒÉng k√Ω..." oninput="searchRegistrations()"></div></div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>M√£ Phi·∫øu</th><th>H·ªçc Vi√™n</th><th>M√¥n H·ªçc / G√≥i / H·ªçc Ph√≠</th><th>Gi·∫£m Gi√°</th><th>Th√†nh Ti·ªÅn</th><th>Ng√†y ƒêK</th><th>Thao T√°c</th></tr></thead>
                            <tbody id="registrationsTableBody"></tbody>
                        </table>
                    </div>
                    <div class="pagination-container" id="registrationsPagination"></div>
                </div>
                
                <!-- ==================== TAB: BI√äN LAI ==================== -->
                <div id="receipts" class="tab-content">
                    <div class="page-header">
                        <h2>üßæ Qu·∫£n l√Ω Bi√™n lai</h2>
                        <div class="page-actions" id="receiptsActions">
                            <button class="btn btn-info" onclick="exportReceiptsToExcel()">üì§ Export Excel</button>
                            <button class="btn btn-success" onclick="openReceiptModal()">‚ûï T·∫°o bi√™n lai</button>
                        </div>
                    </div>
                    <div class="filter-bar"><div class="search-box"><input type="text" id="searchReceipt" placeholder="T√¨m ki·∫øm bi√™n lai..." oninput="searchReceipts()"></div></div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>M√£ BL</th><th>Lo·∫°i</th><th>H·ªçc Vi√™n</th><th>N·ªôi Dung</th><th>S·ªë Ti·ªÅn</th><th>Ng√†y</th><th>Thao T√°c</th></tr></thead>
                            <tbody id="receiptsTableBody"></tbody>
                        </table>
                    </div>
                    <div class="pagination-container" id="receiptsPagination"></div>
                </div>
                
                <!-- ==================== TAB: C√îNG N·ª¢ ==================== -->
                <div id="debts" class="tab-content">
                    <div class="page-header"><h2>üí≥ Qu·∫£n l√Ω C√¥ng n·ª£</h2></div>
                    <div class="empty-state"><div class="empty-state-icon">üöß</div><p>T√≠nh nƒÉng ƒëang ph√°t tri·ªÉn...</p></div>
                </div>
                
                <!-- ==================== TAB: GI√ÅO VI√äN ==================== -->
                <div id="teachers" class="tab-content">
                    <div class="page-header">
                        <h2>üë®‚Äçüè´ Qu·∫£n l√Ω Gi√°o vi√™n</h2>
                        <div class="page-actions" id="teachersActions">
                            <button class="btn btn-success" onclick="openTeacherModal()">‚ûï Th√™m gi√°o vi√™n</button>
                        </div>
                    </div>
                    
                    <div class="filter-bar">
                        <div class="search-box">
                            <input type="text" id="searchTeacher" placeholder="T√¨m ki·∫øm gi√°o vi√™n..." oninput="searchTeachers()">
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>H·ªç t√™n</th>
                                    <th>S·ªë ƒëi·ªán tho·∫°i</th>
                                    <th>M√¥n d·∫°y</th>
                                    <th>Lo·∫°i l∆∞∆°ng</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="teachersTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- ==================== TAB: L·ªöP H·ªåC ==================== -->
                <div id="classes" class="tab-content">
                    <div class="page-header">
                        <h2>üìö Qu·∫£n l√Ω L·ªõp h·ªçc</h2>
                        <div class="page-actions" id="classesActions">
                            <button class="btn btn-success" onclick="openClassModal()">‚ûï Th√™m l·ªõp m·ªõi</button>
                        </div>
                    </div>
                    
                    <div class="filter-bar">
                        <select id="filterClassSubject" onchange="filterClasses()">
                            <option value="">üìñ T·∫•t c·∫£ m√¥n h·ªçc</option>
                        </select>
                        <select id="filterClassTeacher" onchange="filterClasses()">
                            <option value="">üë®‚Äçüè´ T·∫•t c·∫£ gi√°o vi√™n</option>
                        </select>
                        <select id="filterClassStatus" onchange="filterClasses()">
                            <option value="">üìä T·∫•t c·∫£ tr·∫°ng th√°i</option>
                            <option value="new">üÜï L·ªõp m·ªõi</option>
                            <option value="active">üü¢ ƒêang h·ªçc</option>
                            <option value="completed">‚úÖ Ho√†n th√†nh</option>
                            <option value="cancelled">‚ùå ƒê√£ h·ªßy</option>
                        </select>
                        <div class="search-box">
                            <input type="text" id="searchClass" placeholder="T√¨m ki·∫øm l·ªõp h·ªçc..." oninput="searchClasses()">
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>T√™n l·ªõp</th>
                                    <th>M√¥n h·ªçc</th>
                                    <th>Gi√°o vi√™n</th>
                                    <th>Lo·∫°i</th>
                                    <th>Sƒ© s·ªë</th>
                                    <th>L·ªãch h·ªçc</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="classesTableBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- ==================== TAB: ƒêI·ªÇM DANH ==================== -->
                <div id="attendance" class="tab-content">
                    <div class="page-header">
                        <h2>‚úÖ ƒêi·ªÉm danh</h2>
                        <div class="page-actions">
                            <button class="btn btn-info" onclick="exportAttendanceToExcel()">üì§ Export Excel</button>
                        </div>
                    </div>
                    
                    <!-- B·ªô ch·ªçn ƒëi·ªÉm danh -->
                    <div class="card mb-20">
                        <div class="card-body">
                            <div class="d-flex gap-15 flex-wrap align-center">
                                <div class="form-group" style="margin-bottom: 0; min-width: 200px;">
                                    <label style="font-size: 12px; margin-bottom: 4px;">Ch·ªçn l·ªõp *</label>
                                    <select id="attendanceClassSelect" onchange="onAttendanceClassChange()">
                                        <option value="">-- Ch·ªçn l·ªõp h·ªçc --</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin-bottom: 0; min-width: 150px;">
                                    <label style="font-size: 12px; margin-bottom: 4px;">Ng√†y ƒëi·ªÉm danh *</label>
                                    <input type="date" id="attendanceDate" onchange="onAttendanceDateChange()">
                                </div>
                                <div class="form-group" style="margin-bottom: 0; min-width: 180px;">
                                    <label style="font-size: 12px; margin-bottom: 4px;">Ca h·ªçc *</label>
                                    <select id="attendanceScheduleSelect" onchange="loadAttendanceList()">
                                        <option value="">-- Ch·ªçn ca h·ªçc --</option>
                                    </select>
                                </div>
                                <div style="padding-top: 18px;">
                                    <button class="btn btn-primary" onclick="loadAttendanceList()">üîÑ T·∫£i danh s√°ch</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- L·ªãch h·ªçc h√¥m nay -->
                    <div class="card mb-20" id="todaySchedulesCard">
                        <div class="card-header">
                            <h3>üìÖ L·ªãch h·ªçc h√¥m nay</h3>
                            <button class="btn btn-sm btn-outline" onclick="refreshTodaySchedules()">üîÑ L√†m m·ªõi</button>
                        </div>
                        <div class="card-body" id="todaySchedulesList">
                            <p class="text-muted">ƒêang t·∫£i...</p>
                        </div>
                    </div>
                    
                    <!-- B·∫£ng ƒëi·ªÉm danh -->
                    <div class="card" id="attendanceTableCard" style="display: none;">
                        <div class="card-header">
                            <h3 id="attendanceTableTitle">üìã ƒêi·ªÉm danh</h3>
                            <div class="d-flex gap-10">
                                <button class="btn btn-sm btn-success" onclick="markAllPresent()">‚úÖ T·∫•t c·∫£ C√≥ m·∫∑t</button>
                                <button class="btn btn-sm btn-primary" onclick="saveAttendance()">üíæ L∆∞u ƒëi·ªÉm danh</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-container" style="box-shadow: none; border: none;">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>H·ªçc vi√™n</th>
                                            <th>T·ªïng bu·ªïi</th>
                                            <th>ƒê√£ h·ªçc</th>
                                            <th>C√≤n l·∫°i</th>
                                            <th style="min-width: 280px;">Tr·∫°ng th√°i ƒëi·ªÉm danh</th>
                                            <th>Ghi ch√∫</th>
                                        </tr>
                                    </thead>
                                    <tbody id="attendanceTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- L·ªãch s·ª≠ ƒëi·ªÉm danh -->
                    <div class="card mt-20">
                        <div class="card-header">
                            <h3>üìú L·ªãch s·ª≠ ƒëi·ªÉm danh g·∫ßn ƒë√¢y</h3>
                        </div>
                        <div class="card-body">
                            <div class="table-container" style="box-shadow: none; border: none;">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Ng√†y</th>
                                            <th>L·ªõp</th>
                                            <th>Ca h·ªçc</th>
                                            <th>Sƒ© s·ªë</th>
                                            <th>C√≥ m·∫∑t</th>
                                            <th>V·∫Øng</th>
                                            <th>Thao t√°c</th>
                                        </tr>
                                    </thead>
                                    <tbody id="attendanceHistoryBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ==================== TAB: H·ªåC B√ô ==================== -->
                <div id="makeup" class="tab-content">
                    <div class="page-header">
                        <h2>üìù Qu·∫£n l√Ω H·ªçc b√π</h2>
                            <div class="page-actions">
                                <button class="btn btn-success" onclick="openCreateMakeupModal()">‚ûï T·∫°o y√™u c·∫ßu h·ªçc b√π</button>
                            </div>
                    </div>
                    
                    <!-- Th·ªëng k√™ -->
                    <div class="stats-grid mb-20">
                        <div class="stat-card">
                            <div class="stat-icon orange">‚è≥</div>
                            <div class="stat-info">
                                <h3 id="makeupPendingCount">0</h3>
                                <p>Ch·ªù x·∫øp l·ªãch</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon blue">üìÖ</div>
                            <div class="stat-info">
                                <h3 id="makeupApprovedCount">0</h3>
                                <p>ƒê√£ x·∫øp l·ªãch</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon red">‚ö†Ô∏è</div>
                            <div class="stat-info">
                                <h3 id="makeupExpiringCount">0</h3>
                                <p>S·∫Øp h·∫øt h·∫°n (‚â§7 ng√†y)</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon green">‚úÖ</div>
                            <div class="stat-info">
                                <h3 id="makeupCompletedCount">0</h3>
                                <p>ƒê√£ ho√†n th√†nh</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- B·ªô l·ªçc -->
                    <div class="filter-bar">
                        <button class="filter-btn active" onclick="filterMakeupRequests('all')" data-filter="all">üìã T·∫•t c·∫£</button>
                        <button class="filter-btn" onclick="filterMakeupRequests('pending')" data-filter="pending">‚è≥ Ch·ªù x·∫øp l·ªãch</button>
                        <button class="filter-btn" onclick="filterMakeupRequests('approved')" data-filter="approved">üìÖ ƒê√£ x·∫øp l·ªãch</button>
                        <button class="filter-btn" onclick="filterMakeupRequests('expiring')" data-filter="expiring">‚ö†Ô∏è S·∫Øp h·∫øt h·∫°n</button>
                        <button class="filter-btn" onclick="filterMakeupRequests('completed')" data-filter="completed">‚úÖ Ho√†n th√†nh</button>
                        <button class="filter-btn" onclick="filterMakeupRequests('expired')" data-filter="expired">‚ùå ƒê√£ h·∫øt h·∫°n</button>
                    </div>
                    
                    <!-- B·∫£ng y√™u c·∫ßu h·ªçc b√π -->
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>H·ªçc vi√™n</th>
                                    <th>L·ªõp g·ªëc</th>
                                    <th>Ng√†y ngh·ªâ</th>
                                    <th>H·∫°n h·ªçc b√π</th>
                                    <th>L·ªõp h·ªçc b√π</th>
                                    <th>Ng√†y h·ªçc b√π</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="makeupRequestsBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- ==================== TAB: M√îN H·ªåC ==================== -->
                <div id="subjects" class="tab-content">
                    <div class="page-header">
                        <h2>üìñ Danh m·ª•c M√¥n h·ªçc</h2>
                        <div class="page-actions" id="subjectsActions"><button class="btn btn-success" onclick="openSubjectModal()">‚ûï Th√™m m√¥n h·ªçc</button></div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Icon</th><th>T√™n M√¥n</th><th>H·ªçc Ph√≠ M·∫∑c ƒê·ªãnh</th><th>Thao T√°c</th></tr></thead>
                            <tbody id="subjectsTableBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- ==================== TAB: G√ìI H·ªåC PH√ç ==================== -->
                <div id="packages" class="tab-content">
                    <div class="page-header">
                        <h2>üì¶ Danh m·ª•c G√≥i h·ªçc ph√≠</h2>
                        <div class="page-actions" id="packagesActions"><button class="btn btn-success" onclick="openPackageModal()">‚ûï Th√™m g√≥i</button></div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>T√™n G√≥i</th><th>M√¥n H·ªçc</th><th>S·ªë Bu·ªïi</th><th>H·ªçc Ph√≠</th><th>Thao T√°c</th></tr></thead>
                            <tbody id="packagesTableBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- ==================== TAB: KHUY·∫æN M√ÉI ==================== -->
                <div id="promotions" class="tab-content">
                    <div class="page-header">
                        <h2>üéÅ Danh m·ª•c Khuy·∫øn m√£i</h2>
                        <div class="page-actions" id="promotionsActions"><button class="btn btn-success" onclick="openPromotionModal()">‚ûï Th√™m KM</button></div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>T√™n KM</th><th>Lo·∫°i</th><th>Gi√° Tr·ªã</th><th>Th·ªùi H·∫°n</th><th>Tr·∫°ng Th√°i</th><th>Thao T√°c</th></tr></thead>
                            <tbody id="promotionsTableBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- ==================== TAB: B√ÅO C√ÅO ==================== -->
                <div id="reports" class="tab-content">
                    <div class="page-header"><h2>üìà B√°o c√°o th·ªëng k√™</h2></div>
                    <div class="empty-state"><div class="empty-state-icon">üöß</div><p>T√≠nh nƒÉng ƒëang ph√°t tri·ªÉn...</p></div>
                </div>
                
                <!-- ==================== TAB: XU·∫§T/NH·∫¨P DATA ==================== -->
                <div id="export" class="tab-content">
                    <div class="page-header"><h2>üì§ Xu·∫•t/Nh·∫≠p d·ªØ li·ªáu & Sao l∆∞u</h2></div>
                    <div class="settings-group">
                        <h3>üìä Xu·∫•t File Excel</h3>
                        <div class="d-flex gap-10 flex-wrap">
                            <button class="btn btn-success" onclick="exportAllToExcel()">üìä Xu·∫•t T·∫•t C·∫£</button>
                            <button class="btn btn-info" onclick="exportStudentsToExcel()">üë©‚Äçüéì H·ªçc Vi√™n</button>
                            <button class="btn btn-warning" onclick="exportAppointmentsToExcel()">üìÖ L·ªãch H·∫πn</button>
                            <button class="btn btn-primary" onclick="exportRegistrationsToExcel()">üìã Phi·∫øu ƒêK</button>
                            <button class="btn btn-secondary" onclick="exportReceiptsToExcel()">üßæ Bi√™n Lai</button>
                        </div>
                    </div>
                    <div class="settings-group">
                        <h3>üíæ Sao L∆∞u & Kh√¥i Ph·ª•c</h3>
                        <div class="d-flex gap-10 flex-wrap">
                            <button class="btn btn-success" onclick="exportBackupJSON()">üíæ T·∫£i Backup JSON</button>
                            <label class="btn btn-info" style="cursor: pointer;">üìÅ Kh√¥i Ph·ª•c JSON<input type="file" accept=".json" onchange="restoreFromJSON(event)" style="display: none;"></label>
                            <label class="btn btn-warning" style="cursor: pointer;">üì• Import Excel<input type="file" accept=".xlsx,.xls" onchange="importFromExcel(event)" style="display: none;"></label>
                        </div>
                    </div>
                    <div class="settings-group">
                        <h3>üìú L·ªãch S·ª≠ Backup T·ª± ƒê·ªông</h3>
                        <div id="backupHistoryList"></div>
                    </div>
                </div>
                
                <!-- ==================== TAB: T√ÄI KHO·∫¢N ==================== -->
                <div id="users" class="tab-content">
                    <div class="page-header">
                        <h2>üîê Qu·∫£n l√Ω T√†i kho·∫£n</h2>
                        <div class="page-actions"><button class="btn btn-success" onclick="openUserModal()">‚ûï Th√™m t√†i kho·∫£n</button></div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Username</th><th>H·ªç t√™n</th><th>Vai tr√≤</th><th>Tr·∫°ng th√°i</th><th>ƒêƒÉng nh·∫≠p cu·ªëi</th><th>Thao t√°c</th></tr></thead>
                            <tbody id="usersTableBody"></tbody>
                        </table>
                    </div>
                    
                    <!-- Ph√¢n quy·ªÅn ƒë·ªông -->
                    <div class="card mt-20">
                        <div class="card-header">
                            <h3>‚öôÔ∏è Ph√¢n quy·ªÅn theo vai tr√≤</h3>
                            <select id="permissionRoleSelect" onchange="loadPermissionsForRole()">
                                <option value="admin">Admin</option>
                                <option value="manager">Manager</option>
                                <option value="user">User</option>
                            </select>
                        </div>
                        <div class="card-body">
                            <div class="permission-matrix" id="permissionMatrix">
                                <!-- Render b·∫±ng JS -->
                            </div>
                            <div class="form-actions mt-15">
                                <button class="btn btn-primary" onclick="savePermissions()">üíæ L∆∞u ph√¢n quy·ªÅn</button>
                                <button class="btn btn-secondary" onclick="resetPermissions()">üîÑ Reset m·∫∑c ƒë·ªãnh</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ==================== TAB: C√ÄI ƒê·∫∂T ==================== -->
                <div id="settings" class="tab-content">
                    <div class="page-header"><h2>‚öôÔ∏è C√†i ƒë·∫∑t h·ªá th·ªëng</h2></div>
                    <div class="settings-group">
                        <h3>üè¢ Th√¥ng Tin Trung T√¢m</h3>
                        <form id="centerInfoForm" onsubmit="saveCenterInfo(event)">
                            <div class="form-row">
                                <div class="form-group"><label>T√™n Trung T√¢m *</label><input type="text" id="centerName" placeholder="VD: Trung T√¢m ABC"></div>
                                <div class="form-group"><label>S·ªë ƒêi·ªán Tho·∫°i *</label><input type="tel" id="centerPhone" placeholder="VD: 0912345678"></div>
                            </div>
                            <div class="form-group"><label>ƒê·ªãa Ch·ªâ *</label><input type="text" id="centerAddress" placeholder="VD: 123 ƒê∆∞·ªùng ABC"></div>
                            <div class="form-row">
                                <div class="form-group"><label>Email</label><input type="email" id="centerEmail" placeholder="VD: contact@abc.edu.vn"></div>
                                <div class="form-group"><label>Website</label><input type="url" id="centerWebsite" placeholder="VD: https://abc.edu.vn"></div>
                            </div>
                            <div class="form-group">
                                <label>Logo</label>
                                <input type="file" id="centerLogo" accept="image/*" onchange="previewLogo(event)">
                                <div class="logo-preview" id="logoPreview"><span class="text-muted">Logo</span></div>
                            </div>
                            <button type="submit" class="btn btn-primary">üíæ L∆∞u th√¥ng tin</button>
                        </form>
                    </div>
                    <div class="settings-group">
                        <h3>üí≥ Th√¥ng Tin Ng√¢n H√†ng</h3>
                        <form id="bankInfoForm" onsubmit="saveBankInfo(event)">
                            <div class="form-row">
                                <div class="form-group"><label>T√™n Ng√¢n H√†ng *</label><input type="text" id="bankName" placeholder="VD: Vietcombank"></div>
                                <div class="form-group"><label>S·ªë T√†i Kho·∫£n *</label><input type="text" id="bankAccount" placeholder="VD: 1234567890"></div>
                            </div>
                            <div class="form-row">
                                <div class="form-group"><label>Ch·ªß T√†i Kho·∫£n *</label><input type="text" id="bankAccountName" placeholder="VD: NGUYEN VAN A"></div>
                                <div class="form-group"><label>Chi Nh√°nh</label><input type="text" id="bankBranch" placeholder="VD: Chi nh√°nh T√¢n B√¨nh"></div>
                            </div>
                            <button type="submit" class="btn btn-primary">üíæ L∆∞u th√¥ng tin</button>
                        </form>
                        <div class="mt-15"><h4 style="font-size: 14px; margin-bottom: 10px;">QR Chuy·ªÉn Kho·∫£n:</h4><div id="bankQRCode"></div></div>
                    </div>
                    <div class="settings-group">
                        <h3>üîÑ Sao L∆∞u T·ª± ƒê·ªông</h3>
                        <div class="d-flex align-center gap-15">
                            <label class="d-flex align-center gap-10" style="cursor: pointer;"><input type="checkbox" id="autoBackupToggle" onchange="toggleAutoBackup()"><span>B·∫≠t sao l∆∞u t·ª± ƒë·ªông</span></label>
                            <span id="autoBackupStatus" class="text-muted"></span>
                        </div>
                    </div>
                    <div class="settings-group">
                        <h3>üóëÔ∏è X√≥a D·ªØ Li·ªáu</h3>
                        <p class="text-muted mb-15" style="font-size: 13px;">‚ö†Ô∏è H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!</p>
                        
                        <div class="d-flex gap-10 flex-wrap">
                            <div style="flex: 1; min-width: 250px; background: #FEF9E7; padding: 15px; border-radius: 8px; border: 1px solid #F39C12;">
                                <h4 style="margin: 0 0 10px 0; color: #9A7B0A; font-size: 14px;">üßπ X√≥a D·ªØ Li·ªáu Demo</h4>
                                <p style="font-size: 12px; color: #7D6608; margin-bottom: 10px;">
                                    X√≥a: H·ªçc vi√™n, L·ªãch h·∫πn, Phi·∫øu ƒêK, Bi√™n lai, Gi√°o vi√™n, L·ªõp h·ªçc, ƒêi·ªÉm danh, H·ªçc b√π.<br>
                                    <strong>Gi·ªØ l·∫°i:</strong> T√†i kho·∫£n, Ph√¢n quy·ªÅn, M√¥n h·ªçc, G√≥i h·ªçc ph√≠, Khuy·∫øn m√£i, C√†i ƒë·∫∑t.
                                </p>
                                <button class="btn btn-warning" onclick="clearDemoData()">üßπ X√≥a D·ªØ Li·ªáu Demo</button>
                            </div>
                            
                            <div style="flex: 1; min-width: 250px; background: #FDEDEC; padding: 15px; border-radius: 8px; border: 1px solid #E74C3C;">
                                <h4 style="margin: 0 0 10px 0; color: #922B21; font-size: 14px;">üóëÔ∏è X√≥a To√†n B·ªô D·ªØ Li·ªáu</h4>
                                <p style="font-size: 12px; color: #7B241C; margin-bottom: 10px;">
                                    X√≥a T·∫§T C·∫¢ d·ªØ li·ªáu nghi·ªáp v·ª•.<br>
                                    <strong>Gi·ªØ l·∫°i:</strong> Ch·ªâ gi·ªØ T√†i kho·∫£n ƒëƒÉng nh·∫≠p v√† M√¥n h·ªçc m·∫∑c ƒë·ªãnh.
                                </p>
                                <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è X√≥a To√†n B·ªô</button>
                            </div>
                        </div>
                    </div>

                </div>
                
            </main>
        </div>
    </div>
    
    <!-- ============================================================
         üîî MODALS
         ============================================================ -->
    
    <!-- Quick View Modal -->
    <div id="quickViewModal" class="modal">
        <div class="modal-content modal-lg">
            <div class="modal-header"><h2>üëÅÔ∏è Th√¥ng Tin Chi Ti·∫øt</h2><button class="modal-close" onclick="closeModal('quickViewModal')">√ó</button></div>
            <div class="modal-body" id="quickViewContent"></div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('quickViewModal')">ƒê√≥ng</button></div>
        </div>
    </div>

    <!-- Appointment Modal -->
    <div id="appointmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="appointmentModalTitle">üìÖ ƒê·∫∑t L·ªãch H·∫πn</h2><button class="modal-close" onclick="closeModal('appointmentModal')">√ó</button></div>
            <div class="modal-body">
                <form id="appointmentForm" onsubmit="saveAppointment(event)">
                    <input type="hidden" id="appointmentStudentId"><input type="hidden" id="editAppointmentId">
                    <div class="form-group"><label>H·ªçc Vi√™n *</label><select id="appointmentStudentSelect" required onchange="onAppointmentStudentChange()"><option value="">-- Ch·ªçn h·ªçc vi√™n --</option></select></div>
                    <div class="form-group"><label>M√¥n H·ªçc *</label><select id="appointmentSubject" required><option value="">-- Ch·ªçn m√¥n h·ªçc --</option></select></div>
                    <div class="form-row">
                        <div class="form-group"><label>Ng√†y H·∫πn *</label><input type="date" id="appointmentDate" required></div>
                        <div class="form-group"><label>Gi·ªù H·∫πn *</label><input type="time" id="appointmentTime" required></div>
                    </div>
                    <div class="form-group"><label>Ghi Ch√∫</label><textarea id="appointmentNotes" rows="2" placeholder="Ghi ch√∫"></textarea></div>
                    <div id="appointmentConflictWarning" class="d-none" style="background: #FEF5E7; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #F39C12; font-size: 13px;"></div>
                </form>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" onclick="closeModal('appointmentModal')">H·ªßy</button><button type="submit" form="appointmentForm" class="btn btn-success">üíæ L∆∞u</button></div>
        </div>
    </div>

    <!-- Registration Modal -->
    <div id="registrationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>üìã T·∫°o Phi·∫øu ƒêƒÉng K√Ω</h2><button class="modal-close" onclick="closeModal('registrationModal')">√ó</button></div>
            <div class="modal-body">
                <form id="registrationForm" onsubmit="saveRegistration(event)">
                    <input type="hidden" id="regStudentId">
                    <div class="form-group"><label>H·ªçc Vi√™n *</label><select id="regStudentSelect" required onchange="onRegStudentChange()"><option value="">-- Ch·ªçn h·ªçc vi√™n --</option></select></div>
                    <div class="form-row">
                        <div class="form-group"><label>M√¥n H·ªçc *</label><select id="regSubject" required onchange="loadPackagesForSubject()"><option value="">-- Ch·ªçn m√¥n --</option></select></div>
                        <div class="form-group"><label>G√≥i H·ªçc Ph√≠</label><select id="regPackage" onchange="applyPackageFee()"><option value="">-- Nh·∫≠p th·ªß c√¥ng --</option></select></div>
                    </div>
                    <div class="form-group"><label>H·ªçc Ph√≠ (VNƒê) *</label><input type="text" id="regTuitionFee" required placeholder="VD: 2,000,000" oninput="formatCurrencyInput(this); calculateFinalAmount()"></div>
                    <div class="form-group"><label>Khuy·∫øn M√£i</label><div id="regPromotionList" class="checkbox-group"></div></div>
                    <div class="form-row">
                        <div class="form-group"><label>Gi·∫£m Gi√°</label><input type="text" id="regDiscountAmount" readonly style="background: #FDEDEC; color: #E74C3C; font-weight: 600;"></div>
                        <div class="form-group"><label>Th√†nh Ti·ªÅn</label><input type="text" id="regFinalAmount" readonly style="background: #E8F8F0; color: #27AE60; font-weight: 600;"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" onclick="closeModal('registrationModal')">H·ªßy</button><button type="submit" form="registrationForm" class="btn btn-success">‚úÖ T·∫°o Phi·∫øu ƒêK</button></div>
        </div>
    </div>

    <!-- View Registration Modal -->
    <div id="viewRegistrationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>üìã Chi Ti·∫øt Phi·∫øu ƒêƒÉng K√Ω</h2><button class="modal-close" onclick="closeModal('viewRegistrationModal')">√ó</button></div>
            <div class="modal-body" id="registrationPreviewContent"></div>
            <div class="modal-footer">
                <button class="btn btn-info" onclick="printRegistration()">üñ®Ô∏è In</button>
                <button class="btn btn-primary" onclick="downloadRegistrationPDF()">üìÑ T·∫£i PDF</button>
                <button class="btn btn-secondary" onclick="closeModal('viewRegistrationModal')">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receiptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>üßæ T·∫°o Bi√™n Lai</h2><button class="modal-close" onclick="closeModal('receiptModal')">√ó</button></div>
            <div class="modal-body">
                <form id="receiptForm" onsubmit="saveReceipt(event)">
                    <input type="hidden" id="editReceiptId">
                    <div class="form-group"><label>Lo·∫°i *</label><select id="receiptType" required><option value="">-- Ch·ªçn lo·∫°i --</option><option value="Bi√™n Lai ƒêi·ªán T·ª≠">üí≥ Bi√™n Lai ƒêi·ªán T·ª≠</option><option value="Phi·∫øu Thu">üíµ Phi·∫øu Thu</option></select></div>
                    <div class="form-group"><label>H·ªçc Vi√™n *</label><select id="receiptStudentId" required onchange="fillReceiptStudentInfo()"><option value="">-- Ch·ªçn h·ªçc vi√™n --</option></select></div>
                    <div class="form-row">
                        <div class="form-group"><label>Ph·ª• Huynh</label><input type="text" id="receiptParentName" readonly style="background: var(--bg-light);"></div>
                        <div class="form-group"><label>SƒêT</label><input type="text" id="receiptParentPhone" readonly style="background: var(--bg-light);"></div>
                    </div>
                    <div class="form-group"><label>Li√™n k·∫øt Phi·∫øu ƒêK</label><select id="receiptRegistrationSelect" onchange="fillFromRegistration()"><option value="">-- Ch·ªçn phi·∫øu ƒêK --</option></select><input type="hidden" id="receiptRegistrationId"></div>
                    <div class="form-group"><label>N·ªôi Dung *</label><input type="text" id="receiptDescription" required placeholder="VD: H·ªçc ph√≠ th√°ng 1"></div>
                    <div class="form-row">
                        <div class="form-group"><label>S·ªë Ti·ªÅn (VNƒê) *</label><input type="text" id="receiptAmount" required placeholder="VD: 2,000,000" oninput="formatCurrencyInput(this)"></div>
                        <div class="form-group"><label>Ng√†y *</label><input type="date" id="receiptDate" required></div>
                    </div>
                    <div class="form-group"><label>Ghi Ch√∫</label><textarea id="receiptNotes" rows="2" placeholder="Ghi ch√∫"></textarea></div>
                </form>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" onclick="closeModal('receiptModal')">H·ªßy</button><button type="submit" form="receiptForm" class="btn btn-success">üíæ L∆∞u</button></div>
        </div>
    </div>

    <!-- View Receipt Modal -->
    <div id="viewReceiptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>üßæ Xem Bi√™n Lai</h2><button class="modal-close" onclick="closeModal('viewReceiptModal')">√ó</button></div>
            <div class="modal-body" id="receiptPreviewContent"></div>
            <div class="modal-footer">
                <button class="btn btn-info" onclick="printReceipt()">üñ®Ô∏è In</button>
                <button class="btn btn-primary" onclick="downloadReceiptPDF()">üìÑ T·∫£i PDF</button>
                <button class="btn btn-secondary" onclick="closeModal('viewReceiptModal')">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <!-- Subject Modal -->
    <div id="subjectModal" class="modal">
        <div class="modal-content modal-sm">
            <div class="modal-header"><h2 id="subjectModalTitle">üìñ Th√™m M√¥n H·ªçc</h2><button class="modal-close" onclick="closeModal('subjectModal')">√ó</button></div>
            <div class="modal-body">
                <form id="subjectForm" onsubmit="saveSubject(event)">
                    <input type="hidden" id="editSubjectId">
                    <div class="form-row">
                        <div class="form-group"><label>Icon *</label><input type="text" id="subjectIcon" required placeholder="VD: ‚ôüÔ∏è"></div>
                        <div class="form-group"><label>T√™n M√¥n *</label><input type="text" id="subjectName" required placeholder="VD: C·ªù Vua"></div>
                    </div>
                    <div class="form-group"><label>H·ªçc Ph√≠ M·∫∑c ƒê·ªãnh *</label><input type="text" id="subjectDefaultFee" required placeholder="VD: 2,000,000" oninput="formatCurrencyInput(this)"></div>
                </form>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" onclick="closeModal('subjectModal')">H·ªßy</button><button type="submit" form="subjectForm" class="btn btn-success">üíæ L∆∞u</button></div>
        </div>
    </div>

    <!-- Package Modal -->
    <div id="packageModal" class="modal">
        <div class="modal-content modal-sm">
            <div class="modal-header"><h2 id="packageModalTitle">üì¶ Th√™m G√≥i H·ªçc Ph√≠</h2><button class="modal-close" onclick="closeModal('packageModal')">√ó</button></div>
            <div class="modal-body">
                <form id="packageForm" onsubmit="savePackage(event)">
                    <input type="hidden" id="editPackageId">
                    <div class="form-group"><label>T√™n G√≥i *</label><input type="text" id="packageName" required placeholder="VD: G√≥i C∆° B·∫£n"></div>
                    <div class="form-row">
                        <div class="form-group"><label>M√¥n H·ªçc *</label><select id="packageSubject" required></select></div>
                        <div class="form-group"><label>S·ªë Bu·ªïi *</label><input type="number" id="packageSessions" required min="1" placeholder="VD: 8"></div>
                    </div>
                    <div class="form-group"><label>H·ªçc Ph√≠ *</label><input type="text" id="packageFee" required placeholder="VD: 1,600,000" oninput="formatCurrencyInput(this)"></div>
                </form>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" onclick="closeModal('packageModal')">H·ªßy</button><button type="submit" form="packageForm" class="btn btn-success">üíæ L∆∞u</button></div>
        </div>
    </div>

    <!-- Promotion Modal -->
    <div id="promotionModal" class="modal">
        <div class="modal-content modal-sm">
            <div class="modal-header"><h2 id="promotionModalTitle">üéÅ Th√™m Khuy·∫øn M√£i</h2><button class="modal-close" onclick="closeModal('promotionModal')">√ó</button></div>
            <div class="modal-body">
                <form id="promotionForm" onsubmit="savePromotion(event)">
                    <input type="hidden" id="editPromotionId">
                    <div class="form-group"><label>T√™n KM *</label><input type="text" id="promotionName" required placeholder="VD: KM Khai Tr∆∞∆°ng"></div>
                    <div class="form-row">
                        <div class="form-group"><label>Lo·∫°i *</label><select id="promotionType" required><option value="percent">Gi·∫£m %</option><option value="fixed">Gi·∫£m VNƒê</option></select></div>
                        <div class="form-group"><label>Gi√° Tr·ªã *</label><input type="number" id="promotionValue" required min="0" placeholder="VD: 10"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>T·ª´ Ng√†y *</label><input type="date" id="promotionStartDate" required></div>
                        <div class="form-group"><label>ƒê·∫øn Ng√†y *</label><input type="date" id="promotionEndDate" required></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" onclick="closeModal('promotionModal')">H·ªßy</button><button type="submit" form="promotionForm" class="btn btn-success">üíæ L∆∞u</button></div>
        </div>
    </div>

    <!-- User Modal (Th√™m/S·ª≠a t√†i kho·∫£n) -->
    <div id="userModal" class="modal">
        <div class="modal-content modal-sm">
            <div class="modal-header"><h2 id="userModalTitle">üë§ Th√™m T√†i Kho·∫£n</h2><button class="modal-close" onclick="closeModal('userModal')">√ó</button></div>
            <div class="modal-body">
                <form id="userForm" onsubmit="saveUser(event)">
                    <input type="hidden" id="editUserId">
                    <div class="form-group">
                        <label>T√™n ƒëƒÉng nh·∫≠p *</label>
                        <input type="text" id="userUsername" required placeholder="VD: nhanvien01" pattern="[a-zA-Z0-9_]+" title="Ch·ªâ ch·ªØ, s·ªë v√† d·∫•u g·∫°ch d∆∞·ªõi">
                    </div>
                    <div class="form-group" id="passwordGroup">
                        <label>M·∫≠t kh·∫©u *</label>
                        <input type="password" id="userPassword" placeholder="T·ªëi thi·ªÉu 6 k√Ω t·ª±" minlength="6">
                    </div>
                    <div class="form-group">
                        <label>H·ªç t√™n *</label>
                        <input type="text" id="userFullName" required placeholder="VD: Nguy·ªÖn VƒÉn A">
                    </div>
                    <div class="form-group">
                        <label>Vai tr√≤ *</label>
                        <select id="userRole" required>
                            <option value="user">User - Ch·ªâ xem</option>
                            <option value="manager">Manager - Qu·∫£n l√Ω</option>
                            <option value="admin">Admin - To√†n quy·ªÅn</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" onclick="closeModal('userModal')">H·ªßy</button><button type="submit" form="userForm" class="btn btn-success">üíæ L∆∞u</button></div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content modal-sm">
            <div class="modal-header"><h2>üîë ƒê·ªïi M·∫≠t Kh·∫©u</h2><button class="modal-close" onclick="closeModal('changePasswordModal')">√ó</button></div>
            <div class="modal-body">
                <form id="changePasswordForm" onsubmit="handleChangePassword(event)">
                    <div class="form-group">
                        <label>M·∫≠t kh·∫©u hi·ªán t·∫°i *</label>
                        <input type="password" id="currentPassword" required placeholder="Nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i">
                    </div>
                    <div class="form-group">
                        <label>M·∫≠t kh·∫©u m·ªõi *</label>
                        <input type="password" id="newPassword" required placeholder="T·ªëi thi·ªÉu 6 k√Ω t·ª±" minlength="6">
                    </div>
                    <div class="form-group">
                        <label>X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi *</label>
                        <input type="password" id="confirmPassword" required placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi">
                    </div>
                </form>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" onclick="closeModal('changePasswordModal')">H·ªßy</button><button type="submit" form="changePasswordForm" class="btn btn-success">üíæ ƒê·ªïi m·∫≠t kh·∫©u</button></div>
        </div>
    </div>

    <!-- Teacher Modal -->
    <div id="teacherModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="teacherModalTitle">üë®‚Äçüè´ Th√™m Gi√°o Vi√™n</h2>
                <button class="modal-close" onclick="closeModal('teacherModal')">√ó</button>
            </div>
            <div class="modal-body">
                <form id="teacherForm" onsubmit="saveTeacher(event)">
                    <input type="hidden" id="editTeacherId">
                    <div class="form-row">
                        <div class="form-group">
                            <label>H·ªç t√™n *</label>
                            <input type="text" id="teacherFullName" required placeholder="VD: Nguy·ªÖn VƒÉn A">
                        </div>
                        <div class="form-group">
                            <label>S·ªë ƒëi·ªán tho·∫°i *</label>
                            <input type="tel" id="teacherPhone" required placeholder="VD: 0901234567">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="teacherEmail" placeholder="VD: email@example.com">
                    </div>
                    <div class="form-group">
                        <label>M√¥n d·∫°y *</label>
                        <div class="checkbox-group" id="teacherSubjectsCheckboxes"></div>
                    </div>
                    <div class="form-group">
                        <label>Lo·∫°i l∆∞∆°ng *</label>
                        <select id="teacherSalaryType" required onchange="toggleSalaryFields()">
                            <option value="per_session">üíµ Theo bu·ªïi d·∫°y</option>
                            <option value="fixed">üí∞ L∆∞∆°ng c·ªë ƒë·ªãnh/th√°ng</option>
                            <option value="both">üí≥ C·∫£ hai (C·ªë ƒë·ªãnh + Theo bu·ªïi)</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group" id="fixedSalaryGroup" style="display: none;">
                            <label>L∆∞∆°ng c·ªë ƒë·ªãnh/th√°ng</label>
                            <input type="text" id="teacherFixedSalary" placeholder="VD: 5,000,000" oninput="formatCurrencyInput(this)">
                        </div>
                        <div class="form-group" id="perSessionGroup">
                            <label>Ti·ªÅn/bu·ªïi d·∫°y</label>
                            <input type="text" id="teacherPerSession" placeholder="VD: 200,000" oninput="formatCurrencyInput(this)">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Ghi ch√∫</label>
                        <textarea id="teacherNotes" rows="2" placeholder="Ghi ch√∫ th√™m..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('teacherModal')">H·ªßy</button>
                <button type="submit" form="teacherForm" class="btn btn-success">üíæ L∆∞u</button>
            </div>
        </div>
    </div>

    <!-- View Teacher Modal -->
    <div id="viewTeacherModal" class="modal">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h2>üë®‚Äçüè´ Chi ti·∫øt Gi√°o vi√™n</h2>
                <button class="modal-close" onclick="closeModal('viewTeacherModal')">√ó</button>
            </div>
            <div class="modal-body" id="viewTeacherContent"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('viewTeacherModal')">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <!-- Class Modal -->
    <div id="classModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="classModalTitle">üìö Th√™m L·ªõp H·ªçc</h2>
                <button class="modal-close" onclick="closeModal('classModal')">√ó</button>
            </div>
            <div class="modal-body">
                <form id="classForm" onsubmit="saveClass(event)">
                    <input type="hidden" id="editClassId">
                    <div class="form-group">
                        <label>T√™n l·ªõp *</label>
                        <input type="text" id="className" required placeholder="VD: C·ªù Vua - L·ªõp A1">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>M√¥n h·ªçc *</label>
                            <select id="classSubject" required onchange="filterTeachersBySubject()">
                                <option value="">-- Ch·ªçn m√¥n h·ªçc --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Gi√°o vi√™n</label>
                            <select id="classTeacher">
                                <option value="">-- Ch·ªçn gi√°o vi√™n --</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Lo·∫°i l·ªõp *</label>
                            <select id="classType" required onchange="toggleMaxStudents()">
                                <option value="group">üë• L·ªõp nh√≥m</option>
                                <option value="1on1">üë§ 1 k√®m 1</option>
                            </select>
                        </div>
                        <div class="form-group" id="maxStudentsGroup">
                            <label>Sƒ© s·ªë t·ªëi ƒëa *</label>
                            <input type="number" id="classMaxStudents" required min="1" max="30" value="10">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Tr·∫°ng th√°i</label>
                        <select id="classStatus">
                            <option value="new">üÜï L·ªõp m·ªõi</option>
                            <option value="active">üü¢ ƒêang h·ªçc</option>
                            <option value="completed">‚úÖ Ho√†n th√†nh</option>
                            <option value="cancelled">‚ùå ƒê√£ h·ªßy</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ghi ch√∫</label>
                        <textarea id="classNotes" rows="2" placeholder="Ghi ch√∫ th√™m..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('classModal')">H·ªßy</button>
                <button type="submit" form="classForm" class="btn btn-success">üíæ L∆∞u</button>
            </div>
        </div>
    </div>

    <!-- View Class Modal -->
    <div id="viewClassModal" class="modal">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h2>üìö Chi ti·∫øt L·ªõp h·ªçc</h2>
                <button class="modal-close" onclick="closeModal('viewClassModal')">√ó</button>
            </div>
            <div class="modal-body" id="viewClassContent"></div>
            <div class="modal-footer">
                <button class="btn btn-info" onclick="openScheduleModal()">üìÖ Th√™m ca h·ªçc</button>
                <button class="btn btn-success" onclick="openAssignStudentModal()">üë§ Th√™m h·ªçc vi√™n</button>
                <button class="btn btn-secondary" onclick="closeModal('viewClassModal')">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <!-- Schedule Modal (Th√™m ca h·ªçc) -->
    <div id="scheduleModal" class="modal">
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h2>üìÖ Th√™m Ca H·ªçc</h2>
                <button class="modal-close" onclick="closeModal('scheduleModal')">√ó</button>
            </div>
            <div class="modal-body">
                <form id="scheduleForm" onsubmit="saveSchedule(event)">
                    <input type="hidden" id="scheduleClassId">
                    <input type="hidden" id="editScheduleId">
                    <div class="form-group">
                        <label>Ng√†y trong tu·∫ßn *</label>
                        <select id="scheduleDayOfWeek" required>
                            <option value="1">Th·ª© 2</option>
                            <option value="2">Th·ª© 3</option>
                            <option value="3">Th·ª© 4</option>
                            <option value="4">Th·ª© 5</option>
                            <option value="5">Th·ª© 6</option>
                            <option value="6">Th·ª© 7</option>
                            <option value="7">Ch·ªß nh·∫≠t</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Gi·ªù b·∫Øt ƒë·∫ßu *</label>
                            <input type="time" id="scheduleStartTime" required value="08:30">
                        </div>
                        <div class="form-group">
                            <label>Gi·ªù k·∫øt th√∫c *</label>
                            <input type="time" id="scheduleEndTime" required value="10:00">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Ph√≤ng h·ªçc</label>
                        <input type="text" id="scheduleRoom" placeholder="VD: Ph√≤ng A1">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('scheduleModal')">H·ªßy</button>
                <button type="submit" form="scheduleForm" class="btn btn-success">üíæ L∆∞u</button>
            </div>
        </div>
    </div>

    <!-- View Attendance Detail Modal -->
    <div id="viewAttendanceModal" class="modal">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h2>üìã Chi ti·∫øt ƒëi·ªÉm danh</h2>
                <button class="modal-close" onclick="closeModal('viewAttendanceModal')">√ó</button>
            </div>
            <div class="modal-body" id="viewAttendanceContent"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('viewAttendanceModal')">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <!-- Schedule Makeup Modal -->
    <div id="scheduleMakeupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìÖ X·∫øp l·ªãch h·ªçc b√π</h2>
                <button class="modal-close" onclick="closeModal('scheduleMakeupModal')">√ó</button>
            </div>
            <div class="modal-body">
                <form id="scheduleMakeupForm" onsubmit="saveMakeupSchedule(event)">
                    <input type="hidden" id="makeupRequestId">
                    
                    <div class="quick-view-section">
                        <h4>üìã Th√¥ng tin y√™u c·∫ßu</h4>
                        <div class="quick-view-row">
                            <span class="quick-view-label">H·ªçc vi√™n:</span>
                            <span class="quick-view-value" id="makeupStudentName"></span>
                        </div>
                        <div class="quick-view-row">
                            <span class="quick-view-label">L·ªõp g·ªëc:</span>
                            <span class="quick-view-value" id="makeupOriginalClass"></span>
                        </div>
                        <div class="quick-view-row">
                            <span class="quick-view-label">Ng√†y ngh·ªâ:</span>
                            <span class="quick-view-value" id="makeupOriginalDate"></span>
                        </div>
                        <div class="quick-view-row">
                            <span class="quick-view-label">H·∫°n h·ªçc b√π:</span>
                            <span class="quick-view-value" id="makeupExpiryDate"></span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Ch·ªçn l·ªõp h·ªçc b√π *</label>
                        <select id="makeupClassSelect" required onchange="loadMakeupSchedules()">
                            <option value="">-- Ch·ªçn l·ªõp --</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Ch·ªçn ng√†y h·ªçc b√π *</label>
                        <input type="date" id="makeupDate" required onchange="loadMakeupSchedules()">
                    </div>
                    
                    <div class="form-group">
                        <label>Ch·ªçn ca h·ªçc *</label>
                        <select id="makeupScheduleSelect" required>
                            <option value="">-- Ch·ªçn ca h·ªçc --</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Ghi ch√∫</label>
                        <textarea id="makeupNotes" rows="2" placeholder="Ghi ch√∫ th√™m..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('scheduleMakeupModal')">H·ªßy</button>
                <button type="submit" form="scheduleMakeupForm" class="btn btn-success">üìÖ X·∫øp l·ªãch</button>
            </div>
        </div>
    </div>

    <!-- Create Makeup Request Modal -->
    <div id="createMakeupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ûï T·∫°o Y√™u C·∫ßu H·ªçc B√π</h2>
                <button class="modal-close" onclick="closeModal('createMakeupModal')">√ó</button>
            </div>
            <div class="modal-body">
                <form id="createMakeupForm" onsubmit="saveNewMakeupRequest(event)">
                    <div class="form-group">
                        <label>Ch·ªçn l·ªõp *</label>
                        <select id="newMakeupClassSelect" required onchange="loadStudentsForMakeup()">
                            <option value="">-- Ch·ªçn l·ªõp h·ªçc --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ch·ªçn h·ªçc vi√™n *</label>
                        <select id="newMakeupStudentSelect" required>
                            <option value="">-- Ch·ªçn h·ªçc vi√™n --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ng√†y d·ª± ki·∫øn ngh·ªâ *</label>
                        <input type="date" id="newMakeupAbsentDate" required>
                    </div>
                    <div class="form-group">
                        <label>L√Ω do ngh·ªâ</label>
                        <textarea id="newMakeupReason" rows="2" placeholder="VD: B·∫≠n vi·ªác gia ƒë√¨nh, ƒëi du l·ªãch..."></textarea>
                    </div>
                    <div style="background: #FEF9E7; padding: 12px; border-radius: 8px; margin-top: 15px;">
                        <p style="margin: 0; color: #9A7B0A; font-size: 13px;">
                            ‚ö†Ô∏è <strong>L∆∞u √Ω:</strong> Y√™u c·∫ßu h·ªçc b√π n√†y s·∫Ω ƒë∆∞·ª£c t·∫°o tr∆∞·ªõc. Khi ƒë·∫øn ng√†y ngh·ªâ, anh/ch·ªã v·∫´n c·∫ßn ƒëi·ªÉm danh "C√≥ ph√©p" ƒë·ªÉ tr·ª´ bu·ªïi ch√≠nh th·ª©c.
                        </p>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('createMakeupModal')">H·ªßy</button>
                <button type="submit" form="createMakeupForm" class="btn btn-success">‚ûï T·∫°o y√™u c·∫ßu</button>
            </div>
        </div>
    </div>


    <!-- Confirm Makeup Completed Modal -->
    <div id="confirmMakeupModal" class="modal">
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h2>‚úÖ X√°c nh·∫≠n h·ªçc b√π</h2>
                <button class="modal-close" onclick="closeModal('confirmMakeupModal')">√ó</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="confirmMakeupId">
                <div class="quick-view-section">
                    <p>X√°c nh·∫≠n h·ªçc vi√™n <strong id="confirmMakeupStudent"></strong> ƒë√£ ho√†n th√†nh bu·ªïi h·ªçc b√π?</p>
                    <div class="quick-view-row">
                        <span class="quick-view-label">L·ªõp h·ªçc b√π:</span>
                        <span class="quick-view-value" id="confirmMakeupClass"></span>
                    </div>
                    <div class="quick-view-row">
                        <span class="quick-view-label">Ng√†y h·ªçc b√π:</span>
                        <span class="quick-view-value" id="confirmMakeupDate"></span>
                    </div>
                </div>
                <div style="background: #E8F8F0; padding: 12px; border-radius: 8px; margin-top: 15px;">
                    <p style="margin: 0; color: #27AE60; font-size: 13px;">
                        ‚úÖ Sau khi x√°c nh·∫≠n, bu·ªïi h·ªçc b√π s·∫Ω ƒë∆∞·ª£c ghi nh·∫≠n. S·ªë bu·ªïi c√≤n l·∫°i c·ªßa h·ªçc vi√™n s·∫Ω <strong>KH√îNG b·ªã tr·ª´</strong>.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('confirmMakeupModal')">H·ªßy</button>
                <button type="button" class="btn btn-success" onclick="completeMakeupRequest()">‚úÖ X√°c nh·∫≠n ho√†n th√†nh</button>
            </div>
        </div>
    </div>


    <!-- Assign Student to Class Modal -->
    <div id="assignStudentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üë§ Th√™m H·ªçc Vi√™n V√†o L·ªõp</h2>
                <button class="modal-close" onclick="closeModal('assignStudentModal')">√ó</button>
            </div>
            <div class="modal-body">
                <form id="assignStudentForm" onsubmit="assignStudentToClass(event)">
                    <input type="hidden" id="assignClassId">
                    <div class="form-group">
                        <label>Ch·ªçn Phi·∫øu ƒëƒÉng k√Ω *</label>
                        <select id="assignRegistrationId" required onchange="showRegistrationInfo()">
                            <option value="">-- Ch·ªçn phi·∫øu ƒêK ch∆∞a g√°n l·ªõp --</option>
                        </select>
                    </div>
                    <div id="assignRegistrationInfo" style="display: none;">
                        <div class="quick-view-section">
                            <h4>üìã Th√¥ng tin Phi·∫øu ƒêK</h4>
                            <div class="quick-view-row">
                                <span class="quick-view-label">H·ªçc vi√™n:</span>
                                <span class="quick-view-value" id="assignStudentName"></span>
                            </div>
                            <div class="quick-view-row">
                                <span class="quick-view-label">M√¥n h·ªçc:</span>
                                <span class="quick-view-value" id="assignSubject"></span>
                            </div>
                            <div class="quick-view-row">
                                <span class="quick-view-label">S·ªë bu·ªïi:</span>
                                <span class="quick-view-value" id="assignTotalSessions"></span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('assignStudentModal')">H·ªßy</button>
                <button type="submit" form="assignStudentForm" class="btn btn-success">‚úÖ G√°n v√†o l·ªõp</button>
            </div>
        </div>
    </div>


    <!-- Reset Password Modal (Admin reset cho user) -->
    <div id="resetPasswordModal" class="modal">
        <div class="modal-content modal-sm">
            <div class="modal-header"><h2>üîÑ Reset M·∫≠t Kh·∫©u</h2><button class="modal-close" onclick="closeModal('resetPasswordModal')">√ó</button></div>
            <div class="modal-body">
                <form id="resetPasswordForm" onsubmit="handleResetPassword(event)">
                    <input type="hidden" id="resetPasswordUserId">
                    <p class="mb-15">Reset m·∫≠t kh·∫©u cho t√†i kho·∫£n: <strong id="resetPasswordUsername"></strong></p>
                    <div class="form-group">
                        <label>M·∫≠t kh·∫©u m·ªõi *</label>
                        <input type="password" id="resetNewPassword" required placeholder="T·ªëi thi·ªÉu 6 k√Ω t·ª±" minlength="6">
                    </div>
                </form>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" onclick="closeModal('resetPasswordModal')">H·ªßy</button><button type="submit" form="resetPasswordForm" class="btn btn-warning">üîÑ Reset</button></div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <!-- ============================================================
         üìú JAVASCRIPT - PH·∫¶N 2/2
         ============================================================ -->
    <script>
/* ============================================================
   üìä PH·∫¶N 1: DATA & CONFIG
   ============================================================ */

// ===== 1.1 C·∫•u h√¨nh h·ªá th·ªëng =====
const CONFIG = {
    APP_NAME: 'Qu·∫£n L√Ω Trung T√¢m',
    VERSION: '4.0',
    SESSION_TIMEOUT: 480, // ph√∫t (8 gi·ªù)
    MAX_LOGIN_ATTEMPTS: 5,
    LOCKOUT_DURATION: 15, // ph√∫t
    PAGE_SIZE_OPTIONS: [10, 20, 50, 100],
    DEFAULT_PAGE_SIZE: 10
};

// ===== 1.2 C·∫•u tr√∫c menu v·ªõi quy·ªÅn =====
const MENU_STRUCTURE = [
    { id: 'dashboard', icon: 'üìä', text: 'T·ªïng quan', parent: null },
    { id: 'students-group', icon: 'üë•', text: 'Qu·∫£n l√Ω H·ªçc vi√™n', parent: null, isGroup: true },
    { id: 'students', icon: 'üë©‚Äçüéì', text: 'Danh s√°ch HV', parent: 'students-group' },
    { id: 'trial', icon: 'üéì', text: 'H·ªçc th·ª≠', parent: 'students-group' },
    { id: 'appointments', icon: 'üìÖ', text: 'L·ªãch h·∫πn', parent: 'students-group' },
    { id: 'finance-group', icon: 'üí∞', text: 'T√†i ch√≠nh', parent: null, isGroup: true },
    { id: 'registrations', icon: 'üìã', text: 'Phi·∫øu ƒëƒÉng k√Ω', parent: 'finance-group' },
    { id: 'receipts', icon: 'üßæ', text: 'Bi√™n lai', parent: 'finance-group' },
    { id: 'debts', icon: 'üí≥', text: 'C√¥ng n·ª£', parent: 'finance-group' },
    { id: 'training-group', icon: 'üè´', text: 'ƒê√†o t·∫°o', parent: null, isGroup: true },
    { id: 'teachers', icon: 'üë®‚Äçüè´', text: 'Gi√°o vi√™n', parent: 'training-group' },
    { id: 'classes', icon: 'üìö', text: 'L·ªõp h·ªçc', parent: 'training-group' },
    { id: 'makeup', icon: 'üìù', text: 'H·ªçc b√π', parent: 'training-group' },
    { id: 'attendance', icon: '‚úÖ', text: 'ƒêi·ªÉm danh', parent: 'training-group' },
    { id: 'category-group', icon: 'üìÅ', text: 'Danh m·ª•c', parent: null, isGroup: true },
    { id: 'subjects', icon: 'üìñ', text: 'M√¥n h·ªçc', parent: 'category-group' },
    { id: 'packages', icon: 'üì¶', text: 'G√≥i h·ªçc ph√≠', parent: 'category-group' },
    { id: 'promotions', icon: 'üéÅ', text: 'Khuy·∫øn m√£i', parent: 'category-group' },
    { id: 'reports', icon: 'üìà', text: 'B√°o c√°o', parent: null },
    { id: 'system-group', icon: '‚öôÔ∏è', text: 'H·ªá th·ªëng', parent: null, isGroup: true },
    { id: 'export', icon: 'üì§', text: 'Xu·∫•t/Nh·∫≠p data', parent: 'system-group' },
    { id: 'users', icon: 'üîê', text: 'T√†i kho·∫£n', parent: 'system-group' },
    { id: 'settings', icon: '‚öôÔ∏è', text: 'C√†i ƒë·∫∑t', parent: 'system-group' }
];

// ===== 1.3 Quy·ªÅn m·∫∑c ƒë·ªãnh cho t·ª´ng vai tr√≤ =====
const DEFAULT_PERMISSIONS = {
    admin: {
        dashboard: { view: true, create: true, edit: true, delete: true },
        students: { view: true, create: true, edit: true, delete: true },
        trial: { view: true, create: true, edit: true, delete: true },
        appointments: { view: true, create: true, edit: true, delete: true },
        registrations: { view: true, create: true, edit: true, delete: true },
        receipts: { view: true, create: true, edit: true, delete: true },
        debts: { view: true, create: true, edit: true, delete: true },
        teachers: { view: true, create: true, edit: true, delete: true },
        classes: { view: true, create: true, edit: true, delete: true },
        attendance: { view: true, create: true, edit: true, delete: true },
        makeup: { view: true, create: true, edit: true, delete: true },
        subjects: { view: true, create: true, edit: true, delete: true },
        packages: { view: true, create: true, edit: true, delete: true },
        promotions: { view: true, create: true, edit: true, delete: true },
        reports: { view: true, create: true, edit: true, delete: true },
        export: { view: true, create: true, edit: true, delete: true },
        users: { view: true, create: true, edit: true, delete: true },
        settings: { view: true, create: true, edit: true, delete: true }
    },
    manager: {
        dashboard: { view: true, create: false, edit: false, delete: false },
        students: { view: true, create: true, edit: true, delete: false },
        trial: { view: true, create: true, edit: true, delete: false },
        appointments: { view: true, create: true, edit: true, delete: true },
        registrations: { view: true, create: true, edit: true, delete: false },
        receipts: { view: true, create: true, edit: true, delete: false },
        debts: { view: true, create: false, edit: false, delete: false },
        teachers: { view: true, create: false, edit: false, delete: false },
        classes: { view: true, create: false, edit: false, delete: false },
        attendance: { view: true, create: true, edit: true, delete: false },
        makeup: { view: true, create: true, edit: true, delete: true },
        subjects: { view: true, create: false, edit: false, delete: false },
        packages: { view: true, create: false, edit: false, delete: false },
        promotions: { view: true, create: false, edit: false, delete: false },
        reports: { view: true, create: false, edit: false, delete: false },
        export: { view: true, create: true, edit: false, delete: false },
        users: { view: false, create: false, edit: false, delete: false },
        settings: { view: false, create: false, edit: false, delete: false }
    },
    user: {
        dashboard: { view: true, create: false, edit: false, delete: false },
        students: { view: true, create: false, edit: false, delete: false },
        trial: { view: true, create: false, edit: false, delete: false },
        appointments: { view: true, create: false, edit: false, delete: false },
        registrations: { view: true, create: false, edit: false, delete: false },
        receipts: { view: true, create: false, edit: false, delete: false },
        debts: { view: true, create: false, edit: false, delete: false },
        teachers: { view: true, create: false, edit: false, delete: false },
        classes: { view: true, create: false, edit: false, delete: false },
        attendance: { view: true, create: false, edit: false, delete: false },
        makeup: { view: true, create: true, edit: true, delete: true },
        subjects: { view: true, create: false, edit: false, delete: false },
        packages: { view: true, create: false, edit: false, delete: false },
        promotions: { view: true, create: false, edit: false, delete: false },
        reports: { view: true, create: false, edit: false, delete: false },
        export: { view: false, create: false, edit: false, delete: false },
        users: { view: false, create: false, edit: false, delete: false },
        settings: { view: false, create: false, edit: false, delete: false }
    }
};

// ===== 1.4 T√†i kho·∫£n m·∫∑c ƒë·ªãnh =====
const DEFAULT_USERS = [
    {
        id: 'user_admin',
        username: 'admin',
        passwordHash: hashPassword('admin123'),
        fullName: 'Qu·∫£n tr·ªã vi√™n',
        role: 'admin',
        status: 'active',
        createdAt: new Date().toISOString(),
        lastLogin: null
    },
    {
        id: 'user_manager',
        username: 'manager',
        passwordHash: hashPassword('manager123'),
        fullName: 'Qu·∫£n l√Ω',
        role: 'manager',
        status: 'active',
        createdAt: new Date().toISOString(),
        lastLogin: null
    },
    {
        id: 'user_user',
        username: 'user',
        passwordHash: hashPassword('user123'),
        fullName: 'Nh√¢n vi√™n',
        role: 'user',
        status: 'active',
        createdAt: new Date().toISOString(),
        lastLogin: null
    }
];

// ===== 1.5 Kh·ªüi t·∫°o d·ªØ li·ªáu t·ª´ LocalStorage =====
let users = JSON.parse(localStorage.getItem('users')) || [];
let permissions = JSON.parse(localStorage.getItem('permissions')) || {};
let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
let loginAttempts = JSON.parse(localStorage.getItem('loginAttempts')) || {};

let students = JSON.parse(localStorage.getItem('students')) || [];
let appointments = JSON.parse(localStorage.getItem('appointments')) || [];
let receipts = JSON.parse(localStorage.getItem('receipts')) || [];
let registrations = JSON.parse(localStorage.getItem('registrations')) || [];
let subjects = JSON.parse(localStorage.getItem('subjects')) || [
    { id: '1', icon: '‚ôüÔ∏è', name: 'C·ªù Vua', defaultFee: 2000000 },
    { id: '2', icon: 'üé®', name: 'V·∫Ω Tranh', defaultFee: 1800000 },
    { id: '3', icon: 'üìö', name: 'Ti·ªÅn Ti·ªÉu H·ªçc', defaultFee: 1500000 },
    { id: '4', icon: '‚úçÔ∏è', name: 'R√®n Ch·ªØ', defaultFee: 1600000 }
];
let packages = JSON.parse(localStorage.getItem('packages')) || [];
let promotions = JSON.parse(localStorage.getItem('promotions')) || [];
let centerInfo = JSON.parse(localStorage.getItem('centerInfo')) || {};
let bankInfo = JSON.parse(localStorage.getItem('bankInfo')) || {};
let backupHistory = JSON.parse(localStorage.getItem('backupHistory')) || [];
let teachers = JSON.parse(localStorage.getItem('teachers')) || [];
let classes = JSON.parse(localStorage.getItem('classes')) || [];
let classSchedules = JSON.parse(localStorage.getItem('classSchedules')) || [];
let classStudents = JSON.parse(localStorage.getItem('classStudents')) || [];
let attendances = JSON.parse(localStorage.getItem('attendances')) || [];
let makeupRequests = JSON.parse(localStorage.getItem('makeupRequests')) || [];
let autoBackupEnabled = localStorage.getItem('autoBackupEnabled') === 'true';

// ===== 1.6 State qu·∫£n l√Ω =====
let paginationState = {
    students: { page: 1, pageSize: 10 },
    trial: { page: 1, pageSize: 10 },
    appointments: { page: 1, pageSize: 10 },
    registrations: { page: 1, pageSize: 10 },
    receipts: { page: 1, pageSize: 10 }
};

let currentFilter = 'all';
let currentTrialFilter = 'all';
let currentAppointmentFilter = 'all';

/* ============================================================
   üîê PH·∫¶N 2: AUTHENTICATION (X√°c th·ª±c)
   ============================================================ */

// ===== 2.1 Hash password ƒë∆°n gi·∫£n =====
function hashPassword(password) {
    // Simple hash cho offline - kh√¥ng b·∫£o m·∫≠t cao nh∆∞ng t·ªët h∆°n plain text
    let hash = 0;
    const str = password + 'fz_salt_2025';
    for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
    }
    return 'fz_' + Math.abs(hash).toString(16);
}

// ===== 2.2 Ki·ªÉm tra password =====
function verifyPassword(password, hash) {
    return hashPassword(password) === hash;
}

// ===== 2.3 Kh·ªüi t·∫°o users m·∫∑c ƒë·ªãnh =====
function initializeDefaultUsers() {
    if (users.length === 0) {
        users = [...DEFAULT_USERS];
        saveData('users', users);
    }
    
    // Kh·ªüi t·∫°o permissions n·∫øu ch∆∞a c√≥
    if (Object.keys(permissions).length === 0) {
        permissions = JSON.parse(JSON.stringify(DEFAULT_PERMISSIONS));
        saveData('permissions', permissions);
    }
}

// ===== 2.4 Ki·ªÉm tra kh√≥a t√†i kho·∫£n =====
function isAccountLocked(username) {
    const attempts = loginAttempts[username];
    if (!attempts) return false;
    
    if (attempts.count >= CONFIG.MAX_LOGIN_ATTEMPTS) {
        const lockoutEnd = new Date(attempts.lastAttempt).getTime() + (CONFIG.LOCKOUT_DURATION * 60 * 1000);
        if (Date.now() < lockoutEnd) {
            return true;
        } else {
            // Reset sau khi h·∫øt th·ªùi gian kh√≥a
            delete loginAttempts[username];
            saveData('loginAttempts', loginAttempts);
            return false;
        }
    }
    return false;
}

// ===== 2.5 Ghi nh·∫≠n l·∫ßn ƒëƒÉng nh·∫≠p sai =====
function recordFailedLogin(username) {
    if (!loginAttempts[username]) {
        loginAttempts[username] = { count: 0, lastAttempt: null };
    }
    loginAttempts[username].count++;
    loginAttempts[username].lastAttempt = new Date().toISOString();
    saveData('loginAttempts', loginAttempts);
}

// ===== 2.6 Reset ƒë·∫øm ƒëƒÉng nh·∫≠p sai =====
function resetLoginAttempts(username) {
    delete loginAttempts[username];
    saveData('loginAttempts', loginAttempts);
}

// ===== 2.7 X·ª≠ l√Ω ƒëƒÉng nh·∫≠p =====
function handleLogin(event) {
    event.preventDefault();
    
    const username = document.getElementById('loginUsername').value.trim().toLowerCase();
    const password = document.getElementById('loginPassword').value;
    const rememberMe = document.getElementById('rememberMe').checked;
    
    // Reset error
    hideLoginError();
    
    // Ki·ªÉm tra t√†i kho·∫£n b·ªã kh√≥a
    if (isAccountLocked(username)) {
        showLoginError(`T√†i kho·∫£n b·ªã kh√≥a t·∫°m th·ªùi. Vui l√≤ng th·ª≠ l·∫°i sau ${CONFIG.LOCKOUT_DURATION} ph√∫t.`);
        return;
    }
    
    // T√¨m user
    const user = users.find(u => u.username.toLowerCase() === username);
    
    if (!user) {
        recordFailedLogin(username);
        showLoginError('T√™n ƒëƒÉng nh·∫≠p kh√¥ng t·ªìn t·∫°i!');
        return;
    }
    
    // Ki·ªÉm tra tr·∫°ng th√°i
    if (user.status === 'locked') {
        showLoginError('T√†i kho·∫£n ƒë√£ b·ªã kh√≥a. Li√™n h·ªá Admin!');
        return;
    }
    
    // Ki·ªÉm tra password
    if (!verifyPassword(password, user.passwordHash)) {
        recordFailedLogin(username);
        const remaining = CONFIG.MAX_LOGIN_ATTEMPTS - (loginAttempts[username]?.count || 0);
        showLoginError(`Sai m·∫≠t kh·∫©u! C√≤n ${remaining} l·∫ßn th·ª≠.`);
        return;
    }
    
    // ƒêƒÉng nh·∫≠p th√†nh c√¥ng
    resetLoginAttempts(username);
    
    // C·∫≠p nh·∫≠t lastLogin
    user.lastLogin = new Date().toISOString();
    saveData('users', users);
    
    // L∆∞u session
    currentUser = {
        id: user.id,
        username: user.username,
        fullName: user.fullName,
        role: user.role,
        loginTime: new Date().toISOString()
    };
    
    if (rememberMe) {
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
    } else {
        sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
    }
    
    // Chuy·ªÉn v√†o ·ª©ng d·ª•ng
    showApp();
    showNotification(`Ch√†o m·ª´ng ${user.fullName}!`, 'success');
}

// ===== 2.8 ƒêƒÉng xu·∫•t =====
function handleLogout() {
    if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) return;
    
    currentUser = null;
    localStorage.removeItem('currentUser');
    sessionStorage.removeItem('currentUser');
    
    hideApp();
    showNotification('ƒê√£ ƒëƒÉng xu·∫•t!', 'info');
}

// ===== 2.9 Ki·ªÉm tra session =====
function checkAuth() {
    // Ki·ªÉm tra c·∫£ localStorage v√† sessionStorage
    const savedUser = localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser');
    
    if (savedUser) {
        currentUser = JSON.parse(savedUser);
        
        // Ki·ªÉm tra session timeout
        const loginTime = new Date(currentUser.loginTime).getTime();
        const now = Date.now();
        const timeoutMs = CONFIG.SESSION_TIMEOUT * 60 * 1000;
        
        if (now - loginTime > timeoutMs) {
            // Session h·∫øt h·∫°n
            handleLogout();
            showNotification('Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!', 'warning');
            return false;
        }
        
        return true;
    }
    
    return false;
}

// ===== 2.10 Hi·ªán/·∫®n m√†n h√¨nh =====
function showApp() {
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('appContainer').classList.add('show');
    
    // C·∫≠p nh·∫≠t UI theo user
    updateUserUI();
    
    // Render menu theo quy·ªÅn
    renderSidebarMenu();
    
    // Render n·ªôi dung
    renderAll();
}

function hideApp() {
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('appContainer').classList.remove('show');
    
    // Reset form login
    document.getElementById('loginForm').reset();
    hideLoginError();
}

// ===== 2.11 C·∫≠p nh·∫≠t UI user =====
function updateUserUI() {
    if (!currentUser) return;
    
    const avatar = currentUser.fullName.charAt(0).toUpperCase();
    document.getElementById('userAvatar').textContent = avatar;
    document.getElementById('userName').textContent = currentUser.fullName;
    document.getElementById('userRoleBadge').textContent = getRoleLabel(currentUser.role);
    document.getElementById('userMenuName').textContent = currentUser.fullName;
    document.getElementById('userMenuRole').textContent = getRoleLabel(currentUser.role);
}

function getRoleLabel(role) {
    const labels = { admin: 'Admin', manager: 'Manager', user: 'User' };
    return labels[role] || role;
}

// ===== 2.12 Hi·ªán/·∫®n l·ªói ƒëƒÉng nh·∫≠p =====
function showLoginError(message) {
    const errorDiv = document.getElementById('loginError');
    document.getElementById('loginErrorText').textContent = message;
    errorDiv.classList.add('show');
}

function hideLoginError() {
    document.getElementById('loginError').classList.remove('show');
}

// ===== 2.13 Toggle hi·ªán password =====
function togglePasswordVisibility() {
    const input = document.getElementById('loginPassword');
    const btn = document.querySelector('.password-toggle');
    if (input.type === 'password') {
        input.type = 'text';
        btn.textContent = 'üôà';
    } else {
        input.type = 'password';
        btn.textContent = 'üëÅÔ∏è';
    }
}

/* ============================================================
   üîë PH·∫¶N 3: PERMISSIONS (Ph√¢n quy·ªÅn)
   ============================================================ */

// ===== 3.1 Ki·ªÉm tra quy·ªÅn =====
function hasPermission(tabId, action = 'view') {
    if (!currentUser) return false;
    
    const role = currentUser.role;
    const rolePermissions = permissions[role];
    
    if (!rolePermissions || !rolePermissions[tabId]) {
        // Fallback to default
        return DEFAULT_PERMISSIONS[role]?.[tabId]?.[action] || false;
    }
    
    return rolePermissions[tabId][action] || false;
}

// ===== 3.2 Ki·ªÉm tra c√≥ th·ªÉ xem tab =====
function canViewTab(tabId) {
    return hasPermission(tabId, 'view');
}

// ===== 3.3 Ki·ªÉm tra c√≥ th·ªÉ t·∫°o =====
function canCreate(tabId) {
    return hasPermission(tabId, 'create');
}

// ===== 3.4 Ki·ªÉm tra c√≥ th·ªÉ s·ª≠a =====
function canEdit(tabId) {
    return hasPermission(tabId, 'edit');
}

// ===== 3.5 Ki·ªÉm tra c√≥ th·ªÉ x√≥a =====
function canDelete(tabId) {
    return hasPermission(tabId, 'delete');
}

// ===== 3.6 Render sidebar menu theo quy·ªÅn =====
function renderSidebarMenu() {
    const nav = document.getElementById('sidebarNav');
    let html = '';
    
    // L·ªçc menu items c√≥ quy·ªÅn xem
    const visibleItems = MENU_STRUCTURE.filter(item => {
        if (item.isGroup) {
            // Group hi·ªÉn th·ªã n·∫øu c√≥ √≠t nh·∫•t 1 child visible
            const children = MENU_STRUCTURE.filter(m => m.parent === item.id);
            return children.some(child => canViewTab(child.id));
        }
        if (item.parent) {
            // Child item
            return canViewTab(item.id);
        }
        // Top-level item (kh√¥ng ph·∫£i group)
        return canViewTab(item.id);
    });
    
    // Render menu
    visibleItems.forEach(item => {
        if (item.isGroup) {
            // Render group v·ªõi children
            const children = MENU_STRUCTURE.filter(m => m.parent === item.id && canViewTab(m.id));
            if (children.length > 0) {
                html += `
                    <div class="nav-item">
                        <a class="nav-link has-submenu" onclick="toggleSubmenu(this)">
                            <span class="nav-icon">${item.icon}</span>
                            <span class="nav-text">${item.text}</span>
                            <span class="nav-arrow">‚ñ∂</span>
                        </a>
                        <div class="nav-submenu">
                            ${children.map(child => `
                                <a class="nav-link" data-tab="${child.id}" onclick="switchTab('${child.id}')">
                                    <span class="nav-text">${child.text}</span>
                                </a>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        } else if (!item.parent) {
            // Top-level item (kh√¥ng c√≥ parent)
            html += `
                <div class="nav-item">
                    <a class="nav-link ${item.id === 'dashboard' ? 'active' : ''}" data-tab="${item.id}" onclick="switchTab('${item.id}')">
                        <span class="nav-icon">${item.icon}</span>
                        <span class="nav-text">${item.text}</span>
                    </a>
                </div>
            `;
        }
    });
    
    nav.innerHTML = html;
}

// ===== 3.7 ·∫®n/Hi·ªán n√∫t thao t√°c theo quy·ªÅn =====
function updateActionButtons() {
    // Students actions
    const studentsActions = document.getElementById('studentsActions');
    if (studentsActions) {
        const addBtn = studentsActions.querySelector('.btn-success');
        if (addBtn) addBtn.style.display = canCreate('students') ? '' : 'none';
    }
    
    // Appointments actions
    const appointmentsActions = document.getElementById('appointmentsActions');
    if (appointmentsActions) {
        const addBtn = appointmentsActions.querySelector('.btn-success');
        if (addBtn) addBtn.style.display = canCreate('appointments') ? '' : 'none';
    }
    
    // Registrations actions
    const registrationsActions = document.getElementById('registrationsActions');
    if (registrationsActions) {
        const addBtn = registrationsActions.querySelector('.btn-success');
        if (addBtn) addBtn.style.display = canCreate('registrations') ? '' : 'none';
    }
    
    // Receipts actions
    const receiptsActions = document.getElementById('receiptsActions');
    if (receiptsActions) {
        const addBtn = receiptsActions.querySelector('.btn-success');
        if (addBtn) addBtn.style.display = canCreate('receipts') ? '' : 'none';
    }
    
    // Subjects, Packages, Promotions actions
    ['subjects', 'packages', 'promotions'].forEach(tab => {
        const actions = document.getElementById(`${tab}Actions`);
        if (actions) {
            const addBtn = actions.querySelector('.btn-success');
            if (addBtn) addBtn.style.display = canCreate(tab) ? '' : 'none';
        }
    });
}

// ===== 3.8 Render ma tr·∫≠n ph√¢n quy·ªÅn =====
function renderPermissionMatrix() {
    const role = document.getElementById('permissionRoleSelect').value;
    const rolePerms = permissions[role] || DEFAULT_PERMISSIONS[role];
    
    const tabs = [
        { id: 'dashboard', name: 'üìä T·ªïng quan' },
        { id: 'students', name: 'üë©‚Äçüéì H·ªçc vi√™n' },
        { id: 'trial', name: 'üéì H·ªçc th·ª≠' },
        { id: 'appointments', name: 'üìÖ L·ªãch h·∫πn' },
        { id: 'registrations', name: 'üìã Phi·∫øu ƒêK' },
        { id: 'receipts', name: 'üßæ Bi√™n lai' },
        { id: 'debts', name: 'üí≥ C√¥ng n·ª£' },
        { id: 'teachers', name: 'üë®‚Äçüè´ Gi√°o vi√™n' },
        { id: 'classes', name: 'üìö L·ªõp h·ªçc' },
        { id: 'attendance', name: '‚úÖ ƒêi·ªÉm danh' },
        { id: 'subjects', name: 'üìñ M√¥n h·ªçc' },
        { id: 'packages', name: 'üì¶ G√≥i h·ªçc ph√≠' },
        { id: 'promotions', name: 'üéÅ Khuy·∫øn m√£i' },
        { id: 'reports', name: 'üìà B√°o c√°o' },
        { id: 'export', name: 'üì§ Xu·∫•t/Nh·∫≠p' },
        { id: 'users', name: 'üîê T√†i kho·∫£n' },
        { id: 'settings', name: '‚öôÔ∏è C√†i ƒë·∫∑t' }
    ];
    
    const html = `
        <table>
            <thead>
                <tr>
                    <th style="text-align: left;">Tab/Ch·ª©c nƒÉng</th>
                    <th>Xem</th>
                    <th>Th√™m</th>
                    <th>S·ª≠a</th>
                    <th>X√≥a</th>
                </tr>
            </thead>
            <tbody>
                ${tabs.map(tab => {
                    const perms = rolePerms[tab.id] || { view: false, create: false, edit: false, delete: false };
                    return `
                        <tr>
                            <td><span class="tab-name">${tab.name}</span></td>
                            <td><input type="checkbox" class="permission-checkbox" data-tab="${tab.id}" data-action="view" ${perms.view ? 'checked' : ''}></td>
                            <td><input type="checkbox" class="permission-checkbox" data-tab="${tab.id}" data-action="create" ${perms.create ? 'checked' : ''}></td>
                            <td><input type="checkbox" class="permission-checkbox" data-tab="${tab.id}" data-action="edit" ${perms.edit ? 'checked' : ''}></td>
                            <td><input type="checkbox" class="permission-checkbox" data-tab="${tab.id}" data-action="delete" ${perms.delete ? 'checked' : ''}></td>
                        </tr>
                    `;
                }).join('')}
            </tbody>
        </table>
    `;
    
    document.getElementById('permissionMatrix').innerHTML = html;
}

function loadPermissionsForRole() {
    renderPermissionMatrix();
}

// ===== 3.9 L∆∞u ph√¢n quy·ªÅn =====
function savePermissions() {
    const role = document.getElementById('permissionRoleSelect').value;
    
    if (!permissions[role]) {
        permissions[role] = {};
    }
    
    const checkboxes = document.querySelectorAll('.permission-checkbox');
    checkboxes.forEach(cb => {
        const tab = cb.dataset.tab;
        const action = cb.dataset.action;
        
        if (!permissions[role][tab]) {
            permissions[role][tab] = { view: false, create: false, edit: false, delete: false };
        }
        
        permissions[role][tab][action] = cb.checked;
    });
    
    saveData('permissions', permissions);
    showNotification(`ƒê√£ l∆∞u ph√¢n quy·ªÅn cho ${getRoleLabel(role)}!`, 'success');
    
    // N·∫øu ƒëang s·ª≠a quy·ªÅn c·ªßa ch√≠nh m√¨nh, c·∫≠p nh·∫≠t l·∫°i UI
    if (currentUser && currentUser.role === role) {
        renderSidebarMenu();
        updateActionButtons();
    }
}

// ===== 3.10 Reset v·ªÅ m·∫∑c ƒë·ªãnh =====
function resetPermissions() {
    const role = document.getElementById('permissionRoleSelect').value;
    
    if (!confirm(`Reset quy·ªÅn c·ªßa ${getRoleLabel(role)} v·ªÅ m·∫∑c ƒë·ªãnh?`)) return;
    
    permissions[role] = JSON.parse(JSON.stringify(DEFAULT_PERMISSIONS[role]));
    saveData('permissions', permissions);
    
    renderPermissionMatrix();
    showNotification('ƒê√£ reset v·ªÅ m·∫∑c ƒë·ªãnh!', 'success');
    
    if (currentUser && currentUser.role === role) {
        renderSidebarMenu();
        updateActionButtons();
    }
}

/* ============================================================
   üë§ PH·∫¶N 4: QU·∫¢N L√ù T√ÄI KHO·∫¢N
   ============================================================ */

// ===== 4.1 Render b·∫£ng users =====
function renderUsersTable() {
    const tbody = document.getElementById('usersTableBody');
    
    if (users.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><div class="empty-state-icon">üë§</div><p>Ch∆∞a c√≥ t√†i kho·∫£n</p></div></td></tr>`;
        return;
    }
    
    tbody.innerHTML = users.map(user => `
        <tr>
            <td><strong>${user.username}</strong></td>
            <td>${user.fullName}</td>
            <td><span class="role-badge ${user.role}">${getRoleLabel(user.role)}</span></td>
            <td><span class="status-badge ${user.status === 'active' ? 'active' : 'locked'}">${user.status === 'active' ? '‚úÖ Ho·∫°t ƒë·ªông' : 'üîí ƒê√£ kh√≥a'}</span></td>
            <td>${user.lastLogin ? formatDateTime(user.lastLogin) : '<span class="text-muted">Ch∆∞a ƒëƒÉng nh·∫≠p</span>'}</td>
            <td>
                <div class="action-buttons">
                    ${user.id !== currentUser.id ? `
                        <button class="action-btn edit" onclick="editUser('${user.id}')" title="S·ª≠a">‚úèÔ∏è</button>
                        <button class="action-btn key" onclick="openResetPasswordModal('${user.id}')" title="Reset m·∫≠t kh·∫©u">üîë</button>
                        ${user.status === 'active' 
                            ? `<button class="action-btn lock" onclick="toggleUserStatus('${user.id}')" title="Kh√≥a">üîí</button>`
                            : `<button class="action-btn unlock" onclick="toggleUserStatus('${user.id}')" title="M·ªü kh√≥a">üîì</button>`
                        }
                        ${user.role !== 'admin' || users.filter(u => u.role === 'admin').length > 1
                            ? `<button class="action-btn delete" onclick="deleteUser('${user.id}')" title="X√≥a">üóëÔ∏è</button>`
                            : ''
                        }
                    ` : '<span class="text-muted">T√†i kho·∫£n hi·ªán t·∫°i</span>'}
                </div>
            </td>
        </tr>
    `).join('');
}

// ===== 4.2 M·ªü modal th√™m user =====
function openUserModal() {
    document.getElementById('editUserId').value = '';
    document.getElementById('userForm').reset();
    document.getElementById('userModalTitle').textContent = 'üë§ Th√™m T√†i Kho·∫£n';
    document.getElementById('userPassword').required = true;
    document.getElementById('passwordGroup').style.display = 'block';
    openModal('userModal');
}

// ===== 4.3 S·ª≠a user =====
function editUser(id) {
    const user = users.find(u => u.id === id);
    if (!user) return;
    
    document.getElementById('editUserId').value = user.id;
    document.getElementById('userUsername').value = user.username;
    document.getElementById('userFullName').value = user.fullName;
    document.getElementById('userRole').value = user.role;
    document.getElementById('userPassword').value = '';
    document.getElementById('userPassword').required = false;
    document.getElementById('passwordGroup').style.display = 'none'; // ·∫®n khi s·ª≠a
    document.getElementById('userModalTitle').textContent = '‚úèÔ∏è S·ª≠a T√†i Kho·∫£n';
    
    openModal('userModal');
}

// ===== 4.4 L∆∞u user =====
function saveUser(event) {
    event.preventDefault();
    
    const editId = document.getElementById('editUserId').value;
    const username = document.getElementById('userUsername').value.trim().toLowerCase();
    const password = document.getElementById('userPassword').value;
    const fullName = document.getElementById('userFullName').value.trim();
    const role = document.getElementById('userRole').value;
    
    // Ki·ªÉm tra username tr√πng
    const existing = users.find(u => u.username.toLowerCase() === username && u.id !== editId);
    if (existing) {
        showNotification('T√™n ƒëƒÉng nh·∫≠p ƒë√£ t·ªìn t·∫°i!', 'error');
        return;
    }
    
    if (editId) {
        // C·∫≠p nh·∫≠t
        const index = users.findIndex(u => u.id === editId);
        if (index !== -1) {
            users[index].username = username;
            users[index].fullName = fullName;
            users[index].role = role;
            showNotification('C·∫≠p nh·∫≠t th√†nh c√¥ng!', 'success');
        }
    } else {
        // Th√™m m·ªõi
        if (!password || password.length < 6) {
            showNotification('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!', 'error');
            return;
        }
        
        users.push({
            id: generateId(),
            username,
            passwordHash: hashPassword(password),
            fullName,
            role,
            status: 'active',
            createdAt: new Date().toISOString(),
            lastLogin: null
        });
        showNotification('Th√™m t√†i kho·∫£n th√†nh c√¥ng!', 'success');
    }
    
    saveData('users', users);
    closeModal('userModal');
    renderUsersTable();
}

// ===== 4.5 Kh√≥a/M·ªü kh√≥a user =====
function toggleUserStatus(id) {
    const user = users.find(u => u.id === id);
    if (!user) return;
    
    const action = user.status === 'active' ? 'kh√≥a' : 'm·ªü kh√≥a';
    if (!confirm(`${action.charAt(0).toUpperCase() + action.slice(1)} t√†i kho·∫£n "${user.username}"?`)) return;
    
    user.status = user.status === 'active' ? 'locked' : 'active';
    saveData('users', users);
    renderUsersTable();
    showNotification(`ƒê√£ ${action} t√†i kho·∫£n!`, 'success');
}

// ===== 4.6 X√≥a user =====
function deleteUser(id) {
    const user = users.find(u => u.id === id);
    if (!user) return;
    
    if (!confirm(`X√≥a t√†i kho·∫£n "${user.username}"?`)) return;
    
    users = users.filter(u => u.id !== id);
    saveData('users', users);
    renderUsersTable();
    showNotification('ƒê√£ x√≥a t√†i kho·∫£n!', 'success');
}

// ===== 4.7 Reset password =====
function openResetPasswordModal(id) {
    const user = users.find(u => u.id === id);
    if (!user) return;
    
    document.getElementById('resetPasswordUserId').value = user.id;
    document.getElementById('resetPasswordUsername').textContent = user.username;
    document.getElementById('resetNewPassword').value = '';
    openModal('resetPasswordModal');
}

function handleResetPassword(event) {
    event.preventDefault();
    
    const userId = document.getElementById('resetPasswordUserId').value;
    const newPassword = document.getElementById('resetNewPassword').value;
    
    if (newPassword.length < 6) {
        showNotification('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!', 'error');
        return;
    }
    
    const user = users.find(u => u.id === userId);
    if (user) {
        user.passwordHash = hashPassword(newPassword);
        saveData('users', users);
        closeModal('resetPasswordModal');
        showNotification('ƒê√£ reset m·∫≠t kh·∫©u!', 'success');
    }
}

// ===== 4.8 ƒê·ªïi m·∫≠t kh·∫©u (user t·ª± ƒë·ªïi) =====
function openChangePasswordModal() {
    document.getElementById('changePasswordForm').reset();
    closeUserMenu();
    openModal('changePasswordModal');
}

function handleChangePassword(event) {
    event.preventDefault();
    
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    // T√¨m user hi·ªán t·∫°i
    const user = users.find(u => u.id === currentUser.id);
    if (!user) return;
    
    // Ki·ªÉm tra m·∫≠t kh·∫©u hi·ªán t·∫°i
    if (!verifyPassword(currentPassword, user.passwordHash)) {
        showNotification('M·∫≠t kh·∫©u hi·ªán t·∫°i kh√¥ng ƒë√∫ng!', 'error');
        return;
    }
    
    // Ki·ªÉm tra m·∫≠t kh·∫©u m·ªõi
    if (newPassword.length < 6) {
        showNotification('M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!', 'error');
        return;
    }
    
    if (newPassword !== confirmPassword) {
        showNotification('X√°c nh·∫≠n m·∫≠t kh·∫©u kh√¥ng kh·ªõp!', 'error');
        return;
    }
    
    // C·∫≠p nh·∫≠t
    user.passwordHash = hashPassword(newPassword);
    saveData('users', users);
    
    closeModal('changePasswordModal');
    showNotification('ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!', 'success');
}

function openProfileModal() {
    closeUserMenu();
    showNotification('T√≠nh nƒÉng ƒëang ph√°t tri·ªÉn', 'info');
}

/* ============================================================
   üß≠ PH·∫¶N 5: NAVIGATION & UI
   ============================================================ */

// ===== 5.1 Toggle Sidebar =====
function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('collapsed');
}

// ===== 5.2 Toggle Submenu =====
function toggleSubmenu(element) {
    const navItem = element.parentElement;
    const submenu = navItem.querySelector('.nav-submenu');
    const isExpanded = submenu.classList.contains('open');
    
    // ƒê√≥ng t·∫•t c·∫£ submenu kh√°c
    document.querySelectorAll('.nav-submenu.open').forEach(menu => {
        menu.classList.remove('open');
        menu.previousElementSibling.classList.remove('expanded');
    });
    
    // Toggle submenu hi·ªán t·∫°i
    if (!isExpanded) {
        submenu.classList.add('open');
        element.classList.add('expanded');
    }
}

// ===== 5.3 Toggle User Menu =====
function toggleUserMenu() {
    document.getElementById('userMenu').classList.toggle('show');
}

function closeUserMenu() {
    document.getElementById('userMenu').classList.remove('show');
}

// ===== 5.4 Chuy·ªÉn Tab =====
function switchTab(tabName) {
    // Ki·ªÉm tra quy·ªÅn
    if (!canViewTab(tabName)) {
        showNotification('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p!', 'error');
        return;
    }
    
    // ·∫®n t·∫•t c·∫£ tab content
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    
    // B·ªè active t·∫•t c·∫£ nav-link
    document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
    
    // Hi·ªán tab ƒë∆∞·ª£c ch·ªçn
    const tabContent = document.getElementById(tabName);
    if (tabContent) {
        tabContent.classList.add('active');
    }
    
    // Active nav-link t∆∞∆°ng ·ª©ng
    const navLink = document.querySelector(`.nav-link[data-tab="${tabName}"]`);
    if (navLink) {
        navLink.classList.add('active');
        
        // M·ªü submenu cha n·∫øu c√≥
        const submenu = navLink.closest('.nav-submenu');
        if (submenu) {
            submenu.classList.add('open');
            const parentLink = submenu.previousElementSibling;
            if (parentLink) parentLink.classList.add('expanded');
        }
    }
    
    // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ
    updatePageTitle(tabName);
    
    // Render n·ªôi dung
    renderTabContent(tabName);
    
    // C·∫≠p nh·∫≠t n√∫t thao t√°c theo quy·ªÅn
    updateActionButtons();
}

function updatePageTitle(tabName) {
    const menuItem = MENU_STRUCTURE.find(m => m.id === tabName);
    document.getElementById('pageTitle').textContent = menuItem ? `${menuItem.icon} ${menuItem.text}` : tabName;
}

function renderTabContent(tabName) {
    switch(tabName) {
        case 'dashboard': renderDashboard(); break;
        case 'students': renderStudentsTable(); updateStudentCounts(); break;
        case 'teachers': renderTeachersTable(); break;
        case 'classes': renderClassesTable(); populateClassFilters(); break;
        case 'attendance': initAttendanceTab(); break;
        case 'makeup': checkExpiredMakeupRequests(); renderMakeupRequests(); break;
        case 'trial': renderTrialStudentsTable(); updateTrialCounts(); break;
        case 'appointments': renderAppointmentsTable(); break;
        case 'registrations': renderRegistrationsTable(); break;
        case 'receipts': renderReceiptsTable(); break;
        case 'subjects': renderSubjectsTable(); break;
        case 'packages': renderPackagesTable(); break;
        case 'promotions': renderPromotionsTable(); break;
        case 'users': renderUsersTable(); renderPermissionMatrix(); break;
        case 'export': renderBackupHistory(); break;
        case 'settings': loadCenterInfo(); loadBankInfo(); break;
    }
}

// ===== 5.5 Click outside to close =====
document.addEventListener('click', function(e) {
    // Close user menu
    if (!e.target.closest('.user-dropdown')) {
        closeUserMenu();
    }
});

/* ============================================================
   üîî PH·∫¶N 6: NOTIFICATIONS & MODALS
   ============================================================ */

function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };
    notification.className = `notification ${type} show`;
    notification.innerHTML = `<span>${icons[type]}</span><span>${message}</span>`;
    setTimeout(() => notification.classList.remove('show'), 3000);
}

function openModal(modalId) {
    document.getElementById(modalId).classList.add('active');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

/* ============================================================
   üíæ PH·∫¶N 7: DATA HELPERS
   ============================================================ */

function saveData(key, data) {
    localStorage.setItem(key, JSON.stringify(data));
    if (autoBackupEnabled && !['loginAttempts', 'currentUser'].includes(key)) {
        createAutoBackup();
    }
}

function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
}

function generateRegCode() {
    const date = new Date();
    const y = date.getFullYear().toString().slice(2);
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    const rand = Math.random().toString(36).substr(2, 4).toUpperCase();
    return `DK${y}${m}${d}-${rand}`;
}

/* ============================================================
   üìä PH·∫¶N 8: DASHBOARD
   ============================================================ */

function renderDashboard() {
    renderDashboardStats();
    renderRevenueChart();
    renderUpcomingAppointments();
}

function renderDashboardStats() {
    const stats = {
        total: students.length,
        hocThu: students.filter(s => s.status === 'H·ªçc Th·ª≠').length,
        choDangKy: students.filter(s => s.status === 'Ch·ªù ƒêƒÉng K√Ω').length,
        daDangKy: students.filter(s => s.status === 'ƒê√£ ƒêƒÉng K√Ω').length,
        hoanThanh: students.filter(s => s.status === 'Ho√†n Th√†nh').length,
        totalRevenue: receipts.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0)
    };
    
    document.getElementById('dashboardStats').innerHTML = `
        <div class="stat-card"><div class="stat-icon teal">üìã</div><div class="stat-info"><h3>${stats.total}</h3><p>T·ªïng h·ªçc vi√™n</p></div></div>
        <div class="stat-card"><div class="stat-icon blue">üÜï</div><div class="stat-info"><h3>${stats.hocThu}</h3><p>H·ªçc th·ª≠</p></div></div>
        <div class="stat-card"><div class="stat-icon orange">‚è≥</div><div class="stat-info"><h3>${stats.choDangKy}</h3><p>Ch·ªù ƒëƒÉng k√Ω</p></div></div>
        <div class="stat-card"><div class="stat-icon green">‚úÖ</div><div class="stat-info"><h3>${stats.daDangKy}</h3><p>ƒê√£ ƒëƒÉng k√Ω</p></div></div>
        <div class="stat-card"><div class="stat-icon purple">üéì</div><div class="stat-info"><h3>${stats.hoanThanh}</h3><p>Ho√†n th√†nh</p></div></div>
        <div class="stat-card"><div class="stat-icon teal">üí∞</div><div class="stat-info"><h3>${formatCurrencyShort(stats.totalRevenue)}</h3><p>Doanh thu</p></div></div>
    `;
}

function renderRevenueChart() {
    const months = [];
    const now = new Date();
    for (let i = 5; i >= 0; i--) {
        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
        months.push({ key: `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`, label: `T${d.getMonth() + 1}` });
    }
    
    const monthlyRevenue = {};
    months.forEach(m => monthlyRevenue[m.key] = 0);
    receipts.forEach(r => {
        const month = r.date?.substring(0, 7);
        if (monthlyRevenue[month] !== undefined) monthlyRevenue[month] += parseFloat(r.amount) || 0;
    });
    
    const maxRevenue = Math.max(...Object.values(monthlyRevenue), 1);
    document.getElementById('revenueChart').innerHTML = months.map(m => {
        const revenue = monthlyRevenue[m.key];
        const height = (revenue / maxRevenue) * 100;
        return `<div class="chart-bar-wrapper"><div class="chart-bar" style="height:${Math.max(height, 5)}%;"><span class="chart-bar-value">${formatCurrencyShort(revenue)}</span></div><span class="chart-bar-label">${m.label}</span></div>`;
    }).join('');
}

function renderUpcomingAppointments() {
    const now = new Date();
    const upcoming = appointments.filter(a => new Date(a.date + ' ' + a.time) >= now)
        .sort((a, b) => new Date(a.date + ' ' + a.time) - new Date(b.date + ' ' + b.time)).slice(0, 5);
    
    document.getElementById('upcomingAppointments').innerHTML = upcoming.length === 0 
        ? '<div class="empty-state"><p class="text-muted">Ch∆∞a c√≥ l·ªãch h·∫πn s·∫Øp t·ªõi</p></div>'
        : upcoming.map(apt => {
            const student = students.find(s => s.id === apt.studentId);
            return `<div class="upcoming-item"><strong>${student?.name || 'N/A'}</strong> - ${apt.subject}<br>üìÖ ${formatDate(apt.date)} l√∫c ${apt.time}</div>`;
        }).join('');
}

/* ============================================================
   üë©‚Äçüéì PH·∫¶N 9: QU·∫¢N L√ù H·ªåC VI√äN
   ============================================================ */

function renderSubjectCheckboxes() {
    document.getElementById('subjectCheckboxes').innerHTML = subjects.map(sub => 
        `<label class="checkbox-item"><input type="checkbox" name="studentSubjects" value="${sub.name}"> ${sub.icon} ${sub.name}</label>`
    ).join('');
}

function toggleStudentForm() {
    const form = document.getElementById('studentFormSection');
    form.classList.toggle('show');
    if (form.classList.contains('show')) {
        resetStudentForm();
    }
}

function resetStudentForm() {
    document.getElementById('studentForm').reset();
    document.getElementById('editStudentId').value = '';
    document.getElementById('studentStatus').value = 'H·ªçc Th·ª≠';
    document.getElementById('studentFormTitle').textContent = '‚ûï Th√™m H·ªçc Vi√™n M·ªõi';
    document.getElementById('saveStudentBtn').textContent = 'üíæ L∆∞u H·ªçc Vi√™n';
    document.querySelectorAll('input[name="studentSubjects"]').forEach(cb => cb.checked = false);
}

function saveStudent(event) {
    event.preventDefault();
    
    if (!canCreate('students') && !document.getElementById('editStudentId').value) {
        showNotification('B·∫°n kh√¥ng c√≥ quy·ªÅn th√™m h·ªçc vi√™n!', 'error');
        return;
    }
    
    const selectedSubjects = Array.from(document.querySelectorAll('input[name="studentSubjects"]:checked')).map(cb => cb.value);
    if (selectedSubjects.length === 0) { showNotification('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 m√¥n h·ªçc!', 'error'); return; }
    
    const editId = document.getElementById('editStudentId').value;
    const studentData = {
        name: document.getElementById('studentName').value.trim(),
        age: parseInt(document.getElementById('studentAge').value),
        parentName: document.getElementById('parentName').value.trim(),
        parentPhone: document.getElementById('parentPhone').value.trim(),
        parentEmail: document.getElementById('parentEmail').value.trim(),
        status: document.getElementById('studentStatus').value,
        subjects: selectedSubjects,
        notes: document.getElementById('studentNotes').value.trim()
    };
    
    if (editId) {
        if (!canEdit('students')) {
            showNotification('B·∫°n kh√¥ng c√≥ quy·ªÅn s·ª≠a!', 'error');
            return;
        }
        const index = students.findIndex(s => s.id === editId);
        if (index !== -1) {
            students[index] = { ...students[index], ...studentData, updatedAt: new Date().toISOString() };
            showNotification('C·∫≠p nh·∫≠t th√†nh c√¥ng!');
        }
    } else {
        students.push({ id: generateId(), ...studentData, previousStatus: null, createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() });
        showNotification('Th√™m h·ªçc vi√™n th√†nh c√¥ng!');
    }
    
    saveData('students', students);
    document.getElementById('studentFormSection').classList.remove('show');
    resetStudentForm();
    renderStudentsTable();
    updateStudentCounts();
}

function editStudent(id) {
    if (!canEdit('students')) {
        showNotification('B·∫°n kh√¥ng c√≥ quy·ªÅn s·ª≠a!', 'error');
        return;
    }
    
    const student = students.find(s => s.id === id);
    if (!student) return;
    
    document.getElementById('editStudentId').value = student.id;
    document.getElementById('studentName').value = student.name;
    document.getElementById('studentAge').value = student.age;
    document.getElementById('parentName').value = student.parentName;
    document.getElementById('parentPhone').value = student.parentPhone;
    document.getElementById('parentEmail').value = student.parentEmail || '';
    document.getElementById('studentStatus').value = student.status;
    document.getElementById('studentNotes').value = student.notes || '';
    document.querySelectorAll('input[name="studentSubjects"]').forEach(cb => cb.checked = student.subjects.includes(cb.value));
    
    document.getElementById('studentFormTitle').textContent = '‚úèÔ∏è S·ª≠a H·ªçc Vi√™n';
    document.getElementById('saveStudentBtn').textContent = 'üíæ C·∫≠p Nh·∫≠t';
    document.getElementById('studentFormSection').classList.add('show');
}

function deleteStudent(id) {
    if (!canDelete('students')) {
        showNotification('B·∫°n kh√¥ng c√≥ quy·ªÅn x√≥a!', 'error');
        return;
    }
    
    const student = students.find(s => s.id === id);
    if (!student || !confirm(`X√≥a "${student.name}"?`)) return;
    
    students = students.filter(s => s.id !== id);
    appointments = appointments.filter(a => a.studentId !== id);
    registrations = registrations.filter(r => r.studentId !== id);
    receipts = receipts.filter(r => r.studentId !== id);
    
    saveData('students', students);
    saveData('appointments', appointments);
    saveData('registrations', registrations);
    saveData('receipts', receipts);
    
    showNotification('ƒê√£ x√≥a!');
    renderAll();
}

function updateStudentCounts() {
    document.getElementById('countAll').textContent = students.length;
    document.getElementById('countHocThu').textContent = students.filter(s => s.status === 'H·ªçc Th·ª≠').length;
    document.getElementById('countChoDangKy').textContent = students.filter(s => s.status === 'Ch·ªù ƒêƒÉng K√Ω').length;
    document.getElementById('countDaDangKy').textContent = students.filter(s => s.status === 'ƒê√£ ƒêƒÉng K√Ω').length;
    document.getElementById('countHoanThanh').textContent = students.filter(s => s.status === 'Ho√†n Th√†nh').length;
    document.getElementById('countCancel').textContent = students.filter(s => s.status === 'Cancel').length;
}

function filterStudents(status) {
    currentFilter = status;
    paginationState.students.page = 1;
    document.querySelectorAll('#students .filter-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.filter === status));
    renderStudentsTable();
}

function searchStudents() {
    paginationState.students.page = 1;
    renderStudentsTable();
}

function getFilteredStudents() {
    const searchTerm = document.getElementById('searchStudent')?.value?.toLowerCase() || '';
    let filtered = students;
    if (currentFilter !== 'all') filtered = filtered.filter(s => s.status === currentFilter);
    if (searchTerm) filtered = filtered.filter(s => s.name.toLowerCase().includes(searchTerm) || s.parentName.toLowerCase().includes(searchTerm) || s.parentPhone.includes(searchTerm));
    return filtered;
}

function renderStudentsTable() {
    const filtered = getFilteredStudents();
    const { data, total, totalPages, currentPage } = getPaginatedData(filtered, 'students');
    const tbody = document.getElementById('studentsTableBody');
    
    if (data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><div class="empty-state-icon">üìã</div><p>Kh√¥ng c√≥ d·ªØ li·ªáu</p></div></td></tr>`;
        renderPagination('studentsPagination', 'students', 0, 0, 1);
        return;
    }
    
    tbody.innerHTML = data.map(s => `
        <tr>
            <td><strong>${s.name}</strong></td>
            <td>${s.age}</td>
            <td>${s.parentName}</td>
            <td>${s.parentPhone}</td>
            <td>${s.subjects.map(sub => `<span class="subject-tag">${sub}</span>`).join('')}</td>
            <td>${getStatusBadge(s.status)}</td>
            <td><div class="action-buttons">${getStudentActionButtons(s)}</div></td>
        </tr>
    `).join('');
    
    renderPagination('studentsPagination', 'students', total, totalPages, currentPage);
}

function getStatusBadge(status) {
    const badges = {
        'H·ªçc Th·ª≠': '<span class="status-badge hoc-thu">üÜï H·ªçc Th·ª≠</span>',
        'Ch·ªù ƒêƒÉng K√Ω': '<span class="status-badge cho-dk">‚è≥ Ch·ªù ƒêK</span>',
        'ƒê√£ ƒêƒÉng K√Ω': '<span class="status-badge da-dk">‚úÖ ƒê√£ ƒêK</span>',
        'Ho√†n Th√†nh': '<span class="status-badge hoan-thanh">üéì Ho√†n Th√†nh</span>',
        'Cancel': '<span class="status-badge cancel">‚ùå Cancel</span>'
    };
    return badges[status] || status;
}

function getStudentActionButtons(student) {
    const id = student.id;
    let btns = [`<button class="action-btn view" onclick="viewStudent('${id}')" title="Xem">üëÅÔ∏è</button>`];
    
    if (canEdit('students')) {
        btns.push(`<button class="action-btn edit" onclick="editStudent('${id}')" title="S·ª≠a">‚úèÔ∏è</button>`);
    }
    
    if (student.status === 'H·ªçc Th·ª≠' && canCreate('appointments')) {
        btns.push(`<button class="action-btn schedule" onclick="openAppointmentModalForStudent('${id}')" title="ƒê·∫∑t l·ªãch">üìÖ</button>`);
    }
    
    if (student.status === 'Ch·ªù ƒêƒÉng K√Ω' && canCreate('registrations')) {
        btns.push(`<button class="action-btn receipt" onclick="openRegistrationModalForStudent('${id}')" title="T·∫°o Phi·∫øu ƒêK">üìã</button>`);
    }
    
    if (student.status === 'ƒê√£ ƒêƒÉng K√Ω' && canCreate('receipts')) {
        btns.push(`<button class="action-btn receipt" onclick="openReceiptModalForStudent('${id}')" title="T·∫°o Bi√™n Lai">üßæ</button>`);
    }
    
    if (canDelete('students')) {
        btns.push(`<button class="action-btn delete" onclick="deleteStudent('${id}')" title="X√≥a">üóëÔ∏è</button>`);
    }
    
    return btns.join('');
}

function viewStudent(id) {
    const student = students.find(s => s.id === id);
    if (!student) return;
    
    const studentAppointments = appointments.filter(a => a.studentId === id);
    const studentRegistrations = registrations.filter(r => r.studentId === id);
    const studentReceipts = receipts.filter(r => r.studentId === id);
    
    document.getElementById('quickViewContent').innerHTML = `
        <div class="quick-view-section">
            <h4>üë§ Th√¥ng Tin H·ªçc Vi√™n</h4>
            <div class="quick-view-row"><span class="quick-view-label">T√™n:</span><span class="quick-view-value"><strong>${student.name}</strong></span></div>
            <div class="quick-view-row"><span class="quick-view-label">Tu·ªïi:</span><span class="quick-view-value">${student.age}</span></div>
            <div class="quick-view-row"><span class="quick-view-label">Ph·ª• huynh:</span><span class="quick-view-value">${student.parentName}</span></div>
            <div class="quick-view-row"><span class="quick-view-label">SƒêT:</span><span class="quick-view-value">${student.parentPhone}</span></div>
            <div class="quick-view-row"><span class="quick-view-label">M√¥n h·ªçc:</span><span class="quick-view-value">${student.subjects.map(s => `<span class="subject-tag">${s}</span>`).join('')}</span></div>
            <div class="quick-view-row"><span class="quick-view-label">Tr·∫°ng th√°i:</span><span class="quick-view-value">${getStatusBadge(student.status)}</span></div>
        </div>
        <div class="quick-view-section">
            <h4>üìÖ L·ªãch H·∫πn (${studentAppointments.length})</h4>
            ${studentAppointments.length === 0 ? '<p class="text-muted">Ch∆∞a c√≥</p>' : studentAppointments.map(a => `<div class="quick-view-row"><span class="quick-view-label">${formatDate(a.date)} ${a.time}</span><span class="quick-view-value">${a.subject}</span></div>`).join('')}
        </div>
        <div class="quick-view-section">
            <h4>üìã Phi·∫øu ƒêK (${studentRegistrations.length})</h4>
            ${studentRegistrations.length === 0 ? '<p class="text-muted">Ch∆∞a c√≥</p>' : studentRegistrations.map(r => `<div class="quick-view-row"><span class="quick-view-label">${r.regCode}</span><span class="quick-view-value">${formatCurrency(r.finalAmount)}</span></div>`).join('')}
        </div>
        <div class="quick-view-section">
            <h4>üßæ Bi√™n Lai (${studentReceipts.length})</h4>
            ${studentReceipts.length === 0 ? '<p class="text-muted">Ch∆∞a c√≥</p>' : studentReceipts.map(r => `<div class="quick-view-row"><span class="quick-view-label">${formatDate(r.date)}</span><span class="quick-view-value">${formatCurrency(r.amount)}</span></div>`).join('')}
        </div>
    `;
    openModal('quickViewModal');
}

function cancelStudent(id) {
    const student = students.find(s => s.id === id);
    if (!student || !confirm(`Cancel "${student.name}"?`)) return;
    student.previousStatus = student.status;
    student.status = 'Cancel';
    saveData('students', students);
    showNotification('ƒê√£ cancel!', 'warning');
    renderAll();
}

function restoreStudent(id) {
    const student = students.find(s => s.id === id);
    if (!student || !student.previousStatus) return;
    if (!confirm(`Kh√¥i ph·ª•c "${student.name}"?`)) return;
    student.status = student.previousStatus;
    student.previousStatus = null;
    saveData('students', students);
    showNotification('ƒê√£ kh√¥i ph·ª•c!');
    renderAll();
}

function confirmTrialCompleted(id) {
    const student = students.find(s => s.id === id);
    if (!student || student.status !== 'H·ªçc Th·ª≠') return;
    if (!confirm(`X√°c nh·∫≠n "${student.name}" ƒë√£ h·ªçc th·ª≠ xong?`)) return;
    student.status = 'Ch·ªù ƒêƒÉng K√Ω';
    saveData('students', students);
    showNotification('ƒê√£ chuy·ªÉn sang Ch·ªù ƒêƒÉng K√Ω!');
    renderAll();
}

/* ============================================================
   üéì PH·∫¶N 10: H·ªåC TH·ª¨
   ============================================================ */

function updateTrialCounts() {
    const trial = students.filter(s => s.status === 'H·ªçc Th·ª≠' || s.status === 'Ch·ªù ƒêƒÉng K√Ω');
    document.getElementById('trialCountAll').textContent = trial.length;
    document.getElementById('trialCountHocThu').textContent = students.filter(s => s.status === 'H·ªçc Th·ª≠').length;
    document.getElementById('trialCountChoDangKy').textContent = students.filter(s => s.status === 'Ch·ªù ƒêƒÉng K√Ω').length;
}

function filterTrialStudents(status) {
    currentTrialFilter = status;
    paginationState.trial.page = 1;
    document.querySelectorAll('#trial .filter-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.filter === status));
    renderTrialStudentsTable();
}

function searchTrialStudents() {
    paginationState.trial.page = 1;
    renderTrialStudentsTable();
}

function getFilteredTrialStudents() {
    const searchTerm = document.getElementById('searchTrialStudent')?.value?.toLowerCase() || '';
    let filtered = students.filter(s => s.status === 'H·ªçc Th·ª≠' || s.status === 'Ch·ªù ƒêƒÉng K√Ω');
    if (currentTrialFilter !== 'all') filtered = filtered.filter(s => s.status === currentTrialFilter);
    if (searchTerm) filtered = filtered.filter(s => s.name.toLowerCase().includes(searchTerm) || s.parentPhone.includes(searchTerm));
    return filtered;
}

function renderTrialStudentsTable() {
    const filtered = getFilteredTrialStudents();
    const { data, total, totalPages, currentPage } = getPaginatedData(filtered, 'trial');
    const tbody = document.getElementById('trialStudentsTableBody');
    
    if (data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><div class="empty-state-icon">üéì</div><p>Kh√¥ng c√≥ d·ªØ li·ªáu</p></div></td></tr>`;
        renderPagination('trialPagination', 'trial', 0, 0, 1);
        return;
    }
    
    tbody.innerHTML = data.map(s => {
        const apt = appointments.find(a => a.studentId === s.id && new Date(a.date + ' ' + a.time) >= new Date());
        return `
            <tr>
                <td><strong>${s.name}</strong></td>
                <td>${s.age}</td>
                <td>${s.parentName}</td>
                <td>${s.parentPhone}</td>
                <td>${s.subjects.map(sub => `<span class="subject-tag">${sub}</span>`).join('')}</td>
                <td>${getStatusBadge(s.status)}</td>
                <td>${apt ? `<span class="text-success">${formatDate(apt.date)} ${apt.time}</span>` : '<span class="text-muted">-</span>'}</td>
                <td><div class="action-buttons">${getTrialActionButtons(s)}</div></td>
            </tr>
        `;
    }).join('');
    
    renderPagination('trialPagination', 'trial', total, totalPages, currentPage);
}

function getTrialActionButtons(student) {
    const id = student.id;
    let btns = [`<button class="action-btn view" onclick="viewStudent('${id}')" title="Xem">üëÅÔ∏è</button>`];
    
    if (student.status === 'H·ªçc Th·ª≠') {
        if (canCreate('appointments')) {
            btns.push(`<button class="action-btn schedule" onclick="openAppointmentModalForStudent('${id}')" title="ƒê·∫∑t l·ªãch">üìÖ</button>`);
        }
        if (canEdit('trial')) {
            btns.push(`<button class="action-btn edit" onclick="confirmTrialCompleted('${id}')" title="X√°c nh·∫≠n HT">‚úÖ</button>`);
        }
    } else if (student.status === 'Ch·ªù ƒêƒÉng K√Ω') {
        if (canCreate('registrations')) {
            btns.push(`<button class="action-btn receipt" onclick="openRegistrationModalForStudent('${id}')" title="T·∫°o Phi·∫øu ƒêK">üìã</button>`);
        }
    }
    return btns.join('');
}

/* ============================================================
   üìÖ PH·∫¶N 11: L·ªäCH H·∫∏N (T√≥m t·∫Øt - gi·ªØ nguy√™n logic c≈©)
   ============================================================ */

function openNewAppointmentModal() {
    document.getElementById('editAppointmentId').value = '';
    document.getElementById('appointmentStudentId').value = '';
    document.getElementById('appointmentForm').reset();
    document.getElementById('appointmentModalTitle').textContent = 'üìÖ Th√™m L·ªãch H·∫πn';
    document.getElementById('appointmentDate').min = new Date().toISOString().split('T')[0];
    populateAppointmentStudentDropdown();
    openModal('appointmentModal');
}

function openAppointmentModalForStudent(studentId) {
    const student = students.find(s => s.id === studentId);
    if (!student) return;
    
    document.getElementById('editAppointmentId').value = '';
    document.getElementById('appointmentStudentId').value = studentId;
    document.getElementById('appointmentForm').reset();
    document.getElementById('appointmentModalTitle').textContent = 'üìÖ ƒê·∫∑t L·ªãch H·∫πn';
    document.getElementById('appointmentDate').min = new Date().toISOString().split('T')[0];
    
    populateAppointmentStudentDropdown();
    document.getElementById('appointmentStudentSelect').value = studentId;
    onAppointmentStudentChange();
    openModal('appointmentModal');
}

function populateAppointmentStudentDropdown() {
    const eligible = students.filter(s => s.status === 'H·ªçc Th·ª≠' || s.status === 'Ch·ªù ƒêƒÉng K√Ω');
    document.getElementById('appointmentStudentSelect').innerHTML = '<option value="">-- Ch·ªçn h·ªçc vi√™n --</option>' + 
        eligible.map(s => `<option value="${s.id}">${s.name} - ${s.parentPhone}</option>`).join('');
}

function onAppointmentStudentChange() {
    const studentId = document.getElementById('appointmentStudentSelect').value;
    const student = students.find(s => s.id === studentId);
    document.getElementById('appointmentStudentId').value = studentId;
    
    if (student) {
        document.getElementById('appointmentSubject').innerHTML = '<option value="">-- Ch·ªçn m√¥n --</option>' + 
            student.subjects.map(s => `<option value="${s}">${s}</option>`).join('');
    }
}

function saveAppointment(event) {
    event.preventDefault();
    
    const studentId = document.getElementById('appointmentStudentId').value;
    if (!studentId) { showNotification('Vui l√≤ng ch·ªçn h·ªçc vi√™n!', 'error'); return; }
    
    const editId = document.getElementById('editAppointmentId').value;
    const data = {
        studentId,
        subject: document.getElementById('appointmentSubject').value,
        date: document.getElementById('appointmentDate').value,
        time: document.getElementById('appointmentTime').value,
        notes: document.getElementById('appointmentNotes').value.trim()
    };
    
    if (editId) {
        const index = appointments.findIndex(a => a.id === editId);
        if (index !== -1) appointments[index] = { ...appointments[index], ...data };
        showNotification('C·∫≠p nh·∫≠t th√†nh c√¥ng!');
    } else {
        appointments.push({ id: generateId(), ...data, createdAt: new Date().toISOString() });
        showNotification('Th√™m l·ªãch h·∫πn th√†nh c√¥ng!');
    }
    
    saveData('appointments', appointments);
    closeModal('appointmentModal');
    renderAll();
}

function filterAppointments(filter) {
    currentAppointmentFilter = filter;
    paginationState.appointments.page = 1;
    document.querySelectorAll('#appointments .filter-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    renderAppointmentsTable();
}

function searchAppointments() {
    paginationState.appointments.page = 1;
    renderAppointmentsTable();
}

function getFilteredAppointments() {
    const searchTerm = document.getElementById('searchAppointment')?.value?.toLowerCase() || '';
    const now = new Date();
    let filtered = [...appointments];
    
    if (currentAppointmentFilter === 'upcoming') filtered = filtered.filter(a => new Date(a.date + ' ' + a.time) >= now);
    else if (currentAppointmentFilter === 'past') filtered = filtered.filter(a => new Date(a.date + ' ' + a.time) < now);
    
    if (searchTerm) {
        filtered = filtered.filter(a => {
            const student = students.find(s => s.id === a.studentId);
            return a.subject.toLowerCase().includes(searchTerm) || student?.name.toLowerCase().includes(searchTerm);
        });
    }
    return filtered.sort((a, b) => new Date(b.date + ' ' + b.time) - new Date(a.date + ' ' + a.time));
}

function renderAppointmentsTable() {
    const filtered = getFilteredAppointments();
    const { data, total, totalPages, currentPage } = getPaginatedData(filtered, 'appointments');
    const tbody = document.getElementById('appointmentsTableBody');
    const now = new Date();
    
    if (data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><div class="empty-state-icon">üìÖ</div><p>Kh√¥ng c√≥ l·ªãch h·∫πn</p></div></td></tr>`;
        renderPagination('appointmentsPagination', 'appointments', 0, 0, 1);
        return;
    }
    
    tbody.innerHTML = data.map(a => {
        const student = students.find(s => s.id === a.studentId);
        const isPast = new Date(a.date + ' ' + a.time) < now;
        return `
            <tr style="${isPast ? 'opacity: 0.6;' : ''}">
                <td><strong>${student?.name || 'N/A'}</strong></td>
                <td>${student?.parentName || ''}</td>
                <td>${student?.parentPhone || ''}</td>
                <td><span class="subject-tag">${a.subject}</span></td>
                <td>${formatDate(a.date)}</td>
                <td><strong>${a.time}</strong></td>
                <td>${isPast ? '<span class="text-muted">ƒê√£ qua</span>' : '<span class="text-success">S·∫Øp t·ªõi</span>'}</td>
                <td>
                    <div class="action-buttons">
                        ${canEdit('appointments') ? `<button class="action-btn edit" onclick="editAppointment('${a.id}')" title="S·ª≠a">‚úèÔ∏è</button>` : ''}
                        ${canDelete('appointments') ? `<button class="action-btn delete" onclick="deleteAppointment('${a.id}')" title="X√≥a">üóëÔ∏è</button>` : ''}
                    </div>
                </td>
            </tr>
        `;
    }).join('');
    
    renderPagination('appointmentsPagination', 'appointments', total, totalPages, currentPage);
}

function editAppointment(id) {
    const apt = appointments.find(a => a.id === id);
    if (!apt) return;
    const student = students.find(s => s.id === apt.studentId);
    
    document.getElementById('editAppointmentId').value = apt.id;
    document.getElementById('appointmentStudentId').value = apt.studentId;
    populateAppointmentStudentDropdown();
    document.getElementById('appointmentStudentSelect').value = apt.studentId;
    
    if (student) {
        document.getElementById('appointmentSubject').innerHTML = '<option value="">-- Ch·ªçn m√¥n --</option>' + 
            student.subjects.map(s => `<option value="${s}" ${s === apt.subject ? 'selected' : ''}>${s}</option>`).join('');
    }
    
    document.getElementById('appointmentDate').value = apt.date;
    document.getElementById('appointmentTime').value = apt.time;
    document.getElementById('appointmentNotes').value = apt.notes || '';
    document.getElementById('appointmentModalTitle').textContent = '‚úèÔ∏è S·ª≠a L·ªãch H·∫πn';
    openModal('appointmentModal');
}

function deleteAppointment(id) {
    if (!confirm('X√≥a l·ªãch h·∫πn n√†y?')) return;
    appointments = appointments.filter(a => a.id !== id);
    saveData('appointments', appointments);
    showNotification('ƒê√£ x√≥a!');
    renderAll();
}

/* ============================================================
   üìã PH·∫¶N 12-16: C√ÅC MODULE KH√ÅC (Gi·ªØ nguy√™n logic t·ª´ V4.0)
   Do gi·ªõi h·∫°n k√Ω t·ª±, em t√≥m t·∫Øt c√°c h√†m ch√≠nh
   ============================================================ */

// ===== REGISTRATIONS =====
function openNewRegistrationModal() { /* ... logic nh∆∞ V4.0 ... */ 
    document.getElementById('regStudentId').value = '';
    document.getElementById('registrationForm').reset();
    populateRegStudentDropdown();
    renderPromotionCheckboxes();
    openModal('registrationModal');
}

function openRegistrationModalForStudent(studentId) {
    const student = students.find(s => s.id === studentId);
    if (!student) return;
    document.getElementById('regStudentId').value = studentId;
    document.getElementById('registrationForm').reset();
    populateRegStudentDropdown();
    document.getElementById('regStudentSelect').value = studentId;
    onRegStudentChange();
    renderPromotionCheckboxes();
    openModal('registrationModal');
}

function populateRegStudentDropdown() {
    const eligible = students.filter(s => s.status === 'Ch·ªù ƒêƒÉng K√Ω');
    document.getElementById('regStudentSelect').innerHTML = '<option value="">-- Ch·ªçn h·ªçc vi√™n --</option>' + 
        eligible.map(s => `<option value="${s.id}">${s.name} - ${s.parentPhone}</option>`).join('');
}

function onRegStudentChange() {
    const studentId = document.getElementById('regStudentSelect').value;
    const student = students.find(s => s.id === studentId);
    document.getElementById('regStudentId').value = studentId;
    if (student) {
        document.getElementById('regSubject').innerHTML = '<option value="">-- Ch·ªçn m√¥n --</option>' + 
            student.subjects.map(s => `<option value="${s}">${s}</option>`).join('');
    }
}

function loadPackagesForSubject() {
    const subject = document.getElementById('regSubject').value;
    const subjectPackages = packages.filter(p => p.subjectName === subject);
    document.getElementById('regPackage').innerHTML = '<option value="">-- Nh·∫≠p th·ªß c√¥ng --</option>' + 
        subjectPackages.map(p => `<option value="${p.id}">${p.name} - ${formatCurrency(p.fee)}</option>`).join('');
    
    const subjectInfo = subjects.find(s => s.name === subject);
    if (subjectInfo) {
        document.getElementById('regTuitionFee').value = formatNumberInput(subjectInfo.defaultFee);
        calculateFinalAmount();
    }
}

function applyPackageFee() {
    const pkgId = document.getElementById('regPackage').value;
    const pkg = packages.find(p => p.id === pkgId);
    if (pkg) {
        document.getElementById('regTuitionFee').value = formatNumberInput(pkg.fee);
        calculateFinalAmount();
    }
}

function renderPromotionCheckboxes() {
    const now = new Date();
    const active = promotions.filter(p => new Date(p.endDate) >= now);
    document.getElementById('regPromotionList').innerHTML = active.length === 0 
        ? '<p class="text-muted">Kh√¥ng c√≥ KM</p>'
        : active.map(p => `<label class="checkbox-item"><input type="checkbox" name="regPromotions" value="${p.id}" onchange="calculateFinalAmount()"> ${p.name} (${p.type === 'percent' ? p.value + '%' : formatCurrency(p.value)})</label>`).join('');
}

function calculateFinalAmount() {
    const tuition = parseCurrencyInput(document.getElementById('regTuitionFee').value);
    const selectedPromos = Array.from(document.querySelectorAll('input[name="regPromotions"]:checked')).map(cb => promotions.find(p => p.id === cb.value)).filter(p => p);
    
    let discount = 0;
    selectedPromos.forEach(p => { discount += p.type === 'percent' ? tuition * p.value / 100 : p.value; });
    
    const final = Math.max(tuition - discount, 0);
    document.getElementById('regDiscountAmount').value = discount > 0 ? '-' + formatCurrency(discount) : '';
    document.getElementById('regFinalAmount').value = formatCurrency(final);
}

function saveRegistration(event) {
    event.preventDefault();
    const studentId = document.getElementById('regStudentId').value;
    if (!studentId) { showNotification('Vui l√≤ng ch·ªçn h·ªçc vi√™n!', 'error'); return; }
    
    const student = students.find(s => s.id === studentId);
    const tuition = parseCurrencyInput(document.getElementById('regTuitionFee').value);
    const selectedPromoIds = Array.from(document.querySelectorAll('input[name="regPromotions"]:checked')).map(cb => cb.value);
    
    let discount = 0;
    selectedPromoIds.forEach(promoId => {
        const promo = promotions.find(p => p.id === promoId);
        if (promo) discount += promo.type === 'percent' ? tuition * promo.value / 100 : promo.value;
    });
    
    const finalAmount = Math.max(tuition - discount, 0);
    const regCode = generateRegCode();
    
    registrations.push({
        id: generateId(), regCode, studentId, studentName: student.name, parentName: student.parentName, parentPhone: student.parentPhone,
        subject: document.getElementById('regSubject').value, packageId: document.getElementById('regPackage').value || null,
        tuitionFee: tuition, promotionIds: selectedPromoIds, discountAmount: discount, finalAmount,
        registrationDate: new Date().toISOString().split('T')[0], createdAt: new Date().toISOString()
    });
    
    if (student && student.status === 'Ch·ªù ƒêƒÉng K√Ω') {
        student.status = 'ƒê√£ ƒêƒÉng K√Ω';
        saveData('students', students);
    }
    
    saveData('registrations', registrations);
    closeModal('registrationModal');
    showNotification(`T·∫°o phi·∫øu ƒêK th√†nh c√¥ng! M√£: ${regCode}`);
    renderAll();
}

function searchRegistrations() { paginationState.registrations.page = 1; renderRegistrationsTable(); }

function getFilteredRegistrations() {
    const searchTerm = document.getElementById('searchRegistration')?.value?.toLowerCase() || '';
    let filtered = [...registrations];
    if (searchTerm) filtered = filtered.filter(r => r.regCode.toLowerCase().includes(searchTerm) || r.studentName?.toLowerCase().includes(searchTerm));
    return filtered.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
}

function renderRegistrationsTable() {
    const filtered = getFilteredRegistrations();
    const { data, total, totalPages, currentPage } = getPaginatedData(filtered, 'registrations');
    const tbody = document.getElementById('registrationsTableBody');
    
    if (data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><div class="empty-state-icon">üìã</div><p>Kh√¥ng c√≥ phi·∫øu ƒêK</p></div></td></tr>`;
        renderPagination('registrationsPagination', 'registrations', 0, 0, 1);
        return;
    }
    
    tbody.innerHTML = data.map(r => `
        <tr>
            <td><strong class="text-primary">${r.regCode}</strong></td>
            <td>${r.studentName || 'N/A'}</td>
            <td><span class="subject-tag">${r.subject}</span><br><small class="text-muted">${formatCurrency(r.tuitionFee)}</small></td>
            <td class="text-danger">${r.discountAmount > 0 ? '-' + formatCurrency(r.discountAmount) : '-'}</td>
            <td><strong class="text-success">${formatCurrency(r.finalAmount)}</strong></td>
            <td>${formatDate(r.registrationDate)}</td>
            <td><div class="action-buttons">
                <button class="action-btn view" onclick="viewRegistration('${r.id}')" title="Xem">üëÅÔ∏è</button>
                ${canDelete('registrations') ? `<button class="action-btn delete" onclick="deleteRegistration('${r.id}')" title="X√≥a">üóëÔ∏è</button>` : ''}
            </div></td>
        </tr>
    `).join('');
    
    renderPagination('registrationsPagination', 'registrations', total, totalPages, currentPage);
}

function viewRegistration(id) {
    const reg = registrations.find(r => r.id === id);
    if (!reg) return;
    document.getElementById('registrationPreviewContent').innerHTML = `<div style="text-align:center;padding:20px;"><h3>${reg.regCode}</h3><p>${reg.studentName} - ${reg.subject}</p><p><strong>${formatCurrency(reg.finalAmount)}</strong></p></div>`;
    openModal('viewRegistrationModal');
}

function deleteRegistration(id) {
    if (!confirm('X√≥a phi·∫øu ƒêK n√†y?')) return;
    registrations = registrations.filter(r => r.id !== id);
    saveData('registrations', registrations);
    showNotification('ƒê√£ x√≥a!');
    renderRegistrationsTable();
}

function printRegistration() { window.print(); }
function downloadRegistrationPDF() { showNotification('ƒêang t·∫£i PDF...', 'info'); }

// ===== RECEIPTS =====
function openReceiptModal() {
    document.getElementById('editReceiptId').value = '';
    document.getElementById('receiptForm').reset();
    document.getElementById('receiptDate').value = new Date().toISOString().split('T')[0];
    populateReceiptStudentDropdown();
    openModal('receiptModal');
}

function openReceiptModalForStudent(studentId) {
    openReceiptModal();
    document.getElementById('receiptStudentId').value = studentId;
    fillReceiptStudentInfo();
}

function populateReceiptStudentDropdown() {
    const eligible = students.filter(s => s.status === 'ƒê√£ ƒêƒÉng K√Ω');
    document.getElementById('receiptStudentId').innerHTML = '<option value="">-- Ch·ªçn h·ªçc vi√™n --</option>' + 
        eligible.map(s => `<option value="${s.id}">${s.name} - ${s.parentPhone}</option>`).join('');
}

function fillReceiptStudentInfo() {
    const studentId = document.getElementById('receiptStudentId').value;
    const student = students.find(s => s.id === studentId);
    document.getElementById('receiptParentName').value = student?.parentName || '';
    document.getElementById('receiptParentPhone').value = student?.parentPhone || '';
    
    if (studentId) {
        const studentRegs = registrations.filter(r => r.studentId === studentId);
        document.getElementById('receiptRegistrationSelect').innerHTML = '<option value="">-- Ch·ªçn phi·∫øu ƒêK --</option>' +
            studentRegs.map(r => `<option value="${r.id}">${r.regCode} - ${formatCurrency(r.finalAmount)}</option>`).join('');
    }
}

function fillFromRegistration() {
    const regId = document.getElementById('receiptRegistrationSelect').value;
    const reg = registrations.find(r => r.id === regId);
    if (reg) {
        document.getElementById('receiptDescription').value = `H·ªçc ph√≠ ${reg.subject}`;
        document.getElementById('receiptAmount').value = formatNumberInput(reg.finalAmount);
    }
}

function saveReceipt(event) {
    event.preventDefault();
    const studentId = document.getElementById('receiptStudentId').value;
    const student = students.find(s => s.id === studentId);
    
    const data = {
        studentId,
        type: document.getElementById('receiptType').value,
        parentName: student?.parentName || '',
        parentPhone: student?.parentPhone || '',
        description: document.getElementById('receiptDescription').value.trim(),
        amount: parseCurrencyInput(document.getElementById('receiptAmount').value),
        date: document.getElementById('receiptDate').value,
        notes: document.getElementById('receiptNotes').value.trim()
    };
    
    receipts.push({ id: generateId(), ...data, createdAt: new Date().toISOString() });
    saveData('receipts', receipts);
    closeModal('receiptModal');
    showNotification('T·∫°o bi√™n lai th√†nh c√¥ng!');
    renderAll();
}

function searchReceipts() { paginationState.receipts.page = 1; renderReceiptsTable(); }

function getFilteredReceipts() {
    const searchTerm = document.getElementById('searchReceipt')?.value?.toLowerCase() || '';
    let filtered = [...receipts];
    if (searchTerm) {
        filtered = filtered.filter(r => {
            const student = students.find(s => s.id === r.studentId);
            return r.description.toLowerCase().includes(searchTerm) || student?.name.toLowerCase().includes(searchTerm);
        });
    }
    return filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
}

function renderReceiptsTable() {
    const filtered = getFilteredReceipts();
    const { data, total, totalPages, currentPage } = getPaginatedData(filtered, 'receipts');
    const tbody = document.getElementById('receiptsTableBody');
    
    if (data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><div class="empty-state-icon">üßæ</div><p>Kh√¥ng c√≥ bi√™n lai</p></div></td></tr>`;
        renderPagination('receiptsPagination', 'receipts', 0, 0, 1);
        return;
    }
    
    tbody.innerHTML = data.map((r, idx) => {
        const student = students.find(s => s.id === r.studentId);
        return `
            <tr>
                <td><strong>#${String(total - idx).padStart(4, '0')}</strong></td>
                <td><span class="subject-tag">${r.type}</span></td>
                <td>${student?.name || 'N/A'}</td>
                <td>${r.description}</td>
                <td><strong class="text-success">${formatCurrency(r.amount)}</strong></td>
                <td>${formatDate(r.date)}</td>
                <td><div class="action-buttons">
                    <button class="action-btn view" onclick="viewReceipt('${r.id}')" title="Xem">üëÅÔ∏è</button>
                    ${canDelete('receipts') ? `<button class="action-btn delete" onclick="deleteReceipt('${r.id}')" title="X√≥a">üóëÔ∏è</button>` : ''}
                </div></td>
            </tr>
        `;
    }).join('');
    
    renderPagination('receiptsPagination', 'receipts', total, totalPages, currentPage);
}

function viewReceipt(id) {
    const receipt = receipts.find(r => r.id === id);
    if (!receipt) return;
    document.getElementById('receiptPreviewContent').innerHTML = `<div style="text-align:center;padding:20px;"><h3>${receipt.type}</h3><p>${receipt.description}</p><p><strong>${formatCurrency(receipt.amount)}</strong></p></div>`;
    openModal('viewReceiptModal');
}

function deleteReceipt(id) {
    if (!confirm('X√≥a bi√™n lai n√†y?')) return;
    receipts = receipts.filter(r => r.id !== id);
    saveData('receipts', receipts);
    showNotification('ƒê√£ x√≥a!');
    renderReceiptsTable();
}

function printReceipt() { window.print(); }
function downloadReceiptPDF() { showNotification('ƒêang t·∫£i PDF...', 'info'); }

// ===== SUBJECTS, PACKAGES, PROMOTIONS =====
function renderSubjectsTable() {
    const tbody = document.getElementById('subjectsTableBody');
    tbody.innerHTML = subjects.map(s => `
        <tr>
            <td style="font-size: 24px;">${s.icon}</td>
            <td><strong>${s.name}</strong></td>
            <td>${formatCurrency(s.defaultFee)}</td>
            <td><div class="action-buttons">
                ${canEdit('subjects') ? `<button class="action-btn edit" onclick="editSubject('${s.id}')" title="S·ª≠a">‚úèÔ∏è</button>` : ''}
                ${canDelete('subjects') ? `<button class="action-btn delete" onclick="deleteSubject('${s.id}')" title="X√≥a">üóëÔ∏è</button>` : ''}
            </div></td>
        </tr>
    `).join('');
}

function openSubjectModal() {
    document.getElementById('editSubjectId').value = '';
    document.getElementById('subjectForm').reset();
    document.getElementById('subjectModalTitle').textContent = 'üìñ Th√™m M√¥n H·ªçc';
    openModal('subjectModal');
}

function editSubject(id) {
    const s = subjects.find(s => s.id === id);
    if (!s) return;
    document.getElementById('editSubjectId').value = s.id;
    document.getElementById('subjectIcon').value = s.icon;
    document.getElementById('subjectName').value = s.name;
    document.getElementById('subjectDefaultFee').value = formatNumberInput(s.defaultFee);
    document.getElementById('subjectModalTitle').textContent = '‚úèÔ∏è S·ª≠a M√¥n H·ªçc';
    openModal('subjectModal');
}

function saveSubject(event) {
    event.preventDefault();
    const editId = document.getElementById('editSubjectId').value;
    const data = { icon: document.getElementById('subjectIcon').value.trim(), name: document.getElementById('subjectName').value.trim(), defaultFee: parseCurrencyInput(document.getElementById('subjectDefaultFee').value) };
    
    if (editId) {
        const idx = subjects.findIndex(s => s.id === editId);
        if (idx !== -1) subjects[idx] = { ...subjects[idx], ...data };
        showNotification('C·∫≠p nh·∫≠t th√†nh c√¥ng!');
    } else {
        subjects.push({ id: generateId(), ...data });
        showNotification('Th√™m th√†nh c√¥ng!');
    }
    saveData('subjects', subjects);
    closeModal('subjectModal');
    renderSubjectsTable();
    renderSubjectCheckboxes();
}

function deleteSubject(id) {
    if (!confirm('X√≥a m√¥n h·ªçc n√†y?')) return;
    subjects = subjects.filter(s => s.id !== id);
    saveData('subjects', subjects);
    showNotification('ƒê√£ x√≥a!');
    renderSubjectsTable();
}

function renderPackagesTable() {
    const tbody = document.getElementById('packagesTableBody');
    tbody.innerHTML = packages.length === 0 ? `<tr><td colspan="5"><div class="empty-state"><p>Ch∆∞a c√≥ g√≥i</p></div></td></tr>` : packages.map(p => `
        <tr>
            <td><strong>${p.name}</strong></td>
            <td>${p.subjectName}</td>
            <td>${p.sessions} bu·ªïi</td>
            <td>${formatCurrency(p.fee)}</td>
            <td><div class="action-buttons">
                ${canEdit('packages') ? `<button class="action-btn edit" onclick="editPackage('${p.id}')" title="S·ª≠a">‚úèÔ∏è</button>` : ''}
                ${canDelete('packages') ? `<button class="action-btn delete" onclick="deletePackage('${p.id}')" title="X√≥a">üóëÔ∏è</button>` : ''}
            </div></td>
        </tr>
    `).join('');
}

function openPackageModal() {
    document.getElementById('editPackageId').value = '';
    document.getElementById('packageForm').reset();
    document.getElementById('packageModalTitle').textContent = 'üì¶ Th√™m G√≥i';
    document.getElementById('packageSubject').innerHTML = '<option value="">-- Ch·ªçn m√¥n --</option>' + subjects.map(s => `<option value="${s.name}">${s.icon} ${s.name}</option>`).join('');
    openModal('packageModal');
}

function editPackage(id) {
    const p = packages.find(p => p.id === id);
    if (!p) return;
    document.getElementById('editPackageId').value = p.id;
    document.getElementById('packageName').value = p.name;
    document.getElementById('packageSubject').innerHTML = '<option value="">-- Ch·ªçn m√¥n --</option>' + subjects.map(s => `<option value="${s.name}" ${s.name === p.subjectName ? 'selected' : ''}>${s.icon} ${s.name}</option>`).join('');
    document.getElementById('packageSessions').value = p.sessions;
    document.getElementById('packageFee').value = formatNumberInput(p.fee);
    document.getElementById('packageModalTitle').textContent = '‚úèÔ∏è S·ª≠a G√≥i';
    openModal('packageModal');
}

function savePackage(event) {
    event.preventDefault();
    const editId = document.getElementById('editPackageId').value;
    const data = { name: document.getElementById('packageName').value.trim(), subjectName: document.getElementById('packageSubject').value, sessions: parseInt(document.getElementById('packageSessions').value), fee: parseCurrencyInput(document.getElementById('packageFee').value) };
    
    if (editId) {
        const idx = packages.findIndex(p => p.id === editId);
        if (idx !== -1) packages[idx] = { ...packages[idx], ...data };
    } else {
        packages.push({ id: generateId(), ...data });
    }
    saveData('packages', packages);
    closeModal('packageModal');
    showNotification('L∆∞u th√†nh c√¥ng!');
    renderPackagesTable();
}

function deletePackage(id) {
    if (!confirm('X√≥a g√≥i n√†y?')) return;
    packages = packages.filter(p => p.id !== id);
    saveData('packages', packages);
    showNotification('ƒê√£ x√≥a!');
    renderPackagesTable();
}

function renderPromotionsTable() {
    const now = new Date();
    const tbody = document.getElementById('promotionsTableBody');
    tbody.innerHTML = promotions.length === 0 ? `<tr><td colspan="6"><div class="empty-state"><p>Ch∆∞a c√≥ KM</p></div></td></tr>` : promotions.map(p => {
        const expired = new Date(p.endDate) < now;
        return `
            <tr style="${expired ? 'opacity: 0.5;' : ''}">
                <td><strong>${p.name}</strong></td>
                <td>${p.type === 'percent' ? 'Gi·∫£m %' : 'Gi·∫£m VNƒê'}</td>
                <td>${p.type === 'percent' ? p.value + '%' : formatCurrency(p.value)}</td>
                <td>${formatDate(p.startDate)} - ${formatDate(p.endDate)}</td>
                <td>${expired ? '<span class="text-danger">H·∫øt h·∫°n</span>' : '<span class="text-success">Ho·∫°t ƒë·ªông</span>'}</td>
                <td><div class="action-buttons">
                    ${canEdit('promotions') ? `<button class="action-btn edit" onclick="editPromotion('${p.id}')" title="S·ª≠a">‚úèÔ∏è</button>` : ''}
                    ${canDelete('promotions') ? `<button class="action-btn delete" onclick="deletePromotion('${p.id}')" title="X√≥a">üóëÔ∏è</button>` : ''}
                </div></td>
            </tr>
        `;
    }).join('');
}

function openPromotionModal() {
    document.getElementById('editPromotionId').value = '';
    document.getElementById('promotionForm').reset();
    document.getElementById('promotionModalTitle').textContent = 'üéÅ Th√™m KM';
    document.getElementById('promotionStartDate').value = new Date().toISOString().split('T')[0];
    openModal('promotionModal');
}

function editPromotion(id) {
    const p = promotions.find(p => p.id === id);
    if (!p) return;
    document.getElementById('editPromotionId').value = p.id;
    document.getElementById('promotionName').value = p.name;
    document.getElementById('promotionType').value = p.type;
    document.getElementById('promotionValue').value = p.value;
    document.getElementById('promotionStartDate').value = p.startDate;
    document.getElementById('promotionEndDate').value = p.endDate;
    document.getElementById('promotionModalTitle').textContent = '‚úèÔ∏è S·ª≠a KM';
    openModal('promotionModal');
}

function savePromotion(event) {
    event.preventDefault();
    const editId = document.getElementById('editPromotionId').value;
    const data = { name: document.getElementById('promotionName').value.trim(), type: document.getElementById('promotionType').value, value: parseFloat(document.getElementById('promotionValue').value), startDate: document.getElementById('promotionStartDate').value, endDate: document.getElementById('promotionEndDate').value };
    
    if (editId) {
        const idx = promotions.findIndex(p => p.id === editId);
        if (idx !== -1) promotions[idx] = { ...promotions[idx], ...data };
    } else {
        promotions.push({ id: generateId(), ...data });
    }
    saveData('promotions', promotions);
    closeModal('promotionModal');
    showNotification('L∆∞u th√†nh c√¥ng!');
    renderPromotionsTable();
}

function deletePromotion(id) {
    if (!confirm('X√≥a KM n√†y?')) return;
    promotions = promotions.filter(p => p.id !== id);
    saveData('promotions', promotions);
    showNotification('ƒê√£ x√≥a!');
    renderPromotionsTable();
}

/* ============================================================
   üì§ PH·∫¶N 17: EXPORT & BACKUP
   ============================================================ */

function exportAllToExcel() {
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(students.map(s => ({ T√™n: s.name, Tu·ªïi: s.age, 'Ph·ª• huynh': s.parentName, SƒêT: s.parentPhone, 'M√¥n h·ªçc': s.subjects.join(', '), 'Tr·∫°ng th√°i': s.status }))), 'H·ªçc Vi√™n');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(registrations.map(r => ({ 'M√£ phi·∫øu': r.regCode, 'H·ªçc vi√™n': r.studentName, M√¥n: r.subject, 'Th√†nh ti·ªÅn': r.finalAmount, Ng√†y: r.registrationDate }))), 'Phi·∫øu ƒêK');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(receipts.map(r => ({ Lo·∫°i: r.type, 'N·ªôi dung': r.description, 'S·ªë ti·ªÅn': r.amount, Ng√†y: r.date }))), 'Bi√™n Lai');
    XLSX.writeFile(wb, `BaoCao_${formatDateFile()}.xlsx`);
    showNotification('Xu·∫•t Excel th√†nh c√¥ng!');
}

function exportStudentsToExcel() {
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(students.map(s => ({ T√™n: s.name, Tu·ªïi: s.age, 'Ph·ª• huynh': s.parentName, SƒêT: s.parentPhone, Email: s.parentEmail || '', 'M√¥n h·ªçc': s.subjects.join(', '), 'Tr·∫°ng th√°i': s.status }))), 'H·ªçc Vi√™n');
    XLSX.writeFile(wb, `HocVien_${formatDateFile()}.xlsx`);
    showNotification('Xu·∫•t th√†nh c√¥ng!');
}

function exportTrialStudentsToExcel() {
    const data = students.filter(s => s.status === 'H·ªçc Th·ª≠' || s.status === 'Ch·ªù ƒêƒÉng K√Ω');
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data.map(s => ({ T√™n: s.name, Tu·ªïi: s.age, 'Ph·ª• huynh': s.parentName, SƒêT: s.parentPhone, 'M√¥n h·ªçc': s.subjects.join(', '), 'Tr·∫°ng th√°i': s.status }))), 'H·ªçc Th·ª≠');
    XLSX.writeFile(wb, `HocThu_${formatDateFile()}.xlsx`);
    showNotification('Xu·∫•t th√†nh c√¥ng!');
}

function exportAppointmentsToExcel() {
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(appointments.map(a => { const s = students.find(st => st.id === a.studentId); return { 'H·ªçc vi√™n': s?.name || '', M√¥n: a.subject, Ng√†y: a.date, Gi·ªù: a.time }; })), 'L·ªãch H·∫πn');
    XLSX.writeFile(wb, `LichHen_${formatDateFile()}.xlsx`);
    showNotification('Xu·∫•t th√†nh c√¥ng!');
}

function exportRegistrationsToExcel() {
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(registrations.map(r => ({ 'M√£ phi·∫øu': r.regCode, 'H·ªçc vi√™n': r.studentName, M√¥n: r.subject, 'H·ªçc ph√≠': r.tuitionFee, 'Gi·∫£m': r.discountAmount, 'Th√†nh ti·ªÅn': r.finalAmount, Ng√†y: r.registrationDate }))), 'Phi·∫øu ƒêK');
    XLSX.writeFile(wb, `PhieuDK_${formatDateFile()}.xlsx`);
    showNotification('Xu·∫•t th√†nh c√¥ng!');
}

function exportReceiptsToExcel() {
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(receipts.map(r => ({ Lo·∫°i: r.type, 'N·ªôi dung': r.description, 'S·ªë ti·ªÅn': r.amount, Ng√†y: r.date }))), 'Bi√™n Lai');
    XLSX.writeFile(wb, `BienLai_${formatDateFile()}.xlsx`);
    showNotification('Xu·∫•t th√†nh c√¥ng!');
}

function exportBackupJSON() {
    const backup = { version: '4.0', exportDate: new Date().toISOString(), data: { users, permissions, students, appointments, registrations, receipts, subjects, packages, promotions, centerInfo, bankInfo } };
    const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Backup_${formatDateFile()}.json`; a.click();
    showNotification('T·∫£i backup th√†nh c√¥ng!');
}

function restoreFromJSON(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const backup = JSON.parse(e.target.result);
            if (!backup.data) throw new Error('File kh√¥ng h·ª£p l·ªá!');
            if (!confirm('Ghi ƒë√® to√†n b·ªô d·ªØ li·ªáu?')) return;
            
            if (backup.data.users) { users = backup.data.users; saveData('users', users); }
            if (backup.data.permissions) { permissions = backup.data.permissions; saveData('permissions', permissions); }
            students = backup.data.students || [];
            appointments = backup.data.appointments || [];
            registrations = backup.data.registrations || [];
            receipts = backup.data.receipts || [];
            subjects = backup.data.subjects || subjects;
            packages = backup.data.packages || [];
            promotions = backup.data.promotions || [];
            centerInfo = backup.data.centerInfo || {};
            bankInfo = backup.data.bankInfo || {};
            
            ['students', 'appointments', 'registrations', 'receipts', 'subjects', 'packages', 'promotions'].forEach(key => saveData(key, eval(key)));
            saveData('centerInfo', centerInfo);
            saveData('bankInfo', bankInfo);
            
            renderAll();
            showNotification('Kh√¥i ph·ª•c th√†nh c√¥ng!');
        } catch (err) { showNotification('L·ªói: ' + err.message, 'error'); }
    };
    reader.readAsText(file);
    event.target.value = '';
}

function importFromExcel(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const wb = XLSX.read(e.target.result, { type: 'binary' });
            const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            if (!confirm(`Import ${data.length} d√≤ng?`)) return;
            
            data.forEach(row => {
                if (!students.find(s => s.parentPhone === row['SƒêT'])) {
                    students.push({
                        id: generateId(), name: row['T√™n'] || '', age: parseInt(row['Tu·ªïi']) || 0,
                        parentName: row['Ph·ª• huynh'] || '', parentPhone: row['SƒêT'] || '', parentEmail: row['Email'] || '',
                        subjects: (row['M√¥n h·ªçc'] || '').split(',').map(s => s.trim()).filter(s => s),
                        status: row['Tr·∫°ng th√°i'] || 'H·ªçc Th·ª≠', notes: '', previousStatus: null,
                        createdAt: new Date().toISOString(), updatedAt: new Date().toISOString()
                    });
                }
            });
            saveData('students', students);
            renderAll();
            showNotification('Import th√†nh c√¥ng!');
        } catch (err) { showNotification('L·ªói: ' + err.message, 'error'); }
    };
    reader.readAsBinaryString(file);
    event.target.value = '';
}

function createAutoBackup() {
    const backup = { id: generateId(), date: new Date().toISOString(), type: 'auto', data: { students, appointments, registrations, receipts, subjects, packages, promotions } };
    backupHistory.unshift(backup);
    if (backupHistory.length > 10) backupHistory = backupHistory.slice(0, 10);
    localStorage.setItem('backupHistory', JSON.stringify(backupHistory));
}

function createManualBackup() {
    const backup = { id: generateId(), date: new Date().toISOString(), type: 'manual', data: { students, appointments, registrations, receipts, subjects, packages, promotions } };
    backupHistory.unshift(backup);
    if (backupHistory.length > 10) backupHistory = backupHistory.slice(0, 10);
    localStorage.setItem('backupHistory', JSON.stringify(backupHistory));
    renderBackupHistory();
    showNotification('Backup th√†nh c√¥ng!');
}

function toggleAutoBackup() {
    autoBackupEnabled = document.getElementById('autoBackupToggle').checked;
    localStorage.setItem('autoBackupEnabled', autoBackupEnabled);
    updateAutoBackupStatus();
}

function updateAutoBackupStatus() {
    document.getElementById('autoBackupStatus').innerHTML = autoBackupEnabled ? '<span class="text-success">‚úÖ ƒêang ho·∫°t ƒë·ªông</span>' : '<span class="text-danger">‚ùå ƒê√£ t·∫Øt</span>';
}

function renderBackupHistory() {
    const container = document.getElementById('backupHistoryList');
    container.innerHTML = backupHistory.length === 0 ? '<p class="text-muted">Ch∆∞a c√≥ backup</p>' : backupHistory.slice(0, 5).map(b => `
        <div style="background: var(--bg-light); padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
            <div><strong>${b.type === 'auto' ? 'üîÑ T·ª± ƒë·ªông' : 'üíæ Th·ªß c√¥ng'}</strong><br><small class="text-muted">${new Date(b.date).toLocaleString('vi-VN')}</small></div>
            <button class="btn btn-sm btn-info" onclick="restoreFromBackupHistory('${b.id}')">Kh√¥i ph·ª•c</button>
        </div>
    `).join('');
}

function restoreFromBackupHistory(id) {
    const backup = backupHistory.find(b => b.id === id);
    if (!backup || !confirm('Kh√¥i ph·ª•c t·ª´ backup n√†y?')) return;
    
    students = backup.data.students || [];
    appointments = backup.data.appointments || [];
    registrations = backup.data.registrations || [];
    receipts = backup.data.receipts || [];
    subjects = backup.data.subjects || subjects;
    packages = backup.data.packages || [];
    promotions = backup.data.promotions || [];
    
    ['students', 'appointments', 'registrations', 'receipts', 'subjects', 'packages', 'promotions'].forEach(key => saveData(key, eval(key)));
    renderAll();
    showNotification('Kh√¥i ph·ª•c th√†nh c√¥ng!');
}

/* ============================================================
   ‚öôÔ∏è PH·∫¶N 18: SETTINGS
   ============================================================ */

function saveCenterInfo(event) {
    event.preventDefault();
    centerInfo = { name: document.getElementById('centerName').value.trim(), phone: document.getElementById('centerPhone').value.trim(), address: document.getElementById('centerAddress').value.trim(), email: document.getElementById('centerEmail').value.trim(), website: document.getElementById('centerWebsite').value.trim(), logo: centerInfo.logo || '' };
    saveData('centerInfo', centerInfo);
    showNotification('L∆∞u th√†nh c√¥ng!');
}

function loadCenterInfo() {
    document.getElementById('centerName').value = centerInfo.name || '';
    document.getElementById('centerPhone').value = centerInfo.phone || '';
    document.getElementById('centerAddress').value = centerInfo.address || '';
    document.getElementById('centerEmail').value = centerInfo.email || '';
    document.getElementById('centerWebsite').value = centerInfo.website || '';
    if (centerInfo.logo) document.getElementById('logoPreview').innerHTML = `<img src="${centerInfo.logo}">`;
}

function previewLogo(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        centerInfo.logo = e.target.result;
        document.getElementById('logoPreview').innerHTML = `<img src="${e.target.result}">`;
    };
    reader.readAsDataURL(file);
}

function saveBankInfo(event) {
    event.preventDefault();
    bankInfo = { bankName: document.getElementById('bankName').value.trim(), accountNumber: document.getElementById('bankAccount').value.trim(), accountName: document.getElementById('bankAccountName').value.trim(), branch: document.getElementById('bankBranch').value.trim() };
    saveData('bankInfo', bankInfo);
    generateBankQR();
    showNotification('L∆∞u th√†nh c√¥ng!');
}

function loadBankInfo() {
    document.getElementById('bankName').value = bankInfo.bankName || '';
    document.getElementById('bankAccount').value = bankInfo.accountNumber || '';
    document.getElementById('bankAccountName').value = bankInfo.accountName || '';
    document.getElementById('bankBranch').value = bankInfo.branch || '';
    document.getElementById('autoBackupToggle').checked = autoBackupEnabled;
    updateAutoBackupStatus();
    generateBankQR();
}

function generateBankQR() {
    const container = document.getElementById('bankQRCode');
    if (!bankInfo.accountNumber || !bankInfo.bankName) {
        container.innerHTML = '<p class="text-muted">Nh·∫≠p th√¥ng tin ng√¢n h√†ng ƒë·ªÉ t·∫°o QR</p>';
        return;
    }
    
    // T·∫°o n·ªôi dung QR (VietQR format ƒë∆°n gi·∫£n)
    const qrContent = `${bankInfo.bankName}|${bankInfo.accountNumber}|${bankInfo.accountName || ''}`;
    
    container.innerHTML = '';
    try {
        new QRCode(container, {
            text: qrContent,
            width: 150,
            height: 150,
            colorDark: '#2C3E50',
            colorLight: '#ffffff'
        });
    } catch (e) {
        container.innerHTML = '<p class="text-muted">Kh√¥ng th·ªÉ t·∫°o QR</p>';
    }
}

function clearAllData() {
    if (!confirm('‚ö†Ô∏è C·∫¢NH B√ÅO: X√≥a TO√ÄN B·ªò d·ªØ li·ªáu?\n\nH√†nh ƒë·ªông n√†y KH√îNG TH·ªÇ ho√†n t√°c!\n\nB·∫°n c√≥ ch·∫Øc ch·∫Øn?')) return;
    if (!confirm('X√°c nh·∫≠n l·∫ßn cu·ªëi: X√ìA T·∫§T C·∫¢?')) return;
    
    // X√≥a T·∫§T C·∫¢ d·ªØ li·ªáu (gi·ªØ l·∫°i users v√† permissions)
    students = [];
    appointments = [];
    registrations = [];
    receipts = [];
    packages = [];
    promotions = [];
    backupHistory = [];
    
    // X√≥a th√™m ph·∫ßn ƒê√†o t·∫°o
    teachers = [];
    classes = [];
    classSchedules = [];
    classStudents = [];
    attendances = [];
    makeupRequests = [];
    
    // L∆∞u v√†o localStorage
    const keysToReset = [
        'students', 'appointments', 'registrations', 'receipts', 
        'packages', 'promotions', 'backupHistory',
        'teachers', 'classes', 'classSchedules', 'classStudents',
        'attendances', 'makeupRequests'
    ];
    
    keysToReset.forEach(key => {
        localStorage.setItem(key, JSON.stringify([]));
    });
    
    // Reset centerInfo v√† bankInfo
    centerInfo = {};
    bankInfo = {};
    localStorage.setItem('centerInfo', JSON.stringify({}));
    localStorage.setItem('bankInfo', JSON.stringify({}));
    
    showNotification('ƒê√£ x√≥a to√†n b·ªô d·ªØ li·ªáu!', 'warning');
    renderAll();
}

function clearDemoData() {
    if (!confirm('‚ö†Ô∏è X√≥a d·ªØ li·ªáu DEMO?\n\nS·∫Ω x√≥a: H·ªçc vi√™n, L·ªãch h·∫πn, Phi·∫øu ƒêK, Bi√™n lai, Gi√°o vi√™n, L·ªõp h·ªçc, ƒêi·ªÉm danh, H·ªçc b√π.\n\nGi·ªØ l·∫°i: T√†i kho·∫£n, Ph√¢n quy·ªÅn, M√¥n h·ªçc, C√†i ƒë·∫∑t.\n\nB·∫°n c√≥ ch·∫Øc ch·∫Øn?')) return;
    
    // X√≥a d·ªØ li·ªáu demo (gi·ªØ l·∫°i c·∫•u h√¨nh h·ªá th·ªëng)
    students = [];
    appointments = [];
    registrations = [];
    receipts = [];
    
    // X√≥a ph·∫ßn ƒê√†o t·∫°o
    teachers = [];
    classes = [];
    classSchedules = [];
    classStudents = [];
    attendances = [];
    makeupRequests = [];
    
    // L∆∞u v√†o localStorage
    const keysToReset = [
        'students', 'appointments', 'registrations', 'receipts',
        'teachers', 'classes', 'classSchedules', 'classStudents',
        'attendances', 'makeupRequests'
    ];
    
    keysToReset.forEach(key => {
        localStorage.setItem(key, JSON.stringify([]));
    });
    
    showNotification('ƒê√£ x√≥a d·ªØ li·ªáu demo! Gi·ªØ l·∫°i: T√†i kho·∫£n, M√¥n h·ªçc, G√≥i h·ªçc ph√≠, Khuy·∫øn m√£i, C√†i ƒë·∫∑t.', 'success');
    renderAll();
}

/* ============================================================
   üîß PH·∫¶N 19: UTILITY FUNCTIONS (H√†m ti·ªán √≠ch)
   ============================================================ */

// ===== 19.1 Format ti·ªÅn t·ªá =====
function formatCurrency(amount) {
    if (amount === null || amount === undefined || isNaN(amount)) return '0 ‚Ç´';
    return new Intl.NumberFormat('vi-VN').format(amount) + ' ‚Ç´';
}

function formatCurrencyShort(amount) {
    if (amount === null || amount === undefined || isNaN(amount)) return '0';
    if (amount >= 1000000000) return (amount / 1000000000).toFixed(1) + 't·ª∑';
    if (amount >= 1000000) return (amount / 1000000).toFixed(1) + 'tr';
    if (amount >= 1000) return (amount / 1000).toFixed(0) + 'k';
    return amount.toString();
}

function formatNumberInput(number) {
    if (!number && number !== 0) return '';
    return new Intl.NumberFormat('vi-VN').format(number);
}

function parseCurrencyInput(value) {
    if (!value) return 0;
    // Lo·∫°i b·ªè t·∫•t c·∫£ k√Ω t·ª± kh√¥ng ph·∫£i s·ªë
    const cleaned = value.toString().replace(/[^\d]/g, '');
    return parseInt(cleaned) || 0;
}

function formatCurrencyInput(input) {
    // L·∫•y v·ªã tr√≠ con tr·ªè
    const cursorPos = input.selectionStart;
    const oldLength = input.value.length;
    
    // Parse v√† format l·∫°i
    const value = parseCurrencyInput(input.value);
    input.value = value > 0 ? formatNumberInput(value) : '';
    
    // ƒêi·ªÅu ch·ªânh v·ªã tr√≠ con tr·ªè
    const newLength = input.value.length;
    const newPos = cursorPos + (newLength - oldLength);
    input.setSelectionRange(newPos, newPos);
}

// ===== 19.2 Format ng√†y th√°ng =====
function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return dateString;
    return date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
}

function formatDateTime(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return dateString;
    return date.toLocaleString('vi-VN', { 
        day: '2-digit', month: '2-digit', year: 'numeric',
        hour: '2-digit', minute: '2-digit'
    });
}

function formatDateFile() {
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth() + 1).padStart(2, '0');
    const d = String(now.getDate()).padStart(2, '0');
    const h = String(now.getHours()).padStart(2, '0');
    const min = String(now.getMinutes()).padStart(2, '0');
    return `${y}${m}${d}_${h}${min}`;
}

/* ============================================================
   üìÑ PH·∫¶N 20: PAGINATION (Ph√¢n trang)
   ============================================================ */

function getPaginatedData(data, stateKey) {
    const state = paginationState[stateKey];
    if (!state) return { data: data, total: data.length, totalPages: 1, currentPage: 1 };
    
    const total = data.length;
    const totalPages = Math.ceil(total / state.pageSize) || 1;
    const currentPage = Math.min(state.page, totalPages);
    
    const startIndex = (currentPage - 1) * state.pageSize;
    const endIndex = startIndex + state.pageSize;
    const paginatedData = data.slice(startIndex, endIndex);
    
    return {
        data: paginatedData,
        total: total,
        totalPages: totalPages,
        currentPage: currentPage
    };
}

function renderPagination(containerId, stateKey, total, totalPages, currentPage) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    const state = paginationState[stateKey];
    if (!state) return;
    
    const startItem = total === 0 ? 0 : (currentPage - 1) * state.pageSize + 1;
    const endItem = Math.min(currentPage * state.pageSize, total);
    
    let paginationHTML = '';
    
    // N√∫t Previous
    paginationHTML += `<button ${currentPage <= 1 ? 'disabled' : ''} onclick="changePage('${stateKey}', ${currentPage - 1})">‚Äπ</button>`;
    
    // C√°c n√∫t s·ªë trang
    const maxButtons = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
    let endPage = Math.min(totalPages, startPage + maxButtons - 1);
    
    if (endPage - startPage + 1 < maxButtons) {
        startPage = Math.max(1, endPage - maxButtons + 1);
    }
    
    if (startPage > 1) {
        paginationHTML += `<button onclick="changePage('${stateKey}', 1)">1</button>`;
        if (startPage > 2) paginationHTML += `<button disabled>...</button>`;
    }
    
    for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `<button class="${i === currentPage ? 'active' : ''}" onclick="changePage('${stateKey}', ${i})">${i}</button>`;
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) paginationHTML += `<button disabled>...</button>`;
        paginationHTML += `<button onclick="changePage('${stateKey}', ${totalPages})">${totalPages}</button>`;
    }
    
    // N√∫t Next
    paginationHTML += `<button ${currentPage >= totalPages ? 'disabled' : ''} onclick="changePage('${stateKey}', ${currentPage + 1})">‚Ä∫</button>`;
    
    container.innerHTML = `
        <div class="pagination-info">Hi·ªÉn th·ªã ${startItem}-${endItem} / ${total}</div>
        <div class="pagination">${paginationHTML}</div>
        <div class="page-size-select">
            Hi·ªÉn th·ªã: 
            <select onchange="changePageSize('${stateKey}', this.value)">
                ${CONFIG.PAGE_SIZE_OPTIONS.map(size => 
                    `<option value="${size}" ${size === state.pageSize ? 'selected' : ''}>${size}</option>`
                ).join('')}
            </select>
        </div>
    `;
}

function changePage(stateKey, page) {
    if (paginationState[stateKey]) {
        paginationState[stateKey].page = page;
        renderTabContent(stateKey);
    }
}

function changePageSize(stateKey, size) {
    if (paginationState[stateKey]) {
        paginationState[stateKey].pageSize = parseInt(size);
        paginationState[stateKey].page = 1;
        renderTabContent(stateKey);
    }
}

/* ============================================================
   üöÄ PH·∫¶N 21: RENDER ALL & INITIALIZATION
   ============================================================ */
/* ============================================================
   üë®‚Äçüè´ PH·∫¶N 23: QU·∫¢N L√ù GI√ÅO VI√äN
   ============================================================ */

// ===== 23.1 Render b·∫£ng gi√°o vi√™n =====
function renderTeachersTable() {
    const tbody = document.getElementById('teachersTableBody');
    const searchTerm = document.getElementById('searchTeacher')?.value?.toLowerCase() || '';
    
    let filtered = teachers.filter(t => 
        t.fullName.toLowerCase().includes(searchTerm) || 
        t.phone.includes(searchTerm)
    );
    
    if (filtered.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><div class="empty-state-icon">üë®‚Äçüè´</div><p>Ch∆∞a c√≥ gi√°o vi√™n n√†o</p></div></td></tr>`;
        return;
    }
    
    tbody.innerHTML = filtered.map(t => `
        <tr>
            <td><strong>${t.fullName}</strong></td>
            <td>${t.phone}</td>
            <td>${t.subjects.map(s => `<span class="subject-tag">${getSubjectIcon(s)} ${s}</span>`).join(' ')}</td>
            <td>${getSalaryTypeLabel(t.salaryType)}</td>
            <td><span class="status-badge ${t.status === 'active' ? 'active' : 'locked'}">${t.status === 'active' ? 'üü¢ ƒêang d·∫°y' : '‚ö´ Ngh·ªâ'}</span></td>
            <td>
                <div class="action-buttons">
                    <button class="action-btn view" onclick="viewTeacher('${t.id}')" title="Xem">üëÅÔ∏è</button>
                    ${canEdit('teachers') ? `<button class="action-btn edit" onclick="editTeacher('${t.id}')" title="S·ª≠a">‚úèÔ∏è</button>` : ''}
                    ${canDelete('teachers') ? `<button class="action-btn delete" onclick="deleteTeacher('${t.id}')" title="X√≥a">üóëÔ∏è</button>` : ''}
                </div>
            </td>
        </tr>
    `).join('');
}

function getSubjectIcon(subjectName) {
    const subject = subjects.find(s => s.name === subjectName);
    return subject ? subject.icon : 'üìñ';
}

function getSalaryTypeLabel(type) {
    const labels = {
        'fixed': 'üí∞ C·ªë ƒë·ªãnh',
        'per_session': 'üíµ Theo bu·ªïi',
        'both': 'üí≥ C·ªë ƒë·ªãnh + Bu·ªïi'
    };
    return labels[type] || type;
}

function searchTeachers() {
    renderTeachersTable();
}

// ===== 23.2 Modal Gi√°o vi√™n =====
function openTeacherModal() {
    document.getElementById('editTeacherId').value = '';
    document.getElementById('teacherForm').reset();
    document.getElementById('teacherModalTitle').textContent = 'üë®‚Äçüè´ Th√™m Gi√°o Vi√™n';
    document.getElementById('teacherSalaryType').value = 'per_session';
    toggleSalaryFields();
    renderTeacherSubjectsCheckboxes();
    openModal('teacherModal');
}

function renderTeacherSubjectsCheckboxes() {
    document.getElementById('teacherSubjectsCheckboxes').innerHTML = subjects.map(s => 
        `<label class="checkbox-item"><input type="checkbox" name="teacherSubjects" value="${s.name}"> ${s.icon} ${s.name}</label>`
    ).join('');
}

function toggleSalaryFields() {
    const type = document.getElementById('teacherSalaryType').value;
    document.getElementById('fixedSalaryGroup').style.display = (type === 'fixed' || type === 'both') ? 'block' : 'none';
    document.getElementById('perSessionGroup').style.display = (type === 'per_session' || type === 'both') ? 'block' : 'none';
}

function editTeacher(id) {
    const teacher = teachers.find(t => t.id === id);
    if (!teacher) return;
    
    document.getElementById('editTeacherId').value = teacher.id;
    document.getElementById('teacherFullName').value = teacher.fullName;
    document.getElementById('teacherPhone').value = teacher.phone;
    document.getElementById('teacherEmail').value = teacher.email || '';
    document.getElementById('teacherSalaryType').value = teacher.salaryType;
    document.getElementById('teacherFixedSalary').value = teacher.fixedSalary ? formatNumberInput(teacher.fixedSalary) : '';
    document.getElementById('teacherPerSession').value = teacher.perSessionRate ? formatNumberInput(teacher.perSessionRate) : '';
    document.getElementById('teacherNotes').value = teacher.notes || '';
    
    renderTeacherSubjectsCheckboxes();
    document.querySelectorAll('input[name="teacherSubjects"]').forEach(cb => {
        cb.checked = teacher.subjects.includes(cb.value);
    });
    
    toggleSalaryFields();
    document.getElementById('teacherModalTitle').textContent = '‚úèÔ∏è S·ª≠a Gi√°o Vi√™n';
    openModal('teacherModal');
}

function saveTeacher(event) {
    event.preventDefault();
    
    const selectedSubjects = Array.from(document.querySelectorAll('input[name="teacherSubjects"]:checked')).map(cb => cb.value);
    if (selectedSubjects.length === 0) {
        showNotification('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 m√¥n d·∫°y!', 'error');
        return;
    }
    
    const editId = document.getElementById('editTeacherId').value;
    const data = {
        fullName: document.getElementById('teacherFullName').value.trim(),
        phone: document.getElementById('teacherPhone').value.trim(),
        email: document.getElementById('teacherEmail').value.trim(),
        subjects: selectedSubjects,
        salaryType: document.getElementById('teacherSalaryType').value,
        fixedSalary: parseCurrencyInput(document.getElementById('teacherFixedSalary').value),
        perSessionRate: parseCurrencyInput(document.getElementById('teacherPerSession').value),
        notes: document.getElementById('teacherNotes').value.trim(),
        status: 'active'
    };
    
    if (editId) {
        const index = teachers.findIndex(t => t.id === editId);
        if (index !== -1) {
            teachers[index] = { ...teachers[index], ...data, updatedAt: new Date().toISOString() };
            showNotification('C·∫≠p nh·∫≠t gi√°o vi√™n th√†nh c√¥ng!', 'success');
        }
    } else {
        teachers.push({ id: generateId(), ...data, createdAt: new Date().toISOString() });
        showNotification('Th√™m gi√°o vi√™n th√†nh c√¥ng!', 'success');
    }
    
    saveData('teachers', teachers);
    closeModal('teacherModal');
    renderTeachersTable();
}

function deleteTeacher(id) {
    const teacher = teachers.find(t => t.id === id);
    if (!teacher) return;
    
    // Ki·ªÉm tra GV c√≥ ƒëang d·∫°y l·ªõp n√†o kh√¥ng
    const teachingClasses = classes.filter(c => c.teacherId === id && c.status === 'active');
    if (teachingClasses.length > 0) {
        showNotification(`Kh√¥ng th·ªÉ x√≥a! GV ƒëang d·∫°y ${teachingClasses.length} l·ªõp.`, 'error');
        return;
    }
    
    if (!confirm(`X√≥a gi√°o vi√™n "${teacher.fullName}"?`)) return;
    
    teachers = teachers.filter(t => t.id !== id);
    saveData('teachers', teachers);
    showNotification('ƒê√£ x√≥a gi√°o vi√™n!', 'success');
    renderTeachersTable();
}

function viewTeacher(id) {
    const teacher = teachers.find(t => t.id === id);
    if (!teacher) return;
    
    const teacherClasses = classes.filter(c => c.teacherId === id);
    
    let scheduleHTML = '';
    teacherClasses.forEach(cls => {
        const clsSchedules = classSchedules.filter(s => s.classId === cls.id);
        clsSchedules.forEach(sch => {
            scheduleHTML += `<div class="quick-view-row"><span class="quick-view-label">${cls.className}</span><span class="quick-view-value">${getDayName(sch.dayOfWeek)} ${sch.startTime}-${sch.endTime}</span></div>`;
        });
    });
    
    document.getElementById('viewTeacherContent').innerHTML = `
        <div class="quick-view-section">
            <h4>üë§ Th√¥ng tin c√° nh√¢n</h4>
            <div class="quick-view-row"><span class="quick-view-label">H·ªç t√™n:</span><span class="quick-view-value"><strong>${teacher.fullName}</strong></span></div>
            <div class="quick-view-row"><span class="quick-view-label">ƒêi·ªán tho·∫°i:</span><span class="quick-view-value">${teacher.phone}</span></div>
            <div class="quick-view-row"><span class="quick-view-label">Email:</span><span class="quick-view-value">${teacher.email || '-'}</span></div>
            <div class="quick-view-row"><span class="quick-view-label">M√¥n d·∫°y:</span><span class="quick-view-value">${teacher.subjects.map(s => `<span class="subject-tag">${getSubjectIcon(s)} ${s}</span>`).join(' ')}</span></div>
        </div>
        <div class="quick-view-section">
            <h4>üí∞ Th√¥ng tin l∆∞∆°ng</h4>
            <div class="quick-view-row"><span class="quick-view-label">Lo·∫°i l∆∞∆°ng:</span><span class="quick-view-value">${getSalaryTypeLabel(teacher.salaryType)}</span></div>
            ${teacher.fixedSalary ? `<div class="quick-view-row"><span class="quick-view-label">L∆∞∆°ng c·ªë ƒë·ªãnh:</span><span class="quick-view-value">${formatCurrency(teacher.fixedSalary)}/th√°ng</span></div>` : ''}
            ${teacher.perSessionRate ? `<div class="quick-view-row"><span class="quick-view-label">Ti·ªÅn/bu·ªïi:</span><span class="quick-view-value">${formatCurrency(teacher.perSessionRate)}</span></div>` : ''}
        </div>
        <div class="quick-view-section">
            <h4>üìö L·ªõp ƒëang d·∫°y (${teacherClasses.length})</h4>
            ${teacherClasses.length === 0 ? '<p class="text-muted">Ch∆∞a c√≥ l·ªõp</p>' : teacherClasses.map(c => `
                <div class="quick-view-row">
                    <span class="quick-view-label">${c.className}</span>
                    <span class="quick-view-value">${getClassStatusBadge(c.status)}</span>
                </div>
            `).join('')}
        </div>
        <div class="quick-view-section">
            <h4>üìÖ L·ªãch d·∫°y trong tu·∫ßn</h4>
            ${scheduleHTML || '<p class="text-muted">Ch∆∞a c√≥ l·ªãch</p>'}
        </div>
    `;
    openModal('viewTeacherModal');
}

/* ============================================================
   üìö PH·∫¶N 24: QU·∫¢N L√ù L·ªöP H·ªåC
   ============================================================ */

// ===== 24.1 Render b·∫£ng l·ªõp h·ªçc =====
function renderClassesTable() {
    const tbody = document.getElementById('classesTableBody');
    const searchTerm = document.getElementById('searchClass')?.value?.toLowerCase() || '';
    const filterSubject = document.getElementById('filterClassSubject')?.value || '';
    const filterTeacher = document.getElementById('filterClassTeacher')?.value || '';
    const filterStatus = document.getElementById('filterClassStatus')?.value || '';
    
    let filtered = classes.filter(c => {
        if (searchTerm && !c.className.toLowerCase().includes(searchTerm)) return false;
        if (filterSubject && c.subjectId !== filterSubject) return false;
        if (filterTeacher && c.teacherId !== filterTeacher) return false;
        if (filterStatus && c.status !== filterStatus) return false;
        return true;
    });
    
    if (filtered.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><div class="empty-state-icon">üìö</div><p>Ch∆∞a c√≥ l·ªõp h·ªçc n√†o</p></div></td></tr>`;
        return;
    }
    
    tbody.innerHTML = filtered.map(c => {
        const subject = subjects.find(s => s.id === c.subjectId);
        const teacher = teachers.find(t => t.id === c.teacherId);
        const clsSchedules = classSchedules.filter(s => s.classId === c.id && s.isActive);
        const studentCount = classStudents.filter(cs => cs.classId === c.id && cs.status === 'active').length;
        
        return `
            <tr>
                <td><strong>${c.className}</strong></td>
                <td>${subject ? `${subject.icon} ${subject.name}` : '-'}</td>
                <td>${teacher ? teacher.fullName : '<span class="text-muted">Ch∆∞a c√≥</span>'}</td>
                <td>${c.classType === 'group' ? 'üë• Nh√≥m' : 'üë§ 1-1'}</td>
                <td><strong>${studentCount}</strong>/${c.maxStudents}</td>
                <td>${formatSchedules(clsSchedules)}</td>
                <td>${getClassStatusBadge(c.status)}</td>
                <td>
                    <div class="action-buttons">
                        <button class="action-btn view" onclick="viewClass('${c.id}')" title="Xem">üëÅÔ∏è</button>
                        ${canEdit('classes') ? `<button class="action-btn edit" onclick="editClass('${c.id}')" title="S·ª≠a">‚úèÔ∏è</button>` : ''}
                        ${canDelete('classes') ? `<button class="action-btn delete" onclick="deleteClass('${c.id}')" title="X√≥a">üóëÔ∏è</button>` : ''}
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function formatSchedules(schedules) {
    if (!schedules || schedules.length === 0) return '<span class="text-muted">Ch∆∞a c√≥ l·ªãch</span>';
    
    const grouped = {};
    schedules.forEach(s => {
        const time = `${s.startTime}-${s.endTime}`;
        if (!grouped[time]) grouped[time] = [];
        grouped[time].push(getDayShort(s.dayOfWeek));
    });
    
    return Object.entries(grouped).map(([time, days]) => 
        `<small>${days.join(',')} ${time}</small>`
    ).join('<br>');
}

function getDayName(dayOfWeek) {
    const days = ['', 'Th·ª© 2', 'Th·ª© 3', 'Th·ª© 4', 'Th·ª© 5', 'Th·ª© 6', 'Th·ª© 7', 'CN'];
    return days[dayOfWeek] || '';
}

function getDayShort(dayOfWeek) {
    const days = ['', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'CN'];
    return days[dayOfWeek] || '';
}

function getClassStatusBadge(status) {
    const badges = {
        'new': '<span class="status-badge hoc-thu">üÜï L·ªõp m·ªõi</span>',
        'active': '<span class="status-badge da-dk">üü¢ ƒêang h·ªçc</span>',
        'completed': '<span class="status-badge hoan-thanh">‚úÖ Ho√†n th√†nh</span>',
        'cancelled': '<span class="status-badge cancel">‚ùå ƒê√£ h·ªßy</span>'
    };
    return badges[status] || status;
}

function searchClasses() {
    renderClassesTable();
}

function filterClasses() {
    renderClassesTable();
}

// ===== 24.2 Populate filter dropdowns =====
function populateClassFilters() {
    // Filter m√¥n h·ªçc
    const subjectFilter = document.getElementById('filterClassSubject');
    if (subjectFilter) {
        subjectFilter.innerHTML = '<option value="">üìñ T·∫•t c·∫£ m√¥n h·ªçc</option>' +
            subjects.map(s => `<option value="${s.id}">${s.icon} ${s.name}</option>`).join('');
    }
    
    // Filter gi√°o vi√™n
    const teacherFilter = document.getElementById('filterClassTeacher');
    if (teacherFilter) {
        teacherFilter.innerHTML = '<option value="">üë®‚Äçüè´ T·∫•t c·∫£ gi√°o vi√™n</option>' +
            teachers.filter(t => t.status === 'active').map(t => `<option value="${t.id}">${t.fullName}</option>`).join('');
    }
}

// ===== 24.3 Modal L·ªõp h·ªçc =====
function openClassModal() {
    document.getElementById('editClassId').value = '';
    document.getElementById('classForm').reset();
    document.getElementById('classModalTitle').textContent = 'üìö Th√™m L·ªõp H·ªçc';
    document.getElementById('classType').value = 'group';
    document.getElementById('classMaxStudents').value = 10;
    document.getElementById('classStatus').value = 'new';
    toggleMaxStudents();
    populateClassSubjectDropdown();
    populateClassTeacherDropdown();
    openModal('classModal');
}

function populateClassSubjectDropdown() {
    document.getElementById('classSubject').innerHTML = '<option value="">-- Ch·ªçn m√¥n h·ªçc --</option>' +
        subjects.map(s => `<option value="${s.id}">${s.icon} ${s.name}</option>`).join('');
}

function populateClassTeacherDropdown(subjectId = null) {
    let filtered = teachers.filter(t => t.status === 'active');
    if (subjectId) {
        const subject = subjects.find(s => s.id === subjectId);
        if (subject) {
            filtered = filtered.filter(t => t.subjects.includes(subject.name));
        }
    }
    
    document.getElementById('classTeacher').innerHTML = '<option value="">-- Ch·ªçn gi√°o vi√™n --</option>' +
        filtered.map(t => `<option value="${t.id}">${t.fullName}</option>`).join('');
}

function filterTeachersBySubject() {
    const subjectId = document.getElementById('classSubject').value;
    populateClassTeacherDropdown(subjectId);
}

function toggleMaxStudents() {
    const classType = document.getElementById('classType').value;
    const maxStudentsInput = document.getElementById('classMaxStudents');
    const maxStudentsGroup = document.getElementById('maxStudentsGroup');
    
    if (classType === '1on1') {
        maxStudentsInput.value = 1;
        maxStudentsInput.disabled = true;
        maxStudentsGroup.style.opacity = '0.5';
    } else {
        maxStudentsInput.value = 10;
        maxStudentsInput.disabled = false;
        maxStudentsGroup.style.opacity = '1';
    }
}

function editClass(id) {
    const cls = classes.find(c => c.id === id);
    if (!cls) return;
    
    document.getElementById('editClassId').value = cls.id;
    document.getElementById('className').value = cls.className;
    populateClassSubjectDropdown();
    document.getElementById('classSubject').value = cls.subjectId;
    populateClassTeacherDropdown(cls.subjectId);
    document.getElementById('classTeacher').value = cls.teacherId || '';
    document.getElementById('classType').value = cls.classType;
    document.getElementById('classMaxStudents').value = cls.maxStudents;
    document.getElementById('classStatus').value = cls.status;
    document.getElementById('classNotes').value = cls.notes || '';
    
    toggleMaxStudents();
    document.getElementById('classModalTitle').textContent = '‚úèÔ∏è S·ª≠a L·ªõp H·ªçc';
    openModal('classModal');
}

function saveClass(event) {
    event.preventDefault();
    
    const editId = document.getElementById('editClassId').value;
    const data = {
        className: document.getElementById('className').value.trim(),
        subjectId: document.getElementById('classSubject').value,
        teacherId: document.getElementById('classTeacher').value || null,
        classType: document.getElementById('classType').value,
        maxStudents: parseInt(document.getElementById('classMaxStudents').value),
        status: document.getElementById('classStatus').value,
        notes: document.getElementById('classNotes').value.trim()
    };
    
    if (editId) {
        const index = classes.findIndex(c => c.id === editId);
        if (index !== -1) {
            classes[index] = { ...classes[index], ...data, updatedAt: new Date().toISOString() };
            showNotification('C·∫≠p nh·∫≠t l·ªõp h·ªçc th√†nh c√¥ng!', 'success');
        }
    } else {
        classes.push({ id: generateId(), ...data, createdAt: new Date().toISOString() });
        showNotification('Th√™m l·ªõp h·ªçc th√†nh c√¥ng!', 'success');
    }
    
    saveData('classes', classes);
    closeModal('classModal');
    renderClassesTable();
    populateClassFilters();
}

function deleteClass(id) {
    const cls = classes.find(c => c.id === id);
    if (!cls) return;
    
    const studentCount = classStudents.filter(cs => cs.classId === id && cs.status === 'active').length;
    if (studentCount > 0) {
        showNotification(`Kh√¥ng th·ªÉ x√≥a! L·ªõp c√≤n ${studentCount} h·ªçc vi√™n.`, 'error');
        return;
    }
    
    if (!confirm(`X√≥a l·ªõp "${cls.className}"?`)) return;
    
    classes = classes.filter(c => c.id !== id);
    classSchedules = classSchedules.filter(s => s.classId !== id);
    
    saveData('classes', classes);
    saveData('classSchedules', classSchedules);
    showNotification('ƒê√£ x√≥a l·ªõp h·ªçc!', 'success');
    renderClassesTable();
}

// ===== 24.4 Xem chi ti·∫øt l·ªõp =====
let currentViewingClassId = null;

function viewClass(id) {
    const cls = classes.find(c => c.id === id);
    if (!cls) return;
    
    currentViewingClassId = id;
    
    const subject = subjects.find(s => s.id === cls.subjectId);
    const teacher = teachers.find(t => t.id === cls.teacherId);
    const clsSchedules = classSchedules.filter(s => s.classId === id && s.isActive);
    const clsStudents = classStudents.filter(cs => cs.classId === id && cs.status === 'active');
    
    document.getElementById('viewClassContent').innerHTML = `
        <div class="d-flex gap-20 flex-wrap">
            <div class="flex-1" style="min-width: 300px;">
                <div class="quick-view-section">
                    <h4>üìã Th√¥ng tin l·ªõp</h4>
                    <div class="quick-view-row"><span class="quick-view-label">T√™n l·ªõp:</span><span class="quick-view-value"><strong>${cls.className}</strong></span></div>
                    <div class="quick-view-row"><span class="quick-view-label">M√¥n h·ªçc:</span><span class="quick-view-value">${subject ? `${subject.icon} ${subject.name}` : '-'}</span></div>
                    <div class="quick-view-row"><span class="quick-view-label">Gi√°o vi√™n:</span><span class="quick-view-value">${teacher ? teacher.fullName : '<span class="text-muted">Ch∆∞a c√≥</span>'}</span></div>
                    <div class="quick-view-row"><span class="quick-view-label">Lo·∫°i l·ªõp:</span><span class="quick-view-value">${cls.classType === 'group' ? 'üë• L·ªõp nh√≥m' : 'üë§ 1 k√®m 1'}</span></div>
                    <div class="quick-view-row"><span class="quick-view-label">Sƒ© s·ªë:</span><span class="quick-view-value"><strong>${clsStudents.length}</strong> / ${cls.maxStudents}</span></div>
                    <div class="quick-view-row"><span class="quick-view-label">Tr·∫°ng th√°i:</span><span class="quick-view-value">${getClassStatusBadge(cls.status)}</span></div>
                </div>
                
                <div class="quick-view-section">
                    <h4>üìÖ L·ªãch h·ªçc</h4>
                    ${clsSchedules.length === 0 ? '<p class="text-muted">Ch∆∞a c√≥ ca h·ªçc. Nh·∫•n "Th√™m ca h·ªçc" ƒë·ªÉ th√™m.</p>' : `
                        <table style="width: 100%; font-size: 13px;">
                            <thead><tr><th>Th·ª©</th><th>Gi·ªù h·ªçc</th><th>Ph√≤ng</th><th></th></tr></thead>
                            <tbody>
                                ${clsSchedules.map(s => `
                                    <tr>
                                        <td>${getDayName(s.dayOfWeek)}</td>
                                        <td>${s.startTime} - ${s.endTime}</td>
                                        <td>${s.room || '-'}</td>
                                        <td>
                                            <button class="action-btn edit" onclick="editSchedule('${s.id}')" title="S·ª≠a">‚úèÔ∏è</button>
                                            <button class="action-btn delete" onclick="deleteSchedule('${s.id}')" title="X√≥a">üóëÔ∏è</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `}
                </div>
            </div>
            
            <div class="flex-1" style="min-width: 350px;">
                <div class="quick-view-section">
                    <h4>üë©‚Äçüéì Danh s√°ch h·ªçc vi√™n (${clsStudents.length})</h4>
                    ${clsStudents.length === 0 ? '<p class="text-muted">Ch∆∞a c√≥ h·ªçc vi√™n. Nh·∫•n "Th√™m h·ªçc vi√™n" ƒë·ªÉ th√™m.</p>' : `
                        <table style="width: 100%; font-size: 13px;">
                            <thead><tr><th>H·ªçc vi√™n</th><th>T·ªïng</th><th>ƒê√£ h·ªçc</th><th>C√≤n l·∫°i</th><th></th></tr></thead>
                            <tbody>
                                ${clsStudents.map(cs => {
                                    const student = students.find(s => s.id === cs.studentId);
                                    const remainingClass = getSessionWarningClass(cs.remainingSessions);
                                    return `
                                        <tr>
                                            <td><strong>${student ? student.name : 'N/A'}</strong></td>
                                            <td>${cs.totalSessions}</td>
                                            <td>${cs.completedSessions}</td>
                                            <td><span class="${remainingClass}">${cs.remainingSessions}</span></td>
                                            <td>
                                                <button class="action-btn delete" onclick="removeStudentFromClass('${cs.id}')" title="X√≥a kh·ªèi l·ªõp">üóëÔ∏è</button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    `}
                </div>
            </div>
        </div>
    `;
    
    openModal('viewClassModal');
}

function getSessionWarningClass(remaining) {
    if (remaining <= 1) return 'text-danger fw-700';
    if (remaining <= 3) return 'text-warning fw-600';
    if (remaining <= 5) return 'text-primary';
    return 'text-success';
}

/* ============================================================
   üìÖ PH·∫¶N 25: QU·∫¢N L√ù CA H·ªåC (SCHEDULE)
   ============================================================ */

function openScheduleModal() {
    if (!currentViewingClassId) {
        showNotification('Vui l√≤ng ch·ªçn l·ªõp tr∆∞·ªõc!', 'error');
        return;
    }
    
    document.getElementById('scheduleClassId').value = currentViewingClassId;
    document.getElementById('editScheduleId').value = '';
    document.getElementById('scheduleForm').reset();
    document.getElementById('scheduleStartTime').value = '08:30';
    document.getElementById('scheduleEndTime').value = '10:00';
    openModal('scheduleModal');
}

function editSchedule(id) {
    const schedule = classSchedules.find(s => s.id === id);
    if (!schedule) return;
    
    document.getElementById('scheduleClassId').value = schedule.classId;
    document.getElementById('editScheduleId').value = schedule.id;
    document.getElementById('scheduleDayOfWeek').value = schedule.dayOfWeek;
    document.getElementById('scheduleStartTime').value = schedule.startTime;
    document.getElementById('scheduleEndTime').value = schedule.endTime;
    document.getElementById('scheduleRoom').value = schedule.room || '';
    
    openModal('scheduleModal');
}

function saveSchedule(event) {
    event.preventDefault();
    
    const classId = document.getElementById('scheduleClassId').value;
    const editId = document.getElementById('editScheduleId').value;
    
    const data = {
        classId: classId,
        dayOfWeek: parseInt(document.getElementById('scheduleDayOfWeek').value),
        startTime: document.getElementById('scheduleStartTime').value,
        endTime: document.getElementById('scheduleEndTime').value,
        room: document.getElementById('scheduleRoom').value.trim(),
        isActive: true
    };
    
    if (editId) {
        const index = classSchedules.findIndex(s => s.id === editId);
        if (index !== -1) {
            classSchedules[index] = { ...classSchedules[index], ...data };
            showNotification('C·∫≠p nh·∫≠t ca h·ªçc th√†nh c√¥ng!', 'success');
        }
    } else {
        classSchedules.push({ id: generateId(), ...data, createdAt: new Date().toISOString() });
        showNotification('Th√™m ca h·ªçc th√†nh c√¥ng!', 'success');
    }
    
    saveData('classSchedules', classSchedules);
    closeModal('scheduleModal');
    viewClass(classId); // Refresh chi ti·∫øt l·ªõp
    renderClassesTable();
}

function deleteSchedule(id) {
    if (!confirm('X√≥a ca h·ªçc n√†y?')) return;
    
    const schedule = classSchedules.find(s => s.id === id);
    classSchedules = classSchedules.filter(s => s.id !== id);
    saveData('classSchedules', classSchedules);
    showNotification('ƒê√£ x√≥a ca h·ªçc!', 'success');
    
    if (schedule) {
        viewClass(schedule.classId);
    }
    renderClassesTable();
}

/* ============================================================
   üë§ PH·∫¶N 26: G√ÅN H·ªåC VI√äN V√ÄO L·ªöP
   ============================================================ */

function openAssignStudentModal() {
    if (!currentViewingClassId) {
        showNotification('Vui l√≤ng ch·ªçn l·ªõp tr∆∞·ªõc!', 'error');
        return;
    }
    
    const cls = classes.find(c => c.id === currentViewingClassId);
    if (!cls) return;
    
    // Ki·ªÉm tra c√≤n ch·ªó kh√¥ng
    const currentCount = classStudents.filter(cs => cs.classId === currentViewingClassId && cs.status === 'active').length;
    if (currentCount >= cls.maxStudents) {
        showNotification('L·ªõp ƒë√£ ƒë·∫ßy!', 'error');
        return;
    }
    
    document.getElementById('assignClassId').value = currentViewingClassId;
    document.getElementById('assignStudentForm').reset();
    document.getElementById('assignRegistrationInfo').style.display = 'none';
    
    // L·∫•y c√°c phi·∫øu ƒêK ch∆∞a g√°n l·ªõp, c√πng m√¥n h·ªçc
    const subject = subjects.find(s => s.id === cls.subjectId);
    const unassignedRegs = registrations.filter(r => {
        // Ki·ªÉm tra ch∆∞a g√°n l·ªõp
        const isAssigned = classStudents.some(cs => cs.registrationId === r.id && cs.status === 'active');
        if (isAssigned) return false;
        
        // Ki·ªÉm tra c√πng m√¥n h·ªçc
        if (subject && r.subject !== subject.name) return false;
        
        return true;
    });
    
    document.getElementById('assignRegistrationId').innerHTML = '<option value="">-- Ch·ªçn phi·∫øu ƒêK ch∆∞a g√°n l·ªõp --</option>' +
        unassignedRegs.map(r => {
            const student = students.find(s => s.id === r.studentId);
            return `<option value="${r.id}">${r.regCode} - ${student ? student.name : 'N/A'} - ${r.subject}</option>`;
        }).join('');
    
    if (unassignedRegs.length === 0) {
        showNotification('Kh√¥ng c√≥ phi·∫øu ƒêK n√†o ch∆∞a g√°n l·ªõp cho m√¥n n√†y!', 'warning');
    }
    
    openModal('assignStudentModal');
}

function showRegistrationInfo() {
    const regId = document.getElementById('assignRegistrationId').value;
    const infoDiv = document.getElementById('assignRegistrationInfo');
    
    if (!regId) {
        infoDiv.style.display = 'none';
        return;
    }
    
    const reg = registrations.find(r => r.id === regId);
    if (!reg) return;
    
    const student = students.find(s => s.id === reg.studentId);
    
    document.getElementById('assignStudentName').textContent = student ? student.name : 'N/A';
    document.getElementById('assignSubject').textContent = reg.subject;
    
    // T√≠nh s·ªë bu·ªïi t·ª´ g√≥i ho·∫∑c m·∫∑c ƒë·ªãnh
    let totalSessions = 8; // M·∫∑c ƒë·ªãnh
    if (reg.packageId) {
        const pkg = packages.find(p => p.id === reg.packageId);
        if (pkg) totalSessions = pkg.sessions;
    }
    document.getElementById('assignTotalSessions').textContent = totalSessions + ' bu·ªïi';
    
    infoDiv.style.display = 'block';
}

function assignStudentToClass(event) {
    event.preventDefault();
    
    const classId = document.getElementById('assignClassId').value;
    const regId = document.getElementById('assignRegistrationId').value;
    
    if (!regId) {
        showNotification('Vui l√≤ng ch·ªçn phi·∫øu ƒëƒÉng k√Ω!', 'error');
        return;
    }
    
    const reg = registrations.find(r => r.id === regId);
    if (!reg) return;
    
    // T√≠nh s·ªë bu·ªïi
    let totalSessions = 8;
    if (reg.packageId) {
        const pkg = packages.find(p => p.id === reg.packageId);
        if (pkg) totalSessions = pkg.sessions;
    }
    
    // T·∫°o b·∫£n ghi classStudent
    classStudents.push({
        id: generateId(),
        classId: classId,
        studentId: reg.studentId,
        registrationId: regId,
        totalSessions: totalSessions,
        completedSessions: 0,
        remainingSessions: totalSessions,
        status: 'active',
        enrolledAt: new Date().toISOString()
    });
    
    saveData('classStudents', classStudents);
    closeModal('assignStudentModal');
    viewClass(classId);
    renderClassesTable();
    showNotification('ƒê√£ th√™m h·ªçc vi√™n v√†o l·ªõp!', 'success');
}

function removeStudentFromClass(classStudentId) {
    if (!confirm('X√≥a h·ªçc vi√™n kh·ªèi l·ªõp n√†y?')) return;
    
    const cs = classStudents.find(c => c.id === classStudentId);
    classStudents = classStudents.filter(c => c.id !== classStudentId);
    saveData('classStudents', classStudents);
    showNotification('ƒê√£ x√≥a h·ªçc vi√™n kh·ªèi l·ªõp!', 'success');
    
    if (cs) {
        viewClass(cs.classId);
    }
    renderClassesTable();
}

/* ============================================================
   ‚úÖ PH·∫¶N 27: ƒêI·ªÇM DANH
   ============================================================ */

// ===== 27.1 Kh·ªüi t·∫°o tab ƒëi·ªÉm danh =====
function initAttendanceTab() {
    // Set ng√†y m·∫∑c ƒë·ªãnh l√† h√¥m nay
    document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];
    
    // Populate dropdown l·ªõp h·ªçc
    populateAttendanceClassDropdown();
    
    // Load l·ªãch h·ªçc h√¥m nay
    loadTodaySchedules();
    
    // Load l·ªãch s·ª≠ ƒëi·ªÉm danh
    loadAttendanceHistory();
}

function populateAttendanceClassDropdown() {
    const activeClasses = classes.filter(c => c.status === 'active' || c.status === 'new');
    document.getElementById('attendanceClassSelect').innerHTML = '<option value="">-- Ch·ªçn l·ªõp h·ªçc --</option>' +
        activeClasses.map(c => {
            const subject = subjects.find(s => s.id === c.subjectId);
            return `<option value="${c.id}">${c.className} - ${subject ? subject.icon + ' ' + subject.name : ''}</option>`;
        }).join('');
}

// ===== 27.2 L·ªãch h·ªçc h√¥m nay =====
function loadTodaySchedules() {
    const today = new Date();
    const dayOfWeek = today.getDay() === 0 ? 7 : today.getDay(); // CN = 7
    const todayStr = today.toISOString().split('T')[0];
    
    // T√¨m c√°c ca h·ªçc h√¥m nay
    const todaySchedules = classSchedules.filter(s => s.dayOfWeek === dayOfWeek && s.isActive);
    
    const container = document.getElementById('todaySchedulesList');
    
    if (todaySchedules.length === 0) {
        container.innerHTML = '<p class="text-muted">Kh√¥ng c√≥ l·ªãch h·ªçc h√¥m nay</p>';
        return;
    }
    
    // S·∫Øp x·∫øp theo gi·ªù
    todaySchedules.sort((a, b) => a.startTime.localeCompare(b.startTime));
    
    container.innerHTML = `
        <div class="table-container" style="box-shadow: none; border: none;">
            <table>
                <thead>
                    <tr>
                        <th>Gi·ªù h·ªçc</th>
                        <th>L·ªõp</th>
                        <th>Gi√°o vi√™n</th>
                        <th>Sƒ© s·ªë</th>
                        <th>ƒê√£ ƒëi·ªÉm danh</th>
                        <th>Thao t√°c</th>
                    </tr>
                </thead>
                <tbody>
                    ${todaySchedules.map(s => {
                        const cls = classes.find(c => c.id === s.classId);
                        if (!cls) return '';
                        
                        const teacher = teachers.find(t => t.id === cls.teacherId);
                        const studentCount = classStudents.filter(cs => cs.classId === s.classId && cs.status === 'active').length;
                        
                        // Ki·ªÉm tra ƒë√£ ƒëi·ªÉm danh ch∆∞a
                        const attendedCount = attendances.filter(a => 
                            a.scheduleId === s.id && 
                            a.attendanceDate === todayStr
                        ).length;
                        
                        const isCompleted = attendedCount >= studentCount && studentCount > 0;
                        
                        return `
                            <tr>
                                <td><strong>${s.startTime} - ${s.endTime}</strong></td>
                                <td>${cls.className}</td>
                                <td>${teacher ? teacher.fullName : '-'}</td>
                                <td>${studentCount}</td>
                                <td>${isCompleted ? '<span class="text-success">‚úÖ ƒê√£ xong</span>' : `<span class="text-warning">${attendedCount}/${studentCount}</span>`}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="quickAttendance('${s.classId}', '${s.id}', '${todayStr}')">
                                        ‚úÖ ƒêi·ªÉm danh
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;
}

function refreshTodaySchedules() {
    loadTodaySchedules();
    showNotification('ƒê√£ l√†m m·ªõi!', 'success');
}

function quickAttendance(classId, scheduleId, date) {
    document.getElementById('attendanceClassSelect').value = classId;
    document.getElementById('attendanceDate').value = date;
    onAttendanceClassChange();
    
    setTimeout(() => {
        document.getElementById('attendanceScheduleSelect').value = scheduleId;
        loadAttendanceList();
    }, 100);
}

// ===== 27.3 X·ª≠ l√Ω ch·ªçn l·ªõp/ng√†y =====
function onAttendanceClassChange() {
    const classId = document.getElementById('attendanceClassSelect').value;
    const dateStr = document.getElementById('attendanceDate').value;
    
    if (!classId) {
        document.getElementById('attendanceScheduleSelect').innerHTML = '<option value="">-- Ch·ªçn ca h·ªçc --</option>';
        return;
    }
    
    // L·∫•y ng√†y trong tu·∫ßn
    const date = new Date(dateStr);
    const dayOfWeek = date.getDay() === 0 ? 7 : date.getDay();
    
    // L·ªçc ca h·ªçc c·ªßa l·ªõp n√†y v√†o ng√†y ƒë√≥
    const schedules = classSchedules.filter(s => s.classId === classId && s.dayOfWeek === dayOfWeek && s.isActive);
    
    document.getElementById('attendanceScheduleSelect').innerHTML = '<option value="">-- Ch·ªçn ca h·ªçc --</option>' +
        schedules.map(s => `<option value="${s.id}">${s.startTime} - ${s.endTime}${s.room ? ' (' + s.room + ')' : ''}</option>`).join('');
    
    if (schedules.length === 0) {
        showNotification('L·ªõp n√†y kh√¥ng c√≥ l·ªãch h·ªçc v√†o ng√†y ƒë√£ ch·ªçn!', 'warning');
    }
}

function onAttendanceDateChange() {
    onAttendanceClassChange();
}

// ===== 27.4 Load danh s√°ch ƒëi·ªÉm danh =====
function loadAttendanceList() {
    const classId = document.getElementById('attendanceClassSelect').value;
    const scheduleId = document.getElementById('attendanceScheduleSelect').value;
    const dateStr = document.getElementById('attendanceDate').value;
    
    if (!classId || !scheduleId || !dateStr) {
        document.getElementById('attendanceTableCard').style.display = 'none';
        return;
    }
    
    const cls = classes.find(c => c.id === classId);
    const schedule = classSchedules.find(s => s.id === scheduleId);
    
    // L·∫•y h·ªçc vi√™n trong l·ªõp
    const clsStudents = classStudents.filter(cs => cs.classId === classId && cs.status === 'active');
    
    if (clsStudents.length === 0) {
        showNotification('L·ªõp n√†y ch∆∞a c√≥ h·ªçc vi√™n!', 'warning');
        document.getElementById('attendanceTableCard').style.display = 'none';
        return;
    }
    
    // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ
    document.getElementById('attendanceTableTitle').textContent = 
        `üìã ƒêi·ªÉm danh: ${cls.className} - ${schedule.startTime}-${schedule.endTime} - ${formatDate(dateStr)}`;
    
    // L·∫•y ƒëi·ªÉm danh ƒë√£ c√≥ (n·∫øu c√≥)
    const existingAttendances = attendances.filter(a => 
        a.scheduleId === scheduleId && 
        a.attendanceDate === dateStr
    );
    
    const tbody = document.getElementById('attendanceTableBody');
    tbody.innerHTML = clsStudents.map(cs => {
        const student = students.find(s => s.id === cs.studentId);
        const existing = existingAttendances.find(a => a.classStudentId === cs.id);
        const remainingClass = getSessionWarningClass(cs.remainingSessions);
        
        return `
            <tr data-class-student-id="${cs.id}" data-student-id="${cs.studentId}">
                <td><strong>${student ? student.name : 'N/A'}</strong></td>
                <td>${cs.totalSessions}</td>
                <td>${cs.completedSessions}</td>
                <td><span class="${remainingClass}">${cs.remainingSessions}</span></td>
                <td>
                    <div class="attendance-status-buttons" style="display: flex; gap: 5px;">
                        <button type="button" class="btn btn-sm ${existing?.status === 'present' ? 'btn-success' : 'btn-outline'}" 
                                onclick="setAttendanceStatus(this, 'present')" title="C√≥ m·∫∑t">‚úÖ</button>
                        <button type="button" class="btn btn-sm ${existing?.status === 'late' ? 'btn-warning' : 'btn-outline'}" 
                                onclick="setAttendanceStatus(this, 'late')" title="Mu·ªôn">üü°</button>
                        <button type="button" class="btn btn-sm ${existing?.status === 'absent' ? 'btn-danger' : 'btn-outline'}" 
                                onclick="setAttendanceStatus(this, 'absent')" title="V·∫Øng kh√¥ng ph√©p">‚ùå</button>
                        <button type="button" class="btn btn-sm ${existing?.status === 'excused' ? 'btn-info' : 'btn-outline'}" 
                                onclick="setAttendanceStatus(this, 'excused')" title="C√≥ ph√©p (t·∫°o h·ªçc b√π)">üìù</button>
                    </div>
                    <input type="hidden" class="attendance-status-input" value="${existing?.status || ''}">
                </td>
                <td>
                    <input type="text" class="attendance-note-input" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;" 
                           placeholder="Ghi ch√∫..." value="${existing?.notes || ''}">
                </td>
            </tr>
        `;
    }).join('');
    
    document.getElementById('attendanceTableCard').style.display = 'block';
}

function setAttendanceStatus(btn, status) {
    const row = btn.closest('tr');
    const buttons = row.querySelectorAll('.attendance-status-buttons button');
    const input = row.querySelector('.attendance-status-input');
    
    // Remove all active states
    buttons.forEach(b => {
        b.classList.remove('btn-success', 'btn-warning', 'btn-danger', 'btn-info');
        b.classList.add('btn-outline');
    });
    
    // Set active state
    const btnClasses = {
        'present': 'btn-success',
        'late': 'btn-warning',
        'absent': 'btn-danger',
        'excused': 'btn-info'
    };
    
    btn.classList.remove('btn-outline');
    btn.classList.add(btnClasses[status]);
    input.value = status;
}

function markAllPresent() {
    const rows = document.querySelectorAll('#attendanceTableBody tr');
    rows.forEach(row => {
        const presentBtn = row.querySelector('.attendance-status-buttons button:first-child');
        if (presentBtn) {
            setAttendanceStatus(presentBtn, 'present');
        }
    });
    showNotification('ƒê√£ ƒë√°nh d·∫•u t·∫•t c·∫£ C√≥ m·∫∑t!', 'success');
}

// ===== 27.5 L∆∞u ƒëi·ªÉm danh =====
function saveAttendance() {
    const classId = document.getElementById('attendanceClassSelect').value;
    const scheduleId = document.getElementById('attendanceScheduleSelect').value;
    const dateStr = document.getElementById('attendanceDate').value;
    
    if (!classId || !scheduleId || !dateStr) {
        showNotification('Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß th√¥ng tin!', 'error');
        return;
    }
    
    const rows = document.querySelectorAll('#attendanceTableBody tr');
    let savedCount = 0;
    let makeupCount = 0;
    
    rows.forEach(row => {
        const classStudentId = row.dataset.classStudentId;
        const studentId = row.dataset.studentId;
        const status = row.querySelector('.attendance-status-input').value;
        const notes = row.querySelector('.attendance-note-input').value.trim();
        
        if (!status) return; // B·ªè qua n·∫øu ch∆∞a ch·ªçn tr·∫°ng th√°i
        
        // Ki·ªÉm tra ƒë√£ ƒëi·ªÉm danh ch∆∞a
        const existingIndex = attendances.findIndex(a => 
            a.classStudentId === classStudentId && 
            a.scheduleId === scheduleId && 
            a.attendanceDate === dateStr
        );
        
        const attendanceData = {
            classId,
            scheduleId,
            studentId,
            classStudentId,
            attendanceDate: dateStr,
            status,
            notes,
            isMakeupSession: false,
            makeupRequestId: null,
            createdBy: currentUser.id,
            updatedAt: new Date().toISOString()
        };
        
        if (existingIndex !== -1) {
            // C·∫≠p nh·∫≠t
            const oldStatus = attendances[existingIndex].status;
            attendances[existingIndex] = { ...attendances[existingIndex], ...attendanceData };
            
            // X·ª≠ l√Ω thay ƒë·ªïi tr·∫°ng th√°i
            handleAttendanceStatusChange(classStudentId, oldStatus, status, attendances[existingIndex].id);
        } else {
            // Th√™m m·ªõi
            const newAttendance = {
                id: generateId(),
                ...attendanceData,
                createdAt: new Date().toISOString()
            };
            attendances.push(newAttendance);
            
            // X·ª≠ l√Ω tr·∫°ng th√°i m·ªõi
            handleNewAttendance(classStudentId, status, newAttendance.id);
        }
        
        if (status === 'excused') makeupCount++;
        savedCount++;
    });
    
    if (savedCount === 0) {
        showNotification('Vui l√≤ng ch·ªçn tr·∫°ng th√°i ƒëi·ªÉm danh!', 'warning');
        return;
    }
    
    saveData('attendances', attendances);
    saveData('classStudents', classStudents);
    saveData('makeupRequests', makeupRequests);
    
    loadAttendanceList();
    loadTodaySchedules();
    loadAttendanceHistory();
    
    let msg = `ƒê√£ l∆∞u ƒëi·ªÉm danh cho ${savedCount} h·ªçc vi√™n!`;
    if (makeupCount > 0) {
        msg += ` ƒê√£ t·∫°o ${makeupCount} y√™u c·∫ßu h·ªçc b√π.`;
    }
    showNotification(msg, 'success');
}

function handleNewAttendance(classStudentId, status, attendanceId) {
    const cs = classStudents.find(c => c.id === classStudentId);
    if (!cs) return;
    
    if (status === 'present' || status === 'late' || status === 'absent') {
        // C√≥ m·∫∑t / Mu·ªôn / V·∫Øng kh√¥ng ph√©p ‚Üí Tr·ª´ 1 bu·ªïi
        cs.completedSessions++;
        cs.remainingSessions = Math.max(0, cs.remainingSessions - 1);
        
        // Ki·ªÉm tra ho√†n th√†nh
        if (cs.remainingSessions === 0) {
            cs.status = 'completed';
        }
    } else if (status === 'excused') {
        // C√≥ ph√©p ‚Üí KH√îNG tr·ª´ bu·ªïi, ch·ªâ t·∫°o y√™u c·∫ßu h·ªçc b√π
        createMakeupRequest(classStudentId, attendanceId);
    }
}


function handleAttendanceStatusChange(classStudentId, oldStatus, newStatus, attendanceId) {
    if (oldStatus === newStatus) return;
    
    const cs = classStudents.find(c => c.id === classStudentId);
    if (!cs) return;
    
    // Ho√†n t√°c tr·∫°ng th√°i c≈©
    if (oldStatus === 'present' || oldStatus === 'late' || oldStatus === 'absent') {
        // Tr·∫°ng th√°i c≈© ƒë√£ tr·ª´ bu·ªïi ‚Üí C·ªông l·∫°i
        cs.completedSessions = Math.max(0, cs.completedSessions - 1);
        cs.remainingSessions++;
        if (cs.status === 'completed') cs.status = 'active';
    } else if (oldStatus === 'excused') {
        // Tr·∫°ng th√°i c≈© l√† C√≥ ph√©p ‚Üí X√≥a y√™u c·∫ßu h·ªçc b√π
        makeupRequests = makeupRequests.filter(m => m.originalAttendanceId !== attendanceId);
    }
    
    // √Åp d·ª•ng tr·∫°ng th√°i m·ªõi
    handleNewAttendance(classStudentId, newStatus, attendanceId);
}


// ===== 27.6 L·ªãch s·ª≠ ƒëi·ªÉm danh =====
function loadAttendanceHistory() {
    // Nh√≥m theo ng√†y + l·ªõp + ca
    const grouped = {};
    
    attendances.forEach(a => {
        const key = `${a.attendanceDate}_${a.classId}_${a.scheduleId}`;
        if (!grouped[key]) {
            grouped[key] = {
                date: a.attendanceDate,
                classId: a.classId,
                scheduleId: a.scheduleId,
                records: []
            };
        }
        grouped[key].records.push(a);
    });
    
    // S·∫Øp x·∫øp theo ng√†y m·ªõi nh·∫•t
    const sortedGroups = Object.values(grouped).sort((a, b) => 
        new Date(b.date) - new Date(a.date)
    ).slice(0, 20); // L·∫•y 20 bu·ªïi g·∫ßn nh·∫•t
    
    const tbody = document.getElementById('attendanceHistoryBody');
    
    if (sortedGroups.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu ƒëi·ªÉm danh</td></tr>';
        return;
    }
    
    tbody.innerHTML = sortedGroups.map(g => {
        const cls = classes.find(c => c.id === g.classId);
        const schedule = classSchedules.find(s => s.id === g.scheduleId);
        
        const totalStudents = g.records.length;
        const presentCount = g.records.filter(r => r.status === 'present' || r.status === 'late').length;
        const absentCount = g.records.filter(r => r.status === 'absent' || r.status === 'excused').length;
        
        return `
            <tr>
                <td><strong>${formatDate(g.date)}</strong></td>
                <td>${cls ? cls.className : 'N/A'}</td>
                <td>${schedule ? schedule.startTime + '-' + schedule.endTime : 'N/A'}</td>
                <td>${totalStudents}</td>
                <td><span class="text-success">${presentCount}</span></td>
                <td><span class="text-danger">${absentCount}</span></td>
                <td>
                    <button class="action-btn view" onclick="viewAttendanceDetail('${g.date}', '${g.classId}', '${g.scheduleId}')" title="Xem chi ti·∫øt">üëÅÔ∏è</button>
                </td>
            </tr>
        `;
    }).join('');
}

function viewAttendanceDetail(date, classId, scheduleId) {
    const cls = classes.find(c => c.id === classId);
    const schedule = classSchedules.find(s => s.id === scheduleId);
    const records = attendances.filter(a => 
        a.attendanceDate === date && 
        a.classId === classId && 
        a.scheduleId === scheduleId
    );
    
    const content = `
        <div class="quick-view-section">
            <h4>üìã Th√¥ng tin bu·ªïi h·ªçc</h4>
            <div class="quick-view-row"><span class="quick-view-label">L·ªõp:</span><span class="quick-view-value">${cls ? cls.className : 'N/A'}</span></div>
            <div class="quick-view-row"><span class="quick-view-label">Ng√†y:</span><span class="quick-view-value">${formatDate(date)}</span></div>
            <div class="quick-view-row"><span class="quick-view-label">Ca h·ªçc:</span><span class="quick-view-value">${schedule ? schedule.startTime + ' - ' + schedule.endTime : 'N/A'}</span></div>
        </div>
        <div class="quick-view-section">
            <h4>üìä Chi ti·∫øt ƒëi·ªÉm danh</h4>
            <table style="width: 100%; font-size: 13px;">
                <thead>
                    <tr><th>H·ªçc vi√™n</th><th>Tr·∫°ng th√°i</th><th>Ghi ch√∫</th></tr>
                </thead>
                <tbody>
                    ${records.map(r => {
                        const student = students.find(s => s.id === r.studentId);
                        return `
                            <tr>
                                <td>${student ? student.name : 'N/A'}</td>
                                <td>${getAttendanceStatusBadge(r.status)}</td>
                                <td>${r.notes || '-'}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;
    
    document.getElementById('viewAttendanceContent').innerHTML = content;
    openModal('viewAttendanceModal');
}

function getAttendanceStatusBadge(status) {
    const badges = {
        'present': '<span class="status-badge da-dk">‚úÖ C√≥ m·∫∑t</span>',
        'late': '<span class="status-badge cho-dk">üü° Mu·ªôn</span>',
        'absent': '<span class="status-badge cancel">‚ùå V·∫Øng</span>',
        'excused': '<span class="status-badge hoc-thu">üìù C√≥ ph√©p</span>'
    };
    return badges[status] || status;
}

function exportAttendanceToExcel() {
    if (attendances.length === 0) {
        showNotification('Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!', 'warning');
        return;
    }
    
    const data = attendances.map(a => {
        const student = students.find(s => s.id === a.studentId);
        const cls = classes.find(c => c.id === a.classId);
        const schedule = classSchedules.find(s => s.id === a.scheduleId);
        
        return {
            'Ng√†y': formatDate(a.attendanceDate),
            'L·ªõp': cls ? cls.className : '',
            'Ca h·ªçc': schedule ? schedule.startTime + '-' + schedule.endTime : '',
            'H·ªçc vi√™n': student ? student.name : '',
            'Tr·∫°ng th√°i': a.status === 'present' ? 'C√≥ m·∫∑t' : a.status === 'late' ? 'Mu·ªôn' : a.status === 'absent' ? 'V·∫Øng' : 'C√≥ ph√©p',
            'Ghi ch√∫': a.notes || ''
        };
    });
    
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), 'ƒêi·ªÉm danh');
    XLSX.writeFile(wb, `DiemDanh_${formatDateFile()}.xlsx`);
    showNotification('Xu·∫•t Excel th√†nh c√¥ng!', 'success');
}

/* ============================================================
   üìù PH·∫¶N 28: QU·∫¢N L√ù H·ªåC B√ô
   ============================================================ */

// ===== 28.1 T·∫°o y√™u c·∫ßu h·ªçc b√π =====
function createMakeupRequest(classStudentId, attendanceId) {
    const cs = classStudents.find(c => c.id === classStudentId);
    const attendance = attendances.find(a => a.id === attendanceId);
    
    if (!cs || !attendance) return;
    
    // Ki·ªÉm tra ƒë√£ c√≥ y√™u c·∫ßu ƒë∆∞·ª£c t·∫°o tr∆∞·ªõc ch∆∞a (pre-created)
    const preCreated = makeupRequests.find(m => 
        m.classStudentId === classStudentId && 
        m.originalDate === attendance.attendanceDate &&
        m.isPreCreated === true &&
        m.status === 'pending'
    );
    
    if (preCreated) {
        // C·∫≠p nh·∫≠t y√™u c·∫ßu ƒë√£ t·∫°o tr∆∞·ªõc v·ªõi attendanceId
        preCreated.originalAttendanceId = attendanceId;
        preCreated.originalScheduleId = attendance.scheduleId;
        preCreated.isPreCreated = false;
        return;
    }
    
    // Ki·ªÉm tra ƒë√£ c√≥ y√™u c·∫ßu ch∆∞a
    const existing = makeupRequests.find(m => m.originalAttendanceId === attendanceId);
    if (existing) return;
    
    // T√≠nh ng√†y h·∫øt h·∫°n (30 ng√†y)
    const expiryDate = new Date(attendance.attendanceDate);
    expiryDate.setDate(expiryDate.getDate() + 30);
    
    makeupRequests.push({
        id: generateId(),
        studentId: cs.studentId,
        classStudentId: classStudentId,
        originalAttendanceId: attendanceId,
        originalClassId: attendance.classId,
        originalScheduleId: attendance.scheduleId,
        originalDate: attendance.attendanceDate,
        requestDate: new Date().toISOString().split('T')[0],
        expiryDate: expiryDate.toISOString().split('T')[0],
        makeupClassId: null,
        makeupScheduleId: null,
        makeupDate: null,
        status: 'pending',
        approvedBy: null,
        approvedAt: null,
        completedAt: null,
        notes: null,
        isPreCreated: false,
        createdAt: new Date().toISOString()
    });
}

// ===== 28.2 Render danh s√°ch y√™u c·∫ßu h·ªçc b√π =====
let currentMakeupFilter = 'all';

function renderMakeupRequests() {
    updateMakeupStats();
    
    const tbody = document.getElementById('makeupRequestsBody');
    const today = new Date().toISOString().split('T')[0];
    
    let filtered = [...makeupRequests];
    
    // √Åp d·ª•ng filter
    if (currentMakeupFilter === 'pending') {
        filtered = filtered.filter(m => m.status === 'pending');
    } else if (currentMakeupFilter === 'approved') {
        filtered = filtered.filter(m => m.status === 'approved');
    } else if (currentMakeupFilter === 'expiring') {
        const in7Days = new Date();
        in7Days.setDate(in7Days.getDate() + 7);
        filtered = filtered.filter(m => 
            (m.status === 'pending' || m.status === 'approved') && 
            new Date(m.expiryDate) <= in7Days
        );
    } else if (currentMakeupFilter === 'completed') {
        filtered = filtered.filter(m => m.status === 'completed');
    } else if (currentMakeupFilter === 'expired') {
        filtered = filtered.filter(m => m.status === 'expired');
    }
    
    // S·∫Øp x·∫øp theo h·∫°n g·∫ßn nh·∫•t
    filtered.sort((a, b) => new Date(a.expiryDate) - new Date(b.expiryDate));
    
    if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Kh√¥ng c√≥ y√™u c·∫ßu h·ªçc b√π</td></tr>';
        return;
    }
    
    tbody.innerHTML = filtered.map(m => {
        const student = students.find(s => s.id === m.studentId);
        const originalClass = classes.find(c => c.id === m.originalClassId);
        const makeupClass = m.makeupClassId ? classes.find(c => c.id === m.makeupClassId) : null;
        
        // T√≠nh s·ªë ng√†y c√≤n l·∫°i
        const daysLeft = Math.ceil((new Date(m.expiryDate) - new Date(today)) / (1000 * 60 * 60 * 24));
        const expiryClass = daysLeft <= 3 ? 'text-danger fw-700' : daysLeft <= 7 ? 'text-warning fw-600' : '';
        
        return `
            <tr>
                <td><strong>${student ? student.name : 'N/A'}</strong></td>
                <td>${originalClass ? originalClass.className : 'N/A'}</td>
                <td>${formatDate(m.originalDate)}</td>
                <td><span class="${expiryClass}">${formatDate(m.expiryDate)} ${daysLeft > 0 ? `(${daysLeft} ng√†y)` : ''}</span></td>
                <td>${makeupClass ? makeupClass.className : '<span class="text-muted">Ch∆∞a x·∫øp</span>'}</td>
                <td>${m.makeupDate ? formatDate(m.makeupDate) : '-'}</td>
                <td>${getMakeupStatusBadge(m.status)}</td>
                <td>
                    <div class="action-buttons">
                        ${m.status === 'pending' ? `<button class="action-btn schedule" onclick="openScheduleMakeupModal('${m.id}')" title="X·∫øp l·ªãch">üìÖ</button>` : ''}
                        ${m.status === 'approved' ? `<button class="action-btn edit" onclick="openConfirmMakeupModal('${m.id}')" title="X√°c nh·∫≠n ho√†n th√†nh">‚úÖ</button>` : ''}
                        ${(m.status === 'pending' || m.status === 'approved') ? `<button class="action-btn delete" onclick="cancelMakeupRequest('${m.id}')" title="H·ªßy">üóëÔ∏è</button>` : ''}
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function getMakeupStatusBadge(status) {
    const badges = {
        'pending': '<span class="status-badge cho-dk">‚è≥ Ch·ªù x·∫øp l·ªãch</span>',
        'approved': '<span class="status-badge hoc-thu">üìÖ ƒê√£ x·∫øp l·ªãch</span>',
        'completed': '<span class="status-badge da-dk">‚úÖ Ho√†n th√†nh</span>',
        'expired': '<span class="status-badge cancel">‚ùå H·∫øt h·∫°n</span>'
    };
    return badges[status] || status;
}

function updateMakeupStats() {
    const today = new Date().toISOString().split('T')[0];
    const in7Days = new Date();
    in7Days.setDate(in7Days.getDate() + 7);
    
    document.getElementById('makeupPendingCount').textContent = makeupRequests.filter(m => m.status === 'pending').length;
    document.getElementById('makeupApprovedCount').textContent = makeupRequests.filter(m => m.status === 'approved').length;
    document.getElementById('makeupExpiringCount').textContent = makeupRequests.filter(m => 
        (m.status === 'pending' || m.status === 'approved') && 
        new Date(m.expiryDate) <= in7Days
    ).length;
    document.getElementById('makeupCompletedCount').textContent = makeupRequests.filter(m => m.status === 'completed').length;
}

function filterMakeupRequests(filter) {
    currentMakeupFilter = filter;
    document.querySelectorAll('#makeup .filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === filter);
    });
    renderMakeupRequests();
}

// ===== 28.3 X·∫øp l·ªãch h·ªçc b√π =====
function openScheduleMakeupModal(requestId) {
    const request = makeupRequests.find(m => m.id === requestId);
    if (!request) return;
    
    const student = students.find(s => s.id === request.studentId);
    const originalClass = classes.find(c => c.id === request.originalClassId);
    
    document.getElementById('makeupRequestId').value = requestId;
    document.getElementById('makeupStudentName').textContent = student ? student.name : 'N/A';
    document.getElementById('makeupOriginalClass').textContent = originalClass ? originalClass.className : 'N/A';
    document.getElementById('makeupOriginalDate').textContent = formatDate(request.originalDate);
    document.getElementById('makeupExpiryDate').textContent = formatDate(request.expiryDate);
    
    // Set min/max date
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('makeupDate').min = today;
    document.getElementById('makeupDate').max = request.expiryDate;
    document.getElementById('makeupDate').value = '';
    
    // Populate t·∫•t c·∫£ l·ªõp ƒëang ho·∫°t ƒë·ªông
    const activeClasses = classes.filter(c => c.status === 'active' || c.status === 'new');
    document.getElementById('makeupClassSelect').innerHTML = '<option value="">-- Ch·ªçn l·ªõp --</option>' +
        activeClasses.map(c => {
            const subject = subjects.find(s => s.id === c.subjectId);
            const isOriginal = c.id === request.originalClassId;
            return `<option value="${c.id}" ${isOriginal ? 'selected' : ''}>${c.className}${isOriginal ? ' (L·ªõp g·ªëc)' : ''} - ${subject ? subject.name : ''}</option>`;
        }).join('');
    
    document.getElementById('makeupScheduleSelect').innerHTML = '<option value="">-- Ch·ªçn ca h·ªçc --</option>';
    document.getElementById('makeupNotes').value = '';
    
    openModal('scheduleMakeupModal');
}

function loadMakeupSchedules() {
    const classId = document.getElementById('makeupClassSelect').value;
    const dateStr = document.getElementById('makeupDate').value;
    
    if (!classId || !dateStr) {
        document.getElementById('makeupScheduleSelect').innerHTML = '<option value="">-- Ch·ªçn ca h·ªçc --</option>';
        return;
    }
    
    const date = new Date(dateStr);
    const dayOfWeek = date.getDay() === 0 ? 7 : date.getDay();
    
    const schedules = classSchedules.filter(s => s.classId === classId && s.dayOfWeek === dayOfWeek && s.isActive);
    
    if (schedules.length === 0) {
        document.getElementById('makeupScheduleSelect').innerHTML = '<option value="">Kh√¥ng c√≥ ca h·ªçc v√†o ng√†y n√†y</option>';
        showNotification('L·ªõp n√†y kh√¥ng c√≥ l·ªãch h·ªçc v√†o ng√†y ƒë√£ ch·ªçn!', 'warning');
        return;
    }
    
    document.getElementById('makeupScheduleSelect').innerHTML = '<option value="">-- Ch·ªçn ca h·ªçc --</option>' +
        schedules.map(s => `<option value="${s.id}">${s.startTime} - ${s.endTime}${s.room ? ' (' + s.room + ')' : ''}</option>`).join('');
}

function saveMakeupSchedule(event) {
    event.preventDefault();
    
    const requestId = document.getElementById('makeupRequestId').value;
    const classId = document.getElementById('makeupClassSelect').value;
    const dateStr = document.getElementById('makeupDate').value;
    const scheduleId = document.getElementById('makeupScheduleSelect').value;
    const notes = document.getElementById('makeupNotes').value.trim();
    
    if (!classId || !dateStr || !scheduleId) {
        showNotification('Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß th√¥ng tin!', 'error');
        return;
    }
    
    const request = makeupRequests.find(m => m.id === requestId);
    if (!request) return;
    
    // Ki·ªÉm tra h·∫°n
    if (dateStr > request.expiryDate) {
        showNotification('Ng√†y h·ªçc b√π v∆∞·ª£t qu√° h·∫°n cho ph√©p!', 'error');
        return;
    }
    
    // C·∫≠p nh·∫≠t
    request.makeupClassId = classId;
    request.makeupScheduleId = scheduleId;
    request.makeupDate = dateStr;
    request.status = 'approved';
    request.approvedBy = currentUser.id;
    request.approvedAt = new Date().toISOString();
    request.notes = notes;
    
    saveData('makeupRequests', makeupRequests);
    closeModal('scheduleMakeupModal');
    renderMakeupRequests();
    showNotification('ƒê√£ x·∫øp l·ªãch h·ªçc b√π th√†nh c√¥ng!', 'success');
}

// ===== 28.4 X√°c nh·∫≠n ho√†n th√†nh h·ªçc b√π =====
function openConfirmMakeupModal(requestId) {
    const request = makeupRequests.find(m => m.id === requestId);
    if (!request) return;
    
    const student = students.find(s => s.id === request.studentId);
    const makeupClass = classes.find(c => c.id === request.makeupClassId);
    
    document.getElementById('confirmMakeupId').value = requestId;
    document.getElementById('confirmMakeupStudent').textContent = student ? student.name : 'N/A';
    document.getElementById('confirmMakeupClass').textContent = makeupClass ? makeupClass.className : 'N/A';
    document.getElementById('confirmMakeupDate').textContent = formatDate(request.makeupDate);
    
    openModal('confirmMakeupModal');
}

function completeMakeupRequest() {
    const requestId = document.getElementById('confirmMakeupId').value;
    const request = makeupRequests.find(m => m.id === requestId);
    if (!request) return;
    
    // T·∫°o b·∫£n ghi ƒëi·ªÉm danh cho bu·ªïi h·ªçc b√π
    attendances.push({
        id: generateId(),
        classId: request.makeupClassId,
        scheduleId: request.makeupScheduleId,
        studentId: request.studentId,
        classStudentId: request.classStudentId,
        attendanceDate: request.makeupDate,
        status: 'present',
        notes: 'Bu·ªïi h·ªçc b√π',
        isMakeupSession: true,
        makeupRequestId: requestId,
        createdBy: currentUser.id,
        createdAt: new Date().toISOString()
    });
    
    // C·∫≠p nh·∫≠t tr·∫°ng th√°i y√™u c·∫ßu
    request.status = 'completed';
    request.completedAt = new Date().toISOString();
    
    // TR·ª™ 1 BU·ªîI (ho√†n th√†nh bu·ªïi h·ªçc b√π)
    const cs = classStudents.find(c => c.id === request.classStudentId);
    if (cs) {
        cs.completedSessions++;
        cs.remainingSessions = Math.max(0, cs.remainingSessions - 1);
        
        // Ki·ªÉm tra ho√†n th√†nh kh√≥a h·ªçc
        if (cs.remainingSessions === 0) {
            cs.status = 'completed';
        }
        saveData('classStudents', classStudents);
    }
    
    saveData('attendances', attendances);
    saveData('makeupRequests', makeupRequests);
    
    closeModal('confirmMakeupModal');
    renderMakeupRequests();
    loadAttendanceHistory();
    showNotification('ƒê√£ x√°c nh·∫≠n ho√†n th√†nh h·ªçc b√π! ƒê√£ tr·ª´ 1 bu·ªïi.', 'success');
}


function cancelMakeupRequest(requestId) {
    if (!confirm('H·ªßy y√™u c·∫ßu h·ªçc b√π n√†y?\n\n‚ö†Ô∏è Bu·ªïi h·ªçc s·∫Ω b·ªã tr·ª´ ngay.')) return;
    
    const request = makeupRequests.find(m => m.id === requestId);
    if (!request) return;
    
    // TR·ª™ 1 BU·ªîI (h·ªßy y√™u c·∫ßu)
    const cs = classStudents.find(c => c.id === request.classStudentId);
    if (cs) {
        cs.completedSessions++;
        cs.remainingSessions = Math.max(0, cs.remainingSessions - 1);
        
        if (cs.remainingSessions === 0) {
            cs.status = 'completed';
        }
        saveData('classStudents', classStudents);
    }
    
    // ƒê·ªïi tr·∫°ng th√°i
    request.status = 'expired';
    request.notes = (request.notes || '') + ' | H·ªßy th·ªß c√¥ng';
    
    saveData('makeupRequests', makeupRequests);
    renderMakeupRequests();
    showNotification('ƒê√£ h·ªßy y√™u c·∫ßu h·ªçc b√π v√† tr·ª´ 1 bu·ªïi!', 'warning');
}


// ===== 28.5 Ki·ªÉm tra h·∫øt h·∫°n h·ªçc b√π (ch·∫°y khi load trang) =====
function checkExpiredMakeupRequests() {
    const today = new Date().toISOString().split('T')[0];
    let expiredCount = 0;
    
    makeupRequests.forEach(m => {
        if ((m.status === 'pending' || m.status === 'approved') && m.expiryDate < today) {
            m.status = 'expired';
            
            // TR·ª™ 1 BU·ªîI (h·∫øt h·∫°n kh√¥ng h·ªçc b√π)
            const cs = classStudents.find(c => c.id === m.classStudentId);
            if (cs) {
                cs.completedSessions++;
                cs.remainingSessions = Math.max(0, cs.remainingSessions - 1);
                
                if (cs.remainingSessions === 0) {
                    cs.status = 'completed';
                }
            }
            
            expiredCount++;
        }
    });
    
    if (expiredCount > 0) {
        saveData('makeupRequests', makeupRequests);
        saveData('classStudents', classStudents);
        showNotification(`‚ö†Ô∏è ${expiredCount} y√™u c·∫ßu h·ªçc b√π ƒë√£ h·∫øt h·∫°n v√† b·ªã tr·ª´ bu·ªïi!`, 'warning');
    }
}

// ===== 28.6 T·∫°o m·ªõi y√™u c·∫ßu h·ªçc b√π (linh ho·∫°t) =====
function openCreateMakeupModal() {
    document.getElementById('createMakeupForm').reset();
    
    // Set ng√†y m·∫∑c ƒë·ªãnh l√† ng√†y mai
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    document.getElementById('newMakeupAbsentDate').value = tomorrow.toISOString().split('T')[0];
    document.getElementById('newMakeupAbsentDate').min = new Date().toISOString().split('T')[0];
    
    // Populate l·ªõp h·ªçc
    const activeClasses = classes.filter(c => c.status === 'active' || c.status === 'new');
    document.getElementById('newMakeupClassSelect').innerHTML = '<option value="">-- Ch·ªçn l·ªõp h·ªçc --</option>' +
        activeClasses.map(c => {
            const subject = subjects.find(s => s.id === c.subjectId);
            return `<option value="${c.id}">${c.className} - ${subject ? subject.icon + ' ' + subject.name : ''}</option>`;
        }).join('');
    
    document.getElementById('newMakeupStudentSelect').innerHTML = '<option value="">-- Ch·ªçn h·ªçc vi√™n --</option>';
    
    openModal('createMakeupModal');
}

function loadStudentsForMakeup() {
    const classId = document.getElementById('newMakeupClassSelect').value;
    
    if (!classId) {
        document.getElementById('newMakeupStudentSelect').innerHTML = '<option value="">-- Ch·ªçn h·ªçc vi√™n --</option>';
        return;
    }
    
    // L·∫•y h·ªçc vi√™n trong l·ªõp c√≤n bu·ªïi h·ªçc
    const clsStudents = classStudents.filter(cs => cs.classId === classId && cs.status === 'active' && cs.remainingSessions > 0);
    
    document.getElementById('newMakeupStudentSelect').innerHTML = '<option value="">-- Ch·ªçn h·ªçc vi√™n --</option>' +
        clsStudents.map(cs => {
            const student = students.find(s => s.id === cs.studentId);
            return `<option value="${cs.id}">${student ? student.name : 'N/A'} (C√≤n ${cs.remainingSessions} bu·ªïi)</option>`;
        }).join('');
}

function saveNewMakeupRequest(event) {
    event.preventDefault();
    
    const classId = document.getElementById('newMakeupClassSelect').value;
    const classStudentId = document.getElementById('newMakeupStudentSelect').value;
    const absentDate = document.getElementById('newMakeupAbsentDate').value;
    const reason = document.getElementById('newMakeupReason').value.trim();
    
    if (!classId || !classStudentId || !absentDate) {
        showNotification('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!', 'error');
        return;
    }
    
    const cs = classStudents.find(c => c.id === classStudentId);
    if (!cs) return;
    
    // Ki·ªÉm tra ƒë√£ c√≥ y√™u c·∫ßu cho ng√†y n√†y ch∆∞a
    const existing = makeupRequests.find(m => 
        m.classStudentId === classStudentId && 
        m.originalDate === absentDate &&
        m.status !== 'completed' && m.status !== 'expired'
    );
    
    if (existing) {
        showNotification('ƒê√£ c√≥ y√™u c·∫ßu h·ªçc b√π cho ng√†y n√†y!', 'error');
        return;
    }
    
    // T√≠nh ng√†y h·∫øt h·∫°n (30 ng√†y t·ª´ ng√†y ngh·ªâ)
    const expiryDate = new Date(absentDate);
    expiryDate.setDate(expiryDate.getDate() + 30);
    
    // T·∫°o y√™u c·∫ßu h·ªçc b√π (ch∆∞a c√≥ attendanceId v√¨ ch∆∞a ƒëi·ªÉm danh)
    makeupRequests.push({
        id: generateId(),
        studentId: cs.studentId,
        classStudentId: classStudentId,
        originalAttendanceId: null, // S·∫Ω c·∫≠p nh·∫≠t khi ƒëi·ªÉm danh
        originalClassId: classId,
        originalScheduleId: null,
        originalDate: absentDate,
        requestDate: new Date().toISOString().split('T')[0],
        expiryDate: expiryDate.toISOString().split('T')[0],
        makeupClassId: null,
        makeupScheduleId: null,
        makeupDate: null,
        status: 'pending',
        approvedBy: null,
        approvedAt: null,
        completedAt: null,
        notes: reason ? `L√Ω do ngh·ªâ: ${reason}` : null,
        isPreCreated: true, // ƒê√°nh d·∫•u l√† t·∫°o tr∆∞·ªõc
        createdAt: new Date().toISOString()
    });
    
    saveData('makeupRequests', makeupRequests);
    closeModal('createMakeupModal');
    renderMakeupRequests();
    showNotification('ƒê√£ t·∫°o y√™u c·∫ßu h·ªçc b√π! Nh·ªõ ƒëi·ªÉm danh "C√≥ ph√©p" v√†o ng√†y ngh·ªâ.', 'success');
}


function renderAll() {
    // Dashboard
    renderDashboard();
    
    // Students
    renderSubjectCheckboxes();
    renderStudentsTable();
    updateStudentCounts();
    
    // Trial
    renderTrialStudentsTable();
    updateTrialCounts();
    
    // Appointments
    renderAppointmentsTable();
    
    // Registrations
    renderRegistrationsTable();
    
    // Receipts
    renderReceiptsTable();
    
    // Categories
    renderSubjectsTable();
    renderPackagesTable();
    renderPromotionsTable();
    
    // Teachers
    if (canViewTab('teachers')) {
        renderTeachersTable();
    }
    
    // Classes
    if (canViewTab('classes')) {
        renderClassesTable();
        populateClassFilters();
    }
    
    // Users
    if (canViewTab('users')) {
        renderUsersTable();
        renderPermissionMatrix();
    }
    
    // Export
    if (canViewTab('export')) {
        renderBackupHistory();
    }
    
    // Attendance
    if (canViewTab('attendance')) {
        initAttendanceTab();
    }

    // Makeup
    if (canViewTab('makeup')) {
        checkExpiredMakeupRequests();
        renderMakeupRequests();
    }

    // Update action buttons based on permissions
    updateActionButtons();
}


/* ============================================================
   üé¨ PH·∫¶N 22: APP INITIALIZATION (Kh·ªüi ch·∫°y ·ª©ng d·ª•ng)
   ============================================================ */

function initApp() {
    console.log('üöÄ Kh·ªüi ch·∫°y ·ª©ng d·ª•ng Profile 001 - V4.0');
    
    // 1. Kh·ªüi t·∫°o users m·∫∑c ƒë·ªãnh n·∫øu ch∆∞a c√≥
    initializeDefaultUsers();
    
    // 2. L∆∞u subjects m·∫∑c ƒë·ªãnh n·∫øu ch∆∞a c√≥
    if (!localStorage.getItem('subjects')) {
        saveData('subjects', subjects);
    }
    
    // 3. Ki·ªÉm tra ƒëƒÉng nh·∫≠p
    if (checkAuth()) {
        // ƒê√£ ƒëƒÉng nh·∫≠p
        showApp();
        console.log('‚úÖ ƒê√£ ƒëƒÉng nh·∫≠p:', currentUser.username);
    } else {
        // Ch∆∞a ƒëƒÉng nh·∫≠p
        hideApp();
        console.log('üîí Ch∆∞a ƒëƒÉng nh·∫≠p, hi·ªán m√†n h√¨nh Login');
    }
}

// ===== Ch·∫°y khi trang load xong =====
document.addEventListener('DOMContentLoaded', function() {
    initApp();
});

// ===== X·ª≠ l√Ω khi nh·∫•n Enter trong form login =====
document.getElementById('loginForm').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        handleLogin(e);
    }
});

// ===== ƒê√≥ng modal khi click b√™n ngo√†i =====
document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.remove('active');
        }
    });
});

// ===== Keyboard shortcuts =====
document.addEventListener('keydown', function(e) {
    // ESC ƒë·ªÉ ƒë√≥ng modal
    if (e.key === 'Escape') {
        document.querySelectorAll('.modal.active').forEach(modal => {
            modal.classList.remove('active');
        });
    }
});

console.log('üì¶ Profile 001 - Code loaded successfully!');
    </script>
</body>
</html>
